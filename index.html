<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AllaChartüê∂</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Poppins:wght@700&family=Share+Tech+Mono&display=swap"
        rel="stylesheet">

    <script src="/_vercel/speed-insights/script.js" defer></script>
    <script>
        window.va = window.va || function () { (window.va.q = window.va.q || []).push(arguments); };
    </script>
    <script src="/_vercel/insights/script.js" defer></script>

    <style>
        :root {
            --bs-body-font-family: 'Inter', sans-serif;
            /* Light Theme Colors */
            --bs-light-bg: #f8f9fa;
            --bs-light-text: #212529;
            --bs-light-primary: #6f42c1;

            /* Dark Purple Theme Colors */
            --dark-purple-bg: #16141c;
            /* Roxo bem escuro para o fundo */
            --dark-purple-surface: #201d2b;
            /* Roxo um pouco mais claro para superf√≠cies */
            --dark-purple-primary: #9f75ff;
            /* Roxo vivido para acentos */
            --dark-purple-secondary: #87868b;
            /* Cinza para texto secund√°rio */
            --dark-purple-text: #ffffff;
            /* Branco para texto principal */
            --dark-purple-border: #363247;
        }

        [data-bs-theme="light"] {
            --bs-body-bg: var(--bs-light-bg);
            --bs-body-color: var(--bs-light-text);
            --bs-primary: var(--bs-light-primary);
            --bs-primary-rgb: 111, 66, 193;
            --bs-body-tertiary-bg: #e9ecef;
            --bs-border-color: #dee2e6;
        }

        [data-bs-theme="dark"] {
            --bs-body-bg: var(--dark-purple-bg);
            --bs-body-color: var(--dark-purple-text);
            --bs-primary: var(--dark-purple-primary);
            --bs-primary-rgb: 159, 117, 255;
            --bs-body-tertiary-bg: var(--dark-purple-surface);
            --bs-tertiary-bg: var(--dark-purple-surface);
            --bs-border-color: var(--dark-purple-border);
            --bs-secondary-color: var(--dark-purple-secondary);
            --bs-primary-bg-subtle: rgba(159, 117, 255, 0.15);
            --bs-secondary-bg-subtle: rgba(135, 134, 139, 0.15);
        }

        /* --- INTRO ANIMATION --- */
        #intro-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1A1D2D;
            z-index: 10000;
            transition: opacity 0.8s ease-in-out;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #intro-animation-container {
            position: relative;
            width: clamp(300px, 60vw, 600px);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #intro-graph {
            width: 100%;
            filter: drop-shadow(0 0 10px rgba(159, 117, 255, 0.7));
        }

        #intro-graph path {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: draw 1.8s ease-in-out forwards;
            stroke: var(--dark-purple-primary);
        }

        @keyframes draw {
            to {
                stroke-dashoffset: 0;
            }
        }

        #intro-title {
            font-family: 'Poppins', sans-serif;
            font-size: clamp(2.5rem, 10vw, 5rem);
            font-weight: 700;
            color: #fff;
            margin-top: -1rem;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeIn 1s ease-out 1.5s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- MAIN APP STYLES --- */
        .app-container {
            opacity: 0;
            animation: fadeIn 0.5s ease-in forwards;
        }

        .app-container.visible {
            opacity: 1;
        }

        .navbar-brand h1 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
            margin: 0;
        }

        .navbar {
            background-color: rgba(var(--bs-body-bg-rgb), 0.8);
            backdrop-filter: blur(10px);
        }

        #sidebar {
            position: sticky;
            top: 60px;
            height: calc(100vh - 60px);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            width: 300px;
            overflow-y: auto;
            border-right: 1px solid var(--bs-border-color);
        }

        .app-row {
            display: flex;
            flex-wrap: nowrap;
        }

        #main-content {
            flex-grow: 1;
            padding: 1.5rem;
            background-color: var(--bs-body-bg);
        }

        #chart-container {
            width: 100%;
            height: 85vh;
            min-height: 600px;
            background-color: var(--bs-tertiary-bg);
            border-radius: 0.5rem;
            box-shadow: var(--bs-box-shadow-sm);
            padding: 1.5rem;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .accordion-button:not(.collapsed) {
            background-color: var(--bs-primary-bg-subtle);
            color: var(--bs-primary);
        }

        /* --- HOME / GALLERY STYLES --- */
        #home-view {
            padding: 0;
            animation: fadeIn 0.8s ease-out;
        }

        #home-banner {
            position: relative;
            padding: 4rem 2rem;
            text-align: center;
            border-bottom: 1px solid var(--bs-border-color);
            overflow: hidden;
            background: radial-gradient(ellipse at 50% -20%, rgba(var(--bs-primary-rgb), 0.2), transparent 80%);
        }

        #banner-content {
            transition: transform 0.1s ease-out;
        }

        #home-banner h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--bs-body-color);
        }

        #home-banner p {
            font-size: 1.25rem;
            color: var(--bs-secondary-color);
            margin-bottom: 2rem;
        }
        
        #home-importer-section {
            padding: 2.5rem 1.5rem;
            text-align: center;
            background-color: var(--bs-tertiary-bg);
            border-bottom: 1px solid var(--bs-border-color);
        }
        #home-importer-section h2 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
        }

        .gallery-container {
            padding: 3rem 1.5rem;
        }
        
        .gallery-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 1.5rem;
        }

        .gallery-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: 1px solid var(--bs-border-color);
            background-color: var(--bs-tertiary-bg);
            cursor: pointer;
        }

        .gallery-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 0.5rem 1.5rem rgba(var(--bs-primary-rgb), 0.1);
        }

        .gallery-card-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background-color: var(--dark-purple-bg);
        }
        
        .gallery-folder-img {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            color: var(--bs-primary);
        }

        .gallery-card .card-body {
            position: relative;
        }

        .gallery-card-icon {
            position: absolute;
            top: -25px;
            right: 15px;
            background-color: var(--bs-primary);
            color: var(--bs-body-bg);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--bs-box-shadow-sm);
            border: 2px solid var(--bs-tertiary-bg);
        }

        .site-footer {
            padding: 1.5rem;
            text-align: center;
            font-size: 0.9rem;
            color: var(--bs-secondary-color);
            border-top: 1px solid var(--bs-border-color);
            background-color: var(--bs-tertiary-bg);
        }

        /* --- Other minor tweaks --- */
        .btn-primary {
            font-weight: 500;
        }

        #notification-container {
            z-index: 1100;
        }

        .saved-item {
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem;
            border-bottom: 1px solid var(--bs-border-color);
            cursor: pointer;
        }
        .saved-item:hover {
            background-color: var(--bs-primary-bg-subtle);
        }

        .saved-item .thumbnail-container {
            width: 60px;
            height: 45px;
            margin-right: 8px;
            flex-shrink: 0;
            background-color: var(--bs-tertiary-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            font-size: 1.5rem;
            color: var(--bs-primary);
        }

        .saved-item .saved-item-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .saved-item .saved-item-name {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 8px;
            font-size: 0.8rem;
        }

        .saved-item-preview-pane {
            display: none;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: 100%;
            margin-left: 15px;
            z-index: 1200;
            border: 1px solid var(--bs-border-color);
            box-shadow: var(--bs-box-shadow-lg);
            background-color: var(--bs-tertiary-bg);
            padding: 0.5rem;
            border-radius: 0.375rem;
            pointer-events: none;
        }

        .saved-item-preview-pane img {
            max-width: 400px;
            max-height: 300px;
            display: block;
        }

        .saved-item:hover .saved-item-preview-pane {
            display: block;
        }

        #custom-context-menu {
            position: absolute;
            z-index: 10001;
            background-color: var(--bs-tertiary-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 0.375rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, .15);
            padding: 0.5rem 0;
            min-width: 150px;
        }

        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .context-menu-item:hover {
            background-color: var(--bs-primary-bg-subtle);
        }

        .context-menu-item.delete {
            color: var(--bs-danger);
        }
        
        .breadcrumb-item a {
            cursor: pointer;
            text-decoration: none;
        }
        .breadcrumb-item a:hover {
            text-decoration: underline;
        }

        #ai-chat-fab {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--bs-primary);
            color: var(--bs-body-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 1050;
            transition: transform 0.2s ease-in-out;
        }

        #ai-chat-fab:hover {
            transform: scale(1.1);
        }

        #ai-chat-modal .modal-dialog {
            position: fixed;
            right: 25px;
            bottom: 100px;
            width: 400px;
            max-width: 90vw;
            margin: 0;
            z-index: 1055;
        }

        #ai-chat-modal .modal-content {
            height: 50vh;
            max-height: 500px;
            box-shadow: var(--bs-box-shadow-lg);
        }

        #ai-chat-modal .modal-body {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #ai-chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .chat-message.user {
            background-color: var(--bs-primary-bg-subtle);
            align-self: flex-end;
            margin-left: auto;
        }

        .chat-message.ai {
            background-color: var(--bs-secondary-bg-subtle);
            align-self: flex-start;
        }

        .chat-message.tool {
            color: var(--bs-secondary-color);
            font-style: italic;
            font-size: 0.8rem;
            text-align: center;
            width: 100%;
            background-color: transparent;
        }

        #voice-command-btn.recording {
            color: var(--bs-danger);
        }

        #icon-selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 1rem;
            max-height: 40vh;
            overflow-y: auto;
        }

        .icon-option {
            font-size: 1.8rem;
            cursor: pointer;
            text-align: center;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }

        .icon-option:hover,
        .icon-option.selected {
            background-color: var(--bs-primary-bg-subtle);
            color: var(--bs-primary);
        }
    </style>
</head>

<body>
    <div id="intro-overlay">
        <div id="intro-animation-container">
            <svg id="intro-graph" viewBox="0 0 400 100" preserveAspectRatio="none">
                <path d="M 0,50 L 50,50 C 75,10, 125,90, 150,50 S 225,10, 250,50 S 325,90, 350,50 L 400,50" fill="none"
                    stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <h1 id="intro-title">AllaChartüê∂</h1>
        </div>
    </div>

    <div class="app-container">

        <nav class="navbar border-bottom sticky-top">
            <div class="container-fluid">
                <a class="navbar-brand d-flex align-items-center" href="#" id="home-link">
                    <svg class="me-2" style="width: 2rem; height: 2rem; fill: currentColor;" viewBox="0 0 100 100"
                        xmlns="http://www.w3.org/2000/svg">
                        <g>
                            <circle cx="50" cy="25" r="15" />
                            <circle cx="38" cy="40" r="12" />
                            <circle cx="62" cy="40" r="12" />
                            <path d="M 35,55 A 20,20 0 0,1 65,55 L 70,80 A 10,10 0 0,1 60,90 L 40,90 A 10,10 0 0,1 30,80 Z" />
                            <circle cx="75" cy="55" r="5" />
                        </g>
                    </svg>
                    <h1>AllaChart</h1>
                </a>
                <div>
                    <button class="btn btn-primary me-2" id="creator-link">
                        <i class="bi bi-plus-lg"></i> Criar Gr√°fico
                    </button>
                    <button class="btn border-0" id="theme-toggle" title="Alternar Tema">
                        <i class="bi bi-circle-half"></i>
                    </button>
                </div>
            </div>
        </nav>

        <div id="home-view">
            <div id="home-banner">
                <div id="banner-content">
                    <h1>Visualize. Crie. Impressione.</h1>
                    <p>Sua ferramenta definitiva para criar gr√°ficos inteligentes com facilidade.</p>
                    <button class="btn btn-primary btn-lg me-2" id="home-create-btn">Come√ßar a Criar <i
                            class="bi bi-arrow-right-short"></i></button>
                    <button class="btn btn-outline-secondary btn-lg" id="home-import-btn">Importar Dados <i
                            class="bi bi-upload"></i></button>
                </div>
            </div>
            
            <div id="home-importer-section">
                <div class="container">
                     <h2 class="mb-3">Recebeu uma pasta compartilhada?</h2>
                     <p class="text-muted mb-3">Cole o c√≥digo aqui para adicion√°-la √† sua galeria.</p>
                     <div class="row justify-content-center">
                         <div class="col-md-8 col-lg-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-folder-symlink"></i></span>
                                <input type="text" class="form-control" placeholder="Cole o c√≥digo da pasta aqui..." id="home-share-code-input">
                                <button class="btn btn-primary" type="button" id="home-apply-share-code-btn">Importar Pasta</button>
                            </div>
                         </div>
                     </div>
                </div>
            </div>
            <div class="container gallery-container">
                <div class="gallery-header">
                    <nav id="home-breadcrumb-nav" aria-label="breadcrumb"></nav>
                    <button class="btn btn-sm btn-outline-primary" id="home-new-folder-btn"><i class="bi bi-folder-plus"></i> Nova Pasta</button>
                </div>
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="chart-gallery-container">
                    </div>
            </div>
        </div>

        <div id="creator-view">
            <div class="container-fluid">
                <div class="app-row">

                    <aside id="sidebar" class="p-2">
                        <div class="accordion" id="settingsAccordion">

                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapseSavedCharts">Seus Gr√°ficos & Pastas</button></h2>
                                <div id="collapseSavedCharts" class="accordion-collapse collapse show"
                                    data-bs-parent="#settingsAccordion">
                                    <div class="accordion-body">
                                        <div class="d-flex justify-content-between gap-2 mb-2">
                                            <button id="save-chart-btn" class="btn btn-sm btn-success w-100">Salvar Gr√°fico Atual</button>
                                            <button id="sidebar-new-folder-btn" class="btn btn-sm btn-outline-primary" title="Nova Pasta"><i class="bi bi-folder-plus"></i></button>
                                        </div>
                                         <nav id="sidebar-breadcrumb-nav" aria-label="breadcrumb" class="mb-2"></nav>
                                        <div id="saved-items-list"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapseData">Editor de
                                        Dados</button></h2>
                                <div id="collapseData" class="accordion-collapse collapse"
                                    data-bs-parent="#settingsAccordion">
                                    <div class="accordion-body">
                                        <div class="d-flex justify-content-between mb-2">
                                            <button id="rename-series-btn"
                                                class="btn btn-sm btn-outline-secondary">Renomear S√©rie</button>
                                        </div>
                                        <div id="data-input-container"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapseChart">Configura√ß√µes do
                                        Gr√°fico</button></h2>
                                <div id="collapseChart" class="accordion-collapse collapse"
                                    data-bs-parent="#settingsAccordion">
                                    <div class="accordion-body">
                                        <label for="chart-title" class="form-label">T√≠tulo Principal</label><input
                                            type="text" id="chart-title" class="form-control form-control-sm mb-2">
                                        <label for="chart-type" class="form-label">Tipo de Gr√°fico</label><select
                                            id="chart-type" class="form-select form-select-sm mb-2">
                                            <option value="line">Linha</option>
                                            <option value="bar">Barras</option>
                                            <option value="pie">Pizza</option>
                                            <option value="scatter">Dispers√£o</option>
                                        </select>
                                        <div id="line-style-control-wrapper" class="mb-2"><label
                                                for="line-style-select" class="form-label">Estilo da Linha</label><select
                                                id="line-style-select" class="form-select form-select-sm">
                                                <option value="true">Arredondadas</option>
                                                <option value="false">Retas</option>
                                            </select></div>
                                        <div class="row">
                                            <div class="col"><label class="form-label">Cor da S√©rie</label><input
                                                    type="color" id="line-color"
                                                    class="form-control form-control-color w-100" value="#9f75ff">
                                            </div>
                                            <div class="col"><label class="form-label">Fundo</label><input type="color"
                                                    id="chart-bg-color" class="form-control form-control-color w-100"
                                                    value="#201d2b"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapseAxes">Eixos e
                                        Detalhes</button></h2>
                                <div id="collapseAxes" class="accordion-collapse collapse"
                                    data-bs-parent="#settingsAccordion">
                                    <div class="accordion-body">
                                        <div class="row mb-2">
                                            <div class="col"><label for="x-axis-title" class="form-label">T√≠tulo Eixo
                                                    X</label><input type="text" id="x-axis-title"
                                                    class="form-control form-control-sm"></div>
                                            <div class="col"><label for="y-axis-title" class="form-label">T√≠tulo Eixo
                                                    Y</label><input type="text" id="y-axis-title"
                                                    class="form-control form-control-sm"></div>
                                        </div>
                                        <label class="form-label">Faixa de Valores do Eixo Y</label>
                                        <div class="input-group input-group-sm mb-2">
                                            <input type="number" id="y-axis-min" class="form-control"
                                                placeholder="M√≠nimo">
                                            <input type="number" id="y-axis-max" class="form-control"
                                                placeholder="M√°ximo">
                                            <button class="btn btn-outline-secondary" type="button"
                                                id="y-axis-range-reset-btn">Reset</button>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col"><label class="form-label">Linhas Verticais
                                                    (X)</label><select id="x-grid-lines"
                                                    class="form-select form-select-sm">
                                                    <option>Auto</option>
                                                    <option>1</option>
                                                    <option>2</option>
                                                    <option>3</option>
                                                    <option>4</option>
                                                    <option>5</option>
                                                    <option>10</option>
                                                </select></div>
                                            <div class="col"><label class="form-label">Linhas Horizontais
                                                    (Y)</label><select id="y-grid-lines"
                                                    class="form-select form-select-sm">
                                                    <option>Auto</option>
                                                    <option>1</option>
                                                    <option>2</option>
                                                    <option>3</option>
                                                    <option>4</option>
                                                    <option>5</option>
                                                    <option>10</option>
                                                </select></div>
                                        </div>
                                        <label for="grid-style" class="form-label">Estilo da Grade</label><select
                                            id="grid-style" class="form-select form-select-sm mb-2">
                                            <option value="dotted">Pontilhada</option>
                                            <option value="dashed">Tracejada</option>
                                            <option value="solid">S√≥lida</option>
                                            <option value="none">Nenhuma</option>
                                        </select>
                                        <div class="row">
                                            <div class="col"><label class="form-label">Tam. Fonte
                                                    T√≠tulos</label><input type="number" id="title-font-size"
                                                    class="form-control form-control-sm" min="10" value="14"></div>
                                            <div class="col"><label class="form-label">Cor Fonte
                                                    T√≠tulos</label><input type="color" id="title-color"
                                                    class="form-control form-control-color w-100" value="#ffffff">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseHelp">
                                        üê∂ Assistente Alla
                                    </button>
                                </h2>
                                <div id="collapseHelp" class="accordion-collapse collapse"
                                    data-bs-parent="#settingsAccordion">
                                    <div class="accordion-body text-center">
                                        <p class="small text-muted">Precisa de ajuda ou quer criar um gr√°fico com
                                            comandos? Clique no bot√£o de chat para falar com o Alla!</p>
                                        <button class="btn btn-primary" id="open-chat-from-sidebar">Abrir Chat</button>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapseFile">Arquivo</button></h2>
                                <div id="collapseFile" class="accordion-collapse collapse"
                                    data-bs-parent="#settingsAccordion">
                                    <div class="accordion-body">
                                        <div class="d-grid gap-2">
                                            <button id="import-btn" class="btn btn-outline-secondary">Importar
                                                Planilha</button>
                                            <button id="export-excel" class="btn btn-primary">Exportar para
                                                Excel</button>
                                            <button id="export-pdf-btn" class="btn btn-danger">Exportar para
                                                PDF</button>
                                            <hr>
                                            <button id="copy-share-code-btn"
                                                class="btn btn-sm btn-outline-info">Copiar C√≥digo do Gr√°fico</button>
                                            <button id="apply-share-code-btn" class="btn btn-sm btn-info">Aplicar
                                                C√≥digo (Gr√°fico/Pasta)</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid mt-3 p-2">
                            <button id="reset-to-default-btn" class="btn btn-warning">Reiniciar para o Padr√£o</button>
                        </div>
                    </aside>

                    <main id="main-content">
                        <div id="chart-container"></div>
                    </main>
                </div>
            </div>
        </div>

    </div>

    <footer class="site-footer">
        Criado com üíú por Luiza Santos Marialva
    </footer>

    <div id="notification-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <div class="modal fade" id="genericModal" tabindex="-1" aria-labelledby="genericModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="genericModalLabel">T√≠tulo do Modal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="genericModalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="genericModalConfirmBtn">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="themeChoiceModal" tabindex="-1" aria-labelledby="themeChoiceModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="themeChoiceModalLabel">Escolha o Estilo do Novo Gr√°fico</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="mb-4">Qual tema voc√™ prefere para o seu novo gr√°fico padr√£o?</p>
                    <div class="d-grid gap-3">
                        <button type="button" class="btn btn-lg btn-light" id="choice-light-theme-btn">
                            <i class="bi bi-sun-fill"></i> Gr√°fico Light
                        </button>
                        <button type="button" class="btn btn-lg btn-dark" id="choice-dark-theme-btn">
                            <i class="bi bi-moon-stars-fill"></i> Gr√°fico Dark
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="icon-selector-modal" tabindex="-1" aria-labelledby="iconSelectorModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="iconSelectorModalLabel">Escolha um √çcone para o seu Gr√°fico</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="icon-selector-grid"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Pular</button>
                    <button type="button" class="btn btn-primary" id="icon-selector-confirm-btn">Confirmar
                        √çcone</button>
                </div>
            </div>
        </div>
    </div>

    <div id="ai-chat-fab" title="Falar com Alla">üê∂</div>

    <div class="modal fade" id="ai-chat-modal" tabindex="-1" aria-labelledby="aiChatModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aiChatModalLabel">Falar com Alla üê∂</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="ai-chat-messages"></div>
                    <div id="ai-typing-indicator" class="mt-2" style="display: none;">
                        <div class="chat-message ai typing-indicator">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="input-group">
                        <input type="text" id="ai-chat-input" class="form-control" placeholder="Pe√ßa um comando..."
                            aria-label="Sua mensagem">
                        <button class="btn btn-outline-secondary" type="button" id="voice-command-btn"
                            title="Comando por Voz"><i class="bi bi-mic-fill"></i></button>
                        <button class="btn btn-primary" type="button" id="ai-chat-send-btn">Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const introOverlay = document.getElementById('intro-overlay');
            const appContainer = document.querySelector('.app-container');

            const path = document.querySelector('#intro-graph path');
            const pathLength = path.getTotalLength();
            path.style.strokeDasharray = pathLength;
            path.style.strokeDashoffset = pathLength;

            setTimeout(() => {
                introOverlay.style.opacity = '0';
                appContainer.classList.add('visible');
                introOverlay.addEventListener('transitionend', () => introOverlay.style.display = 'none');
            }, 2800);

            const APP = {
                state: {
                    chart: null,
                    data: {},
                    theme: 'light',
                    modal: null,
                    aiChatModal: null,
                    iconSelectorModal: null,
                    themeChoiceModal: null,
                    currentView: 'home',
                    currentPath: ['root'], // Breadcrumb path, ['root', 'folderId1', ...]
                    fileSystem: { 'root': { type: 'folder', id: 'root', name: 'In√≠cio', items: [] } }
                },
                dom: {
                    html: document.documentElement,
                    chartContainer: document.getElementById('chart-container'),
                    notificationContainer: document.getElementById('notification-container'),
                    homeView: document.getElementById('home-view'),
                    creatorView: document.getElementById('creator-view'),
                    chartGalleryContainer: document.getElementById('chart-gallery-container'),
                    homeBreadcrumbNav: document.getElementById('home-breadcrumb-nav'),
                    sidebarBreadcrumbNav: document.getElementById('sidebar-breadcrumb-nav'),
                    homeBanner: document.getElementById('home-banner'),
                    bannerContent: document.getElementById('banner-content'),
                    homeShareCodeInput: document.getElementById('home-share-code-input'),
                    homeApplyShareCodeBtn: document.getElementById('home-apply-share-code-btn'),
                    modal: {
                        el: document.getElementById('genericModal'),
                        title: document.getElementById('genericModalLabel'),
                        body: document.getElementById('genericModalBody'),
                        confirmBtn: document.getElementById('genericModalConfirmBtn')
                    },
                    themeChoiceModal: {
                        el: document.getElementById('themeChoiceModal'),
                        lightBtn: document.getElementById('choice-light-theme-btn'),
                        darkBtn: document.getElementById('choice-dark-theme-btn'),
                    },
                    iconModal: {
                        el: document.getElementById('icon-selector-modal'),
                        grid: document.getElementById('icon-selector-grid'),
                        confirmBtn: document.getElementById('icon-selector-confirm-btn'),
                    },
                    nav: {
                        homeLink: document.getElementById('home-link'),
                        creatorLink: document.getElementById('creator-link'),
                    },
                    controls: {
                        importBtn: document.getElementById('import-btn'),
                        homeCreateBtn: document.getElementById('home-create-btn'),
                        homeImportBtn: document.getElementById('home-import-btn'),
                        homeNewFolderBtn: document.getElementById('home-new-folder-btn'),
                        sidebarNewFolderBtn: document.getElementById('sidebar-new-folder-btn'),
                        chartType: document.getElementById('chart-type'),
                        chartTitle: document.getElementById('chart-title'),
                        titleFontSize: document.getElementById('title-font-size'),
                        titleColor: document.getElementById('title-color'),
                        xAxisTitle: document.getElementById('x-axis-title'),
                        yAxisTitle: document.getElementById('y-axis-title'),
                        lineColor: document.getElementById('line-color'),
                        gridStyle: document.getElementById('grid-style'),
                        chartBgColor: document.getElementById('chart-bg-color'),
                        xGridLines: document.getElementById('x-grid-lines'),
                        yGridLines: document.getElementById('y-grid-lines'),
                        yAxisMin: document.getElementById('y-axis-min'),
                        yAxisMax: document.getElementById('y-axis-max'),
                        yAxisRangeResetBtn: document.getElementById('y-axis-range-reset-btn'),
                        lineStyleSelect: document.getElementById('line-style-select'),
                        exportExcelBtn: document.getElementById('export-excel'),
                        exportPdfBtn: document.getElementById('export-pdf-btn'),
                        themeToggle: document.getElementById('theme-toggle'),
                        dataInputContainer: document.getElementById('data-input-container'),
                        renameSeriesBtn: document.getElementById('rename-series-btn'),
                        copyShareCodeBtn: document.getElementById('copy-share-code-btn'),
                        applyShareCodeBtn: document.getElementById('apply-share-code-btn'),
                        saveChartBtn: document.getElementById('save-chart-btn'),
                        savedItemsList: document.getElementById('saved-items-list'),
                        resetToDefaultBtn: document.getElementById('reset-to-default-btn'),
                        aiChatFab: document.getElementById('ai-chat-fab'),
                        aiChatModal: document.getElementById('ai-chat-modal'),
                        aiChatMessages: document.getElementById('ai-chat-messages'),
                        aiChatInput: document.getElementById('ai-chat-input'),
                        aiChatSendBtn: document.getElementById('ai-chat-send-btn'),
                        aiTypingIndicator: document.getElementById('ai-typing-indicator'),
                        openChatFromSidebar: document.getElementById('open-chat-from-sidebar'),
                        voiceCommandBtn: document.getElementById('voice-command-btn'),
                    }
                },
                methods: {
                    init() {
                        this.loadState(); // Loads files and app state
                        APP.state.chart = echarts.init(APP.dom.chartContainer);
                        APP.state.modal = new bootstrap.Modal(APP.dom.modal.el);
                        APP.state.aiChatModal = new bootstrap.Modal(APP.dom.controls.aiChatModal);
                        APP.state.iconSelectorModal = new bootstrap.Modal(APP.dom.iconModal.el);
                        APP.state.themeChoiceModal = new bootstrap.Modal(APP.dom.themeChoiceModal.el);

                        this.bindEventListeners();
                        this.navigateTo(APP.state.currentView, false); // Dont save state on init load
                        this.rebuildUI(false);
                        this.renderAllViews();
                        this.populateIconSelector();
                        this.toggleLineStyleControl();
                        this.AI_ASSISTANT.init();
                        this.initBannerAnimation();
                    },
                    initBannerAnimation() {
                        const banner = APP.dom.homeBanner;
                        const content = APP.dom.bannerContent;
                        if (!banner || !content) return;

                        banner.addEventListener('mousemove', (e) => {
                            const { width, height, left, top } = banner.getBoundingClientRect();
                            const x = e.clientX - left;
                            const y = e.clientY - top;

                            const rotateX = (y / height - 0.5) * -15;
                            const rotateY = (x / width - 0.5) * 15;

                            content.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1, 1, 1)`;
                        });

                        banner.addEventListener('mouseleave', () => {
                            content.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)';
                        });
                    },
                    navigateTo(viewName, save = true) {
                        APP.state.currentView = viewName;
                        APP.dom.homeView.style.display = 'none';
                        APP.dom.creatorView.style.display = 'none';

                        if (viewName === 'home') {
                            APP.dom.homeView.style.display = 'block';
                            this.renderAllViews();
                        } else {
                            APP.dom.creatorView.style.display = 'block';
                            setTimeout(() => {
                                if (APP.state.chart) APP.state.chart.resize()
                            }, 10);
                        }
                        if (save) this.saveState();
                    },
                    updateSettings(save = true) {
                        this.updateChart();
                        if (save) this.saveState();
                    },
                    rebuildUI(save = true) {
                        this.renderDataEditorForm();
                        this.updateChart();
                        if (save) this.saveState();
                    },
                    bindEventListeners() {
                        // Bind all simple controls
                        for (const key in APP.dom.controls) {
                            const control = APP.dom.controls[key];
                            if (control && !control.id.includes('Btn') && !control.id.includes('Link') && !control.id.startsWith('ai-chat')) {
                                const eventType = (control.type === 'color' || control.type === 'number' || control.tagName === 'SELECT') ? 'change' : 'input';
                                control.addEventListener(eventType, () => this.updateSettings());
                            }
                        }

                        APP.dom.nav.homeLink.addEventListener('click', (e) => { e.preventDefault(); this.navigateTo('home'); });
                        APP.dom.nav.creatorLink.addEventListener('click', (e) => { e.preventDefault(); this.navigateTo('creator'); });
                        APP.dom.controls.homeCreateBtn.addEventListener('click', (e) => { e.preventDefault(); this.navigateTo('creator'); });
                        APP.dom.controls.homeImportBtn.addEventListener('click', () => APP.dom.controls.importBtn.click());
                        APP.dom.controls.homeNewFolderBtn.addEventListener('click', () => this.createNewFolder());
                        APP.dom.controls.sidebarNewFolderBtn.addEventListener('click', () => this.createNewFolder());
                        APP.dom.homeApplyShareCodeBtn.addEventListener('click', () => {
                           const code = APP.dom.homeShareCodeInput.value.trim();
                           if(code) {
                               this.processShareCode(code, 'folder'); // Force folder type check
                               APP.dom.homeShareCodeInput.value = '';
                           } else {
                               this.showNotification('Por favor, insira um c√≥digo de compartilhamento.', 'warning');
                           }
                        });


                        APP.state.chart.on('click', this.handleChartClick.bind(this));

                        APP.dom.themeChoiceModal.lightBtn.addEventListener('click', () => this.performReset('light'));
                        APP.dom.themeChoiceModal.darkBtn.addEventListener('click', () => this.performReset('dark'));

                        APP.dom.controls.yAxisRangeResetBtn.addEventListener('click', () => {
                            APP.dom.controls.yAxisMin.value = '';
                            APP.dom.controls.yAxisMax.value = '';
                            this.updateSettings();
                        });
                        APP.dom.controls.chartType.addEventListener('change', () => this.toggleLineStyleControl());
                        APP.dom.controls.themeToggle.addEventListener('click', () => this.toggleTheme());
                        APP.dom.controls.importBtn.addEventListener('click', () => {
                            const u = document.createElement('input');
                            u.type = 'file';
                            u.accept = '.xlsx,.csv';
                            u.onchange = (e) => this.handleFileUpload(e);
                            u.click();
                        });
                        APP.dom.controls.exportExcelBtn.addEventListener('click', () => this.exportToExcel());
                        APP.dom.controls.exportPdfBtn.addEventListener('click', () => this.exportToPdf());
                        APP.dom.controls.renameSeriesBtn.addEventListener('click', () => this.renameSeries());
                        APP.dom.controls.copyShareCodeBtn.addEventListener('click', () => this.copyShareCodeForChart());
                        APP.dom.controls.applyShareCodeBtn.addEventListener('click', () => this.applyShareCodeFromModal());
                        APP.dom.controls.saveChartBtn.addEventListener('click', () => this.saveCurrentChart());
                        APP.dom.controls.resetToDefaultBtn.addEventListener('click', () => this.resetToDefault());

                        window.addEventListener('click', () => this.hideContextMenu());
                        window.addEventListener('resize', () => {
                            if (APP.state.chart) {
                                APP.state.chart.resize();
                            }
                        });
                    },
                    handleChartClick(params) {
                        const c = APP.dom.controls;
                        switch (params.componentType) {
                            case 'title':
                                this.showModal('Editar T√≠tulo Principal', { type: 'input', value: c.chartTitle.value }, (newTitle) => {
                                    if (newTitle !== null) {
                                        c.chartTitle.value = newTitle;
                                        this.updateSettings();
                                    }
                                });
                                break;
                            case 'xAxis':
                                this.showModal('Editar T√≠tulo do Eixo X', { type: 'input', value: c.xAxisTitle.value }, (newTitle) => {
                                    if (newTitle !== null) {
                                        c.xAxisTitle.value = newTitle;
                                        this.updateSettings();
                                    }
                                });
                                break;
                            case 'yAxis':
                                this.showModal('Editar T√≠tulo do Eixo Y', { type: 'input', value: c.yAxisTitle.value }, (newTitle) => {
                                    if (newTitle !== null) {
                                        c.yAxisTitle.value = newTitle;
                                        this.updateSettings();
                                    }
                                });
                                break;
                            case 'series':
                                const isPie = c.chartType.value === 'pie';
                                if (!isPie) {
                                    this.showModal(`Editar S√©rie`, `Voc√™ clicou na s√©rie "${params.seriesName}". O que deseja fazer?`, (choice) => {
                                        if (choice === 'color') {
                                            c.lineColor.click();
                                        } else {
                                            this.editDataPoint(params);
                                        }
                                    }, {
                                        cancelText: 'Editar Ponto',
                                        confirmText: 'Mudar Cor',
                                        confirmAction: 'color',
                                        cancelAction: 'value'
                                    });
                                } else {
                                    this.editDataPoint(params);
                                }
                                break;
                        }
                    },
                    editDataPoint(params) {
                        const currentLabel = APP.state.data.labels[params.dataIndex];
                        const currentValue = APP.state.data.values[params.dataIndex];
                        this.showModal(`Editar valor para "${currentLabel}"`, { type: 'input', inputType: 'number', value: currentValue }, (newValueStr) => {
                            if (newValueStr !== null) {
                                const newValue = parseFloat(newValueStr);
                                if (!isNaN(newValue)) {
                                    APP.state.data.values[params.dataIndex] = newValue;
                                    this.rebuildUI();
                                    this.showNotification(`Valor para "${currentLabel}" atualizado para ${newValue}.`, 'success');
                                } else {
                                    this.showNotification('Valor inv√°lido. Por favor, insira um n√∫mero.', 'danger');
                                }
                            }
                        });
                    },
                    renderDataEditorForm() {
                        const container = APP.dom.controls.dataInputContainer;
                        container.innerHTML = '';
                        if (!APP.state.data || !APP.state.data.values) return;
                        APP.state.data.values.forEach((value, index) => {
                            const row = document.createElement('div');
                            row.className = 'data-input-row';
                            row.addEventListener('contextmenu', (e) => {
                                e.preventDefault();
                                this.showContextMenu(e.clientX, e.clientY, { type: 'dataPoint', index: index });
                            });
                            const controls = document.createElement('div');
                            controls.className = 'year-controls';
                            const addBeforeBtn = document.createElement('button');
                            addBeforeBtn.textContent = '+';
                            addBeforeBtn.className = 'btn btn-sm btn-outline-info add-year-btn';
                            addBeforeBtn.title = 'Adicionar ano anterior';
                            addBeforeBtn.onclick = (e) => {
                                e.stopPropagation();
                                this.addYear(index, true);
                            };
                            const addAfterBtn = document.createElement('button');
                            addAfterBtn.textContent = '+';
                            addAfterBtn.className = 'btn btn-sm btn-outline-info add-year-btn mt-1';
                            addAfterBtn.title = 'Adicionar ano seguinte';
                            addAfterBtn.onclick = (e) => {
                                e.stopPropagation();
                                this.addYear(index, false);
                            };
                            controls.appendChild(addBeforeBtn);
                            controls.appendChild(addAfterBtn);
                            const label = document.createElement('label');
                            label.textContent = APP.state.data.labels[index] || `Ponto ${index + 1}`;
                            label.className = 'form-label mb-0';
                            const input = document.createElement('input');
                            input.type = 'number';
                            input.value = value;
                            input.className = 'form-control form-control-sm';
                            const commitChange = () => {
                                const newValue = parseFloat(input.value);
                                if (!isNaN(newValue)) {
                                    if (APP.state.data.values[index] !== newValue) {
                                        APP.state.data.values[index] = newValue;
                                        this.updateChart();
                                        this.saveState();
                                    }
                                } else {
                                    input.value = APP.state.data.values[index];
                                }
                            };
                            input.addEventListener('blur', commitChange);
                            input.addEventListener('keydown', (e) => {
                                if (e.key === 'Enter' || e.key === 'Tab') {
                                    e.preventDefault();
                                    input.blur();
                                }
                            });
                            row.appendChild(controls);
                            row.appendChild(label);
                            row.appendChild(input);
                            container.appendChild(row);
                        });
                    },
                    addYear(index, before) {
                        const labels = APP.state.data.labels;
                        const values = APP.state.data.values;
                        const referenceYear = parseInt(labels[index], 10);
                        if (isNaN(referenceYear)) {
                            this.showNotification("N√£o √© poss√≠vel adicionar ano a partir de um r√≥tulo de texto.", "warning");
                            return;
                        }
                        const newYear = before ? referenceYear - 1 : referenceYear + 1;
                        const insertIndex = before ? index : index + 1;
                        labels.splice(insertIndex, 0, String(newYear));
                        values.splice(insertIndex, 0, 0);
                        this.rebuildUI();
                    },
                    deleteDataPoint(index) {
                        const label = APP.state.data.labels[index];
                        this.showModal('Confirmar Exclus√£o', `Tem certeza que deseja excluir o item "${label}"?`, (confirmed) => {
                            if (confirmed) {
                                APP.state.data.labels.splice(index, 1);
                                APP.state.data.values.splice(index, 1);
                                this.rebuildUI();
                                this.showNotification("Item de dado exclu√≠do.", "info");
                            }
                        }, {
                            confirmClass: 'btn-danger',
                            confirmText: 'Excluir'
                        });
                    },
                    showContextMenu(x, y, item) {
                        this.hideContextMenu();
                        const menu = document.createElement('div');
                        menu.id = 'custom-context-menu';
                        menu.style.top = `${y}px`;
                        menu.style.left = `${x}px`;
                        
                        // Add menu items based on item type
                        if (item.type === 'dataPoint') {
                             menu.innerHTML = `<div class="context-menu-item delete"><i class="bi bi-trash"></i><span>Excluir Ponto</span></div>`;
                             menu.querySelector('.delete').onclick = () => this.deleteDataPoint(item.index);
                        } else if (item.type === 'chart' || item.type === 'folder') {
                            menu.innerHTML = `
                                <div class="context-menu-item" id="ctx-rename"><i class="bi bi-pencil-square"></i><span>Renomear</span></div>
                                <div class="context-menu-item" id="ctx-move"><i class="bi bi-folder-symlink"></i><span>Mover</span></div>
                                <div class="context-menu-item" id="ctx-share"><i class="bi bi-share"></i><span>Compartilhar</span></div>
                                <div class="context-menu-item delete" id="ctx-delete"><i class="bi bi-trash"></i><span>Excluir</span></div>
                            `;
                            menu.querySelector('#ctx-rename').onclick = () => this.renameItem(item.id);
                            menu.querySelector('#ctx-move').onclick = () => this.moveItem(item.id);
                            menu.querySelector('#ctx-share').onclick = () => this.copyShareCodeForItem(item.id);
                            menu.querySelector('#ctx-delete').onclick = () => this.deleteItem(item.id);
                        }

                        document.body.appendChild(menu);
                    },
                    hideContextMenu() {
                        const menu = document.getElementById('custom-context-menu');
                        if (menu) {
                            menu.remove();
                        }
                    },
                    renameSeries() {
                        const currentName = APP.state.data.name;
                        this.showModal('Renomear S√©rie', {
                            type: 'input',
                            value: currentName
                        }, (newName) => {
                            if (newName && newName !== currentName) {
                                APP.state.data.name = newName;
                                this.updateSettings();
                            }
                        });
                    },
                    generateRandomData(theme = 'light') {
                        const pointCount = 7,
                            startYear = new Date().getFullYear() - pointCount;
                        const labels = Array.from({
                            length: pointCount
                        }, (_, i) => (startYear + i + 1).toString());
                        const values = Array.from({
                            length: pointCount
                        }, () => Math.floor(Math.random() * 250) + 150);
                        APP.state.data = {
                            name: 'Total de Servidores',
                            labels,
                            values
                        };
                        const c = APP.dom.controls;
                        c.chartTitle.value = 'Evolu√ß√£o Anual de Servidores';
                        c.xAxisTitle.value = 'Ano';
                        c.yAxisTitle.value = 'Total de Servidores';

                        if (theme === 'dark') {
                            c.titleColor.value = '#ffffff';
                            c.lineColor.value = '#9f75ff';
                            c.chartBgColor.value = '#201d2b';
                        } else {
                            c.titleColor.value = '#343a40';
                            c.lineColor.value = '#6f42c1';
                            c.chartBgColor.value = '#ffffff';
                        }

                        c.titleFontSize.value = 14;
                        c.gridStyle.value = 'dotted';
                        c.lineStyleSelect.value = 'true';
                        c.chartType.value = 'line';
                        c.xGridLines.value = 'Auto';
                        c.yGridLines.value = 'Auto';
                        c.yAxisMin.value = '';
                        c.yAxisMax.value = '';
                    },
                    getChartOptions() {
                        const c = APP.dom.controls,
                            isDark = APP.state.theme === 'dark';
                        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                        const textColor = isDark ? 'var(--dark-purple-secondary)' : '#666';
                        const titleColor = c.titleColor.value;
                        const gridStyleValue = c.gridStyle.value;
                        const showGrid = gridStyleValue !== 'none';
                        const getLineType = (style) => {
                            switch (style) {
                                case 'dotted': return [2, 5];
                                case 'dashed': return [7, 7];
                                case 'solid': return 'solid';
                                default: return 'solid';
                            }
                        };
                        const lineType = getLineType(gridStyleValue);
                        let yAxisSplit = {
                            show: showGrid,
                            lineStyle: { type: lineType, color: gridColor }
                        };
                        if (c.yGridLines.value !== 'Auto') yAxisSplit.splitNumber = parseInt(c.yGridLines.value, 10);
                        let xAxisSplit = {
                            show: showGrid,
                            lineStyle: { type: lineType, color: gridColor }
                        };
                        if (c.xGridLines.value !== 'Auto') xAxisSplit.splitNumber = parseInt(c.xGridLines.value, 10);
                        APP.dom.chartContainer.style.backgroundColor = c.chartBgColor.value;
                        const chartType = c.chartType.value;
                        let series = [];
                        const isSmooth = c.lineStyleSelect.value === 'true';
                        const titleFontSize = parseInt(c.titleFontSize.value, 10);
                        if (chartType === 'pie') {
                            series.push({
                                name: APP.state.data.name,
                                type: 'pie',
                                radius: '60%',
                                center: ['50%', '55%'],
                                data: APP.state.data.labels.map((l, i) => ({
                                    value: APP.state.data.values[i],
                                    name: l
                                })),
                                itemStyle: {
                                    color: c.lineColor.value,
                                    borderRadius: 5,
                                    borderColor: c.chartBgColor.value,
                                    borderWidth: 2,
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowOffsetY: 5,
                                    shadowColor: 'rgba(0, 0, 0, 0.1)'
                                },
                                label: { show: true, color: textColor }
                            });
                        } else {
                            series.push({
                                name: APP.state.data.name,
                                type: chartType,
                                data: APP.state.data.values,
                                smooth: isSmooth,
                                symbolSize: 8,
                                lineStyle: {
                                    color: c.lineColor.value,
                                    width: 3,
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowOffsetY: 5,
                                    shadowColor: 'rgba(0, 0, 0, 0.2)'
                                },
                                itemStyle: { color: c.lineColor.value },
                                label: {
                                    show: chartType === 'line' || chartType === 'bar',
                                    position: 'top',
                                    color: titleColor,
                                    fontWeight: 'bold'
                                }
                            });
                        }
                        const yMin = parseFloat(c.yAxisMin.value);
                        const yMax = parseFloat(c.yAxisMax.value);
                        return {
                            backgroundColor: 'transparent',
                            title: {
                                text: c.chartTitle.value,
                                left: 'center',
                                textStyle: {
                                    color: titleColor,
                                    fontSize: titleFontSize + 4,
                                    fontWeight: 'bold'
                                }
                            },
                            tooltip: { trigger: 'axis' },
                            grid: { left: '8%', right: '4%', top: '15%', bottom: '12%', containLabel: true },
                            toolbox: {
                                feature: {
                                    dataView: { readOnly: false, iconStyle: { borderColor: textColor }, textareaColor: '#fff', textareaBorderColor: '#333', textColor: '#fff', backgroundColor: '#222', },
                                    magicType: { type: ['line', 'bar'], iconStyle: { borderColor: textColor } },
                                    restore: { iconStyle: { borderColor: textColor } },
                                    saveAsImage: { backgroundColor: c.chartBgColor.value, iconStyle: { borderColor: textColor } }
                                }
                            },
                            xAxis: {
                                type: 'category',
                                data: APP.state.data.labels,
                                name: c.xAxisTitle.value,
                                nameLocation: 'middle',
                                nameGap: 35,
                                nameTextStyle: { color: titleColor, fontSize: titleFontSize, fontWeight: 'bold' },
                                splitLine: xAxisSplit,
                                axisLine: { lineStyle: { color: gridColor } },
                                axisLabel: { color: textColor }
                            },
                            yAxis: {
                                type: 'value',
                                name: c.yAxisTitle.value,
                                nameLocation: 'middle',
                                nameGap: 55,
                                nameTextStyle: { color: titleColor, fontSize: titleFontSize, fontWeight: 'bold' },
                                min: isNaN(yMin) ? null : yMin,
                                max: isNaN(yMax) ? null : yMax,
                                splitLine: yAxisSplit,
                                axisLine: { lineStyle: { color: gridColor } },
                                axisLabel: { color: textColor }
                            },
                            series
                        };
                    },
                    updateChart() {
                        if (APP.state.chart) APP.state.chart.setOption(this.getChartOptions(), true);
                    },
                    toggleTheme() {
                        APP.state.theme = APP.state.theme === 'light' ? 'dark' : 'light';
                        APP.dom.html.setAttribute('data-bs-theme', APP.state.theme);
                        this.updateSettings();
                    },
                    toggleLineStyleControl() {
                        const wrapper = document.getElementById('line-style-control-wrapper');
                        if (wrapper) {
                            wrapper.style.display = APP.dom.controls.chartType.value === 'line' ? 'block' : 'none';
                        }
                    },
                    showNotification(message, type = 'primary') {
                        const toastHTML = `<div class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true"><div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div></div>`;
                        APP.dom.notificationContainer.insertAdjacentHTML('beforeend', toastHTML);
                        new bootstrap.Toast(APP.dom.notificationContainer.lastElementChild).show();
                    },
                    saveState() {
                        try {
                            const s = {
                                data: APP.state.data,
                                theme: APP.state.theme,
                                currentView: APP.state.currentView,
                                currentPath: APP.state.currentPath,
                                fileSystem: APP.state.fileSystem,
                                controls: {}
                            };
                            for (const k in APP.dom.controls) {
                                const e = APP.dom.controls[k];
                                if (e && e.id && typeof e.value !== 'undefined' && e.type !== 'file' && !e.id.startsWith('home-') && !e.id.startsWith('sidebar-')) {
                                    s.controls[k] = e.value;
                                }
                            }
                            localStorage.setItem('alladinAppState', JSON.stringify(s));
                        } catch (e) {
                            console.warn("Could not save state.", e);
                        }
                    },
                    loadState() {
                        try {
                            const s = JSON.parse(localStorage.getItem('alladinAppState'));
                            if (s) {
                                // MIGRATION from old version
                                if (localStorage.getItem('alladinSavedCharts')) {
                                     const oldCharts = JSON.parse(localStorage.getItem('alladinSavedCharts'));
                                     s.fileSystem = { 'root': { type: 'folder', id: 'root', name: 'In√≠cio', items: oldCharts } };
                                     localStorage.removeItem('alladinSavedCharts');
                                     this.showNotification("Seus gr√°ficos foram migrados para o novo sistema de pastas!", "info");
                                }
                                
                                APP.state.fileSystem = s.fileSystem || { 'root': { type: 'folder', id: 'root', name: 'In√≠cio', items: [] } };
                                if (s.data && s.data.values) APP.state.data = s.data;
                                APP.state.theme = s.theme || 'light';
                                APP.state.currentView = s.currentView || 'home';
                                APP.state.currentPath = s.currentPath || ['root'];
                                APP.dom.html.setAttribute('data-bs-theme', APP.state.theme);
                                if (s.controls) {
                                    for (const k in s.controls) {
                                        if (APP.dom.controls[k] && s.controls[k] !== undefined) APP.dom.controls[k].value = s.controls[k];
                                    }
                                }
                                this.showNotification("Sess√£o anterior restaurada!");
                            } else {
                                this.generateRandomData('light');
                            }
                        } catch (e) {
                            this.generateRandomData('light');
                        }
                    },
                    handleFileUpload(e) {
                        const f = e.target.files[0];
                        if (!f) return;
                        const r = new FileReader();
                        r.onload = (event) => {
                            try {
                                const wb = XLSX.read(new Uint8Array(event.target.result), { type: 'array' });
                                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                                if (json.length < 2) return this.showNotification('Planilha vazia ou inv√°lida.', 'danger');
                                const h = json[0], body = json.slice(1);
                                APP.state.data = {
                                    name: h[1] || 'S√©rie Importada',
                                    labels: body.map(row => String(row[0])),
                                    values: body.map(row => parseFloat(row[1]) || 0)
                                };
                                this.rebuildUI();
                                this.navigateTo('creator');
                                this.showNotification('Dados importados com sucesso!', 'success');
                            } catch (err) {
                                this.showNotification('Erro ao ler a planilha.', 'danger');
                            }
                        };
                        r.readAsArrayBuffer(f);
                    },
                    async exportToExcel() {
                        const wb = new ExcelJS.Workbook(), ws = wb.addWorksheet('Relat√≥rio');
                        const img = APP.state.chart.getDataURL({ type: 'png', pixelRatio: 3, backgroundColor: APP.dom.controls.chartBgColor.value });
                        const imgId = wb.addImage({ base64: img, extension: 'png' });
                        ws.addImage(imgId, 'A1:J20');
                        const startRow = 22, data = APP.state.data;
                        ws.getCell(startRow, 1).value = "Ano";
                        ws.getCell(startRow, 2).value = data.name;
                        [1, 2].forEach(i => ws.getCell(startRow, i).font = { bold: true, size: 12 });
                        data.labels.forEach((l, i) => {
                            ws.getCell(startRow + 1 + i, 1).value = isNaN(l) ? l : Number(l);
                            ws.getCell(startRow + 1 + i, 2).value = data.values[i];
                        });
                        ws.getColumn(1).width = 20;
                        ws.getColumn(2).width = 20;
                        const buffer = await wb.xlsx.writeBuffer();
                        const title = APP.dom.controls.chartTitle.value.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                        saveAs(new Blob([buffer]), `Relatorio_AllaChart_${title}.xlsx`);
                    },
                    exportToPdf() {
                        this.showNotification('Gerando PDF de alta qualidade...', 'info');
                        try {
                            const chartImg = APP.state.chart.getDataURL({ type: 'png', pixelRatio: 3, backgroundColor: APP.dom.controls.chartBgColor.value });
                            const chartWidth = APP.state.chart.getWidth();
                            const chartHeight = APP.state.chart.getHeight();
                            const orientation = chartWidth > chartHeight ? 'l' : 'p';
                            const pdf = new window.jspdf.jsPDF({ orientation: orientation, unit: 'px', format: [chartWidth, chartHeight] });
                            pdf.addImage(chartImg, 'PNG', 0, 0, chartWidth, chartHeight);
                            const title = APP.dom.controls.chartTitle.value.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'grafico';
                            pdf.save(`Relatorio_AllaChart_${title}.pdf`);
                        } catch (error) {
                            console.error("Erro ao gerar PDF:", error);
                            this.showNotification('Ocorreu um erro ao gerar o PDF.', 'danger');
                        }
                    },
                    copyShareCodeForChart() {
                        const c = APP.dom.controls;
                        const sharePayload = {
                            type: 'chart',
                            version: 1,
                            data: APP.state.data,
                            controls: {}
                        };
                        for (const key in c) {
                            const e = c[key];
                            if (e && e.id && typeof e.value !== 'undefined' && e.type !== 'file') {
                                sharePayload.controls[key] = e.value;
                            }
                        }
                        const shareCode = btoa(JSON.stringify(sharePayload));
                        navigator.clipboard.writeText(shareCode).then(() => this.showNotification('C√≥digo de compartilhamento do gr√°fico copiado!', 'success')).catch(() => this.showNotification('Falha ao copiar o c√≥digo.', 'danger'));
                    },
                    applyShareCodeFromModal() {
                         this.showModal('Aplicar C√≥digo de Compartilhamento', {
                            type: 'input',
                            placeholder: 'Cole o c√≥digo do gr√°fico ou pasta aqui'
                        }, (shareCode) => {
                            if (shareCode) {
                               this.processShareCode(shareCode);
                            }
                        });
                    },
                    processShareCode(code, typeCheck = null) {
                         try {
                            const decodedString = atob(code);
                            const payload = JSON.parse(decodedString);

                            // CORRECTED VALIDATION
                            if (payload.version !== 1 || !payload.type) {
                                throw new Error("Formato de c√≥digo inv√°lido ou vers√£o incompat√≠vel.");
                            }

                            if (typeCheck && payload.type !== typeCheck) {
                                throw new Error(`Este c√≥digo √© para um "${payload.type}". Por favor, use a √°rea correta para importa√ß√£o.`);
                            }

                            if (payload.type === 'folder' || payload.type === 'chart') {
                                this.addSharedItem(payload, true); // The 'true' flag handles ID regeneration
                                this.renderAllViews();
                                this.saveState();
                                this.showNotification(`${payload.type === 'folder' ? 'Pasta' : 'Gr√°fico'} "${payload.name}" adicionado com sucesso!`, 'success');
                            } else {
                                throw new Error("Tipo de item compartilhado desconhecido.");
                            }

                        } catch (error) {
                            console.error(error);
                            this.showNotification(`Falha ao aplicar c√≥digo: ${error.message}`, 'danger');
                        }
                    },
                    saveCurrentChart() {
                        let chartIcon = 'bi-bar-chart-line'; // Default icon

                        const onIconSelected = (iconClass) => {
                            chartIcon = iconClass;
                            APP.state.iconSelectorModal.hide();
                            this.showModal('Salvar Gr√°fico', {
                                type: 'input',
                                value: APP.dom.controls.chartTitle.value,
                                label: 'Nome do Gr√°fico:'
                            }, (name) => {
                                if (!name) return;
                                
                                const snapshot = {
                                    type: 'chart',
                                    id: 'chart_' + Date.now(),
                                    name: name,
                                    icon: chartIcon,
                                    data: JSON.parse(JSON.stringify(APP.state.data)),
                                    thumbnail: APP.state.chart.getDataURL({ type: 'png', pixelRatio: 1, backgroundColor: APP.dom.controls.chartBgColor.value }),
                                    controls: {}
                                };
                                for (const key in APP.dom.controls) {
                                    const e = APP.dom.controls[key];
                                    if (e && e.id && typeof e.value !== 'undefined' && e.type !== 'file') {
                                        snapshot.controls[key] = e.value;
                                    }
                                }
                                
                                this.addSharedItem(snapshot, false);
                                this.showNotification('Gr√°fico salvo com sucesso!', 'success');
                                this.renderAllViews();
                                this.saveState();
                            });
                        };

                        APP.dom.iconModal.el.querySelector('#icon-selector-confirm-btn').onclick = () => {
                            const selectedIcon = APP.dom.iconModal.grid.querySelector('.selected');
                            onIconSelected(selectedIcon ? selectedIcon.dataset.icon : 'bi-bar-chart-line');
                        };
                        APP.state.iconSelectorModal.show();
                    },

                    renderAllViews() {
                        this.renderFileSystemView(APP.dom.controls.savedItemsList, 'list');
                        this.renderFileSystemView(APP.dom.chartGalleryContainer, 'grid');
                        this.renderBreadcrumbs();
                    },

                    renderBreadcrumbs() {
                        const path = APP.state.currentPath;
                        const renderTo = (container) => {
                             const ol = document.createElement('ol');
                             ol.className = 'breadcrumb';
                             path.forEach((folderId, index) => {
                                const folder = this.findItemById(folderId);
                                if(!folder) return;
                                
                                const li = document.createElement('li');
                                li.className = `breadcrumb-item ${index === path.length - 1 ? 'active' : ''}`;
                                
                                if (index === path.length - 1) {
                                    li.textContent = folder.name;
                                } else {
                                    const a = document.createElement('a');
                                    a.textContent = folder.name;
                                    a.onclick = (e) => {
                                        e.preventDefault();
                                        this.navigateToFolder(folderId);
                                    }
                                    li.appendChild(a);
                                }
                                ol.appendChild(li);
                             });
                             container.innerHTML = '';
                             container.appendChild(ol);
                        }
                        renderTo(APP.dom.homeBreadcrumbNav);
                        renderTo(APP.dom.sidebarBreadcrumbNav);
                    },

                    renderFileSystemView(container, viewType = 'list') {
                        const currentFolderId = APP.state.currentPath[APP.state.currentPath.length - 1];
                        const currentFolder = this.findItemById(currentFolderId);
                        
                        if(!currentFolder || !currentFolder.items) {
                             container.innerHTML = `<p class="text-muted text-center small p-3">Esta pasta est√° vazia.</p>`;
                             return;
                        }
                        
                        container.innerHTML = '';
                        // Sort items to show folders first
                        const items = [...currentFolder.items].sort((a, b) => {
                            if (a.type === 'folder' && b.type !== 'folder') return -1;
                            if (a.type !== 'folder' && b.type === 'folder') return 1;
                            return a.name.localeCompare(b.name);
                        });

                        if (items.length === 0) {
                            if (viewType === 'grid') {
                                container.innerHTML = '<div class="col-12"><p class="text-muted text-center fs-5 mt-5">Esta pasta est√° vazia. Clique em "Nova Pasta" para come√ßar a organizar.</p></div>';
                            } else {
                                container.innerHTML = '<p class="text-muted text-center small p-2">Pasta vazia.</p>';
                            }
                            return;
                        }
                        
                        items.forEach(item => {
                            let itemEl;
                            if(viewType === 'grid') {
                                itemEl = this.createGridItem(item);
                            } else {
                                itemEl = this.createListItem(item);
                            }
                            container.appendChild(itemEl);
                        });
                    },

                    createListItem(item) {
                         const itemEl = document.createElement('div');
                         itemEl.className = 'saved-item';
                         itemEl.dataset.itemId = item.id;
                         itemEl.dataset.itemType = item.type;
                         
                         const thumbnailSrc = item.thumbnail || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                         const iconHtml = item.type === 'folder' 
                           ? `<i class="bi bi-folder"></i>`
                           : `<img class="saved-item-thumbnail" src="${thumbnailSrc}" alt="Pr√©via">`;
                         
                         itemEl.innerHTML = `
                            <div class="thumbnail-container">${iconHtml}</div>
                            <span class="saved-item-name small" title="${item.name}">${item.name}</span>
                            <div class="saved-item-preview-pane">${item.type === 'chart' && item.thumbnail ? `<img src="${item.thumbnail}" alt="Pr√©via de ${item.name}">` : ''}</div>
                         `;
                         
                         itemEl.addEventListener('click', () => this.handleItemClick(item));
                         itemEl.addEventListener('contextmenu', (e) => {
                             e.preventDefault();
                             e.stopPropagation();
                             this.showContextMenu(e.clientX, e.clientY, item);
                         });

                         return itemEl;
                    },

                    createGridItem(item) {
                        const cardCol = document.createElement('div');
                        cardCol.className = 'col';
                        cardCol.dataset.itemId = item.id;
                        cardCol.dataset.itemType = item.type;

                        let imageHtml;
                        if (item.type === 'folder') {
                            imageHtml = `<div class="card-img-top gallery-card-img gallery-folder-img"><i class="bi bi-folder-fill"></i></div>`;
                        } else {
                            const thumbnailSrc = item.thumbnail || 'https://placehold.co/600x400/eeeeee/cccccc?text=Sem+Pr%C3%A9via';
                            imageHtml = `<img src="${thumbnailSrc}" class="card-img-top gallery-card-img" alt="Pr√©via de ${item.name}">`;
                        }

                        const iconHtml = `<div class="gallery-card-icon"><i class="${item.icon || 'bi bi-folder'}"></i></div>`;

                        cardCol.innerHTML = `
                            <div class="card h-100 gallery-card shadow-sm">
                                ${imageHtml}
                                <div class="card-body">
                                    ${iconHtml}
                                    <h5 class="card-title">${item.name}</h5>
                                    <p class="card-text small text-muted">
                                        ${item.type === 'folder' ? `${item.items.length} item(s)` : `Salvo em: ${new Date(parseInt(item.id.split('_')[1])).toLocaleDateString()}`}
                                    </p>
                                </div>
                            </div>
                        `;
                        
                        cardCol.querySelector('.gallery-card').addEventListener('click', () => this.handleItemClick(item));
                        cardCol.querySelector('.gallery-card').addEventListener('contextmenu', (e) => {
                             e.preventDefault();
                             e.stopPropagation();
                             this.showContextMenu(e.clientX, e.clientY, item);
                         });

                        return cardCol;
                    },

                    handleItemClick(item) {
                        if (item.type === 'folder') {
                            this.navigateToFolder(item.id);
                        } else { // chart
                            this.loadSavedChart(item.id, true);
                        }
                    },

                    navigateToFolder(folderId) {
                         const pathIndex = APP.state.currentPath.indexOf(folderId);
                         if (pathIndex > -1) {
                             // If navigating up the tree, slice the path
                            APP.state.currentPath = APP.state.currentPath.slice(0, pathIndex + 1);
                         } else {
                             // Navigating down
                            APP.state.currentPath.push(folderId);
                         }
                         this.renderAllViews();
                         this.saveState();
                    },

                    loadSavedChart(chartId, navigateToCreator = false) {
                        const chartToLoad = this.findItemById(chartId);
                        if (!chartToLoad || chartToLoad.type !== 'chart') {
                            this.showNotification('Gr√°fico n√£o encontrado.', 'danger');
                            return;
                        }
                        APP.state.data = chartToLoad.data;
                        for (const key in chartToLoad.controls) {
                            if (APP.dom.controls[key] && chartToLoad.controls[key] !== undefined) {
                                APP.dom.controls[key].value = chartToLoad.controls[key];
                            }
                        }
                        this.rebuildUI();
                        this.toggleLineStyleControl();
                        this.showNotification(`Gr√°fico "${chartToLoad.name}" carregado!`, 'success');

                        if (navigateToCreator) {
                            this.navigateTo('creator');
                        }
                    },
                    deleteItem(itemId) {
                         const item = this.findItemById(itemId);
                         if(!item) return;
                         
                         const message = item.type === 'folder' 
                            ? "Tem certeza que deseja excluir esta pasta? TODOS os gr√°ficos e sub-pastas dentro dela ser√£o perdidos PERMANENTEMENTE."
                            : "Tem certeza que deseja excluir este gr√°fico salvo?";

                        this.showModal('Confirmar Exclus√£o', message, (confirmed) => {
                            if (!confirmed) return;
                            const parentFolder = this.findParentFolder(itemId);
                            if(parentFolder) {
                                parentFolder.items = parentFolder.items.filter(i => i.id !== itemId);
                                const deleteFromFS = (id) => {
                                    const itemToDelete = APP.state.fileSystem[id];
                                    if(itemToDelete && itemToDelete.type === 'folder') {
                                        itemToDelete.items.forEach(child => deleteFromFS(child.id));
                                    }
                                    delete APP.state.fileSystem[id];
                                };
                                deleteFromFS(itemId);

                                this.renderAllViews();
                                this.saveState();
                                this.showNotification('Item exclu√≠do.', 'info');
                            }
                        }, {
                            confirmClass: 'btn-danger',
                            confirmText: 'Excluir'
                        });
                    },
                    resetToDefault() {
                        APP.state.themeChoiceModal.show();
                    },
                    performReset(theme) {
                        APP.state.themeChoiceModal.hide();
                        localStorage.removeItem('alladinAppState');
                        APP.state.fileSystem = { 'root': { type: 'folder', id: 'root', name: 'In√≠cio', items: [] } };
                        APP.state.currentPath = ['root'];
                        this.generateRandomData(theme);
                        this.rebuildUI(false);
                        this.toggleLineStyleControl();
                        this.navigateTo('creator');
                        this.renderAllViews();
                        this.saveState();
                        this.showNotification("Aplica√ß√£o reiniciada para o padr√£o.", "info");
                    },
                    showModal(title, bodyContent, callback, options = {}) {
                        const { confirmText = 'Confirmar', cancelText = 'Cancelar', confirmClass = 'btn-primary', confirmAction = true, cancelAction = false } = options;
                        const M = APP.dom.modal;
                        M.title.textContent = title;
                        M.body.innerHTML = '';
                        let inputElement = null;
                        if (typeof bodyContent === 'string') {
                             M.body.innerHTML = bodyContent;
                        } else if (typeof bodyContent === 'object' && bodyContent.type === 'input') {
                            if (bodyContent.label) {
                                const label = document.createElement('label');
                                label.className = 'form-label';
                                label.textContent = bodyContent.label;
                                M.body.appendChild(label);
                            }
                            inputElement = document.createElement('input');
                            inputElement.className = 'form-control';
                            inputElement.type = bodyContent.inputType || 'text';
                            inputElement.value = bodyContent.value || '';
                            inputElement.placeholder = bodyContent.placeholder || '';
                            M.body.appendChild(inputElement);
                        } else if (typeof bodyContent === 'object' && bodyContent.type === 'tree') {
                            const treeContainer = document.createElement('div');
                            treeContainer.style.maxHeight = '40vh';
                            treeContainer.style.overflowY = 'auto';
                            let selectedId = null;
                            const buildTree = (parentId, parentEl, level = 0) => {
                                const parentFolder = this.findItemById(parentId);
                                if (!parentFolder || !parentFolder.items) return;

                                parentFolder.items.forEach(item => {
                                    if (item.type === 'folder' && item.id !== bodyContent.excludeId) {
                                        const itemEl = document.createElement('div');
                                        itemEl.textContent = `${'‚Äî'.repeat(level*2)} ${item.name}`;
                                        itemEl.style.padding = '5px';
                                        itemEl.style.cursor = 'pointer';
                                        itemEl.dataset.id = item.id;
                                        itemEl.onclick = () => {
                                            selectedId = item.id;
                                            treeContainer.querySelectorAll('div').forEach(d => d.style.backgroundColor = 'transparent');
                                            itemEl.style.backgroundColor = 'var(--bs-primary-bg-subtle)';
                                        }
                                        parentEl.appendChild(itemEl);
                                        buildTree(item.id, parentEl, level + 1);
                                    }
                                });
                            };
                            const rootEl = document.createElement('div');
                            rootEl.textContent = this.findItemById('root').name;
                            rootEl.style.padding = '5px';
                            rootEl.style.cursor = 'pointer';
                            rootEl.dataset.id = 'root';
                            rootEl.onclick = () => {
                                selectedId = 'root';
                                treeContainer.querySelectorAll('div').forEach(d => d.style.backgroundColor = 'transparent');
                                rootEl.style.backgroundColor = 'var(--bs-primary-bg-subtle)';
                            }
                            treeContainer.appendChild(rootEl);
                            buildTree('root', treeContainer);
                            M.body.appendChild(treeContainer);
                            inputElement = treeContainer;
                            inputElement.value = () => selectedId;
                        }

                        M.confirmBtn.textContent = confirmText;
                        M.confirmBtn.className = `btn ${confirmClass}`;
                        M.el.querySelector('.modal-footer .btn-secondary').textContent = cancelText;
                        const handleConfirm = () => {
                            const value = inputElement ? (typeof inputElement.value === 'function' ? inputElement.value() : inputElement.value) : confirmAction;
                            callback(value);
                            APP.state.modal.hide();
                            cleanup();
                        };
                        const handleCancel = () => {
                            callback(cancelAction);
                            cleanup();
                        }
                        const cleanup = () => {
                            M.confirmBtn.removeEventListener('click', handleConfirm);
                            M.el.removeEventListener('hidden.bs.modal', handleCancel);
                        }
                        M.confirmBtn.addEventListener('click', handleConfirm);
                        M.el.addEventListener('hidden.bs.modal', handleCancel, { once: true });
                        APP.state.modal.show();
                        if (inputElement && typeof inputElement.focus === 'function') {
                            setTimeout(() => inputElement.focus(), 500);
                        }
                    },

                    populateIconSelector() {
                        const icons = ['bi-graph-up', 'bi-bar-chart-line-fill', 'bi-pie-chart-fill', 'bi-graph-down-arrow', 'bi-currency-dollar', 'bi-people-fill', 'bi-building', 'bi-cart-fill', 'bi-heart-fill', 'bi-star-fill', 'bi-calendar-event', 'bi-cloud-fill', 'bi-gear-fill', 'bi-lightbulb-fill', 'bi-lock-fill', 'bi-map-fill', 'bi-music-note', 'bi-phone-fill', 'bi-shield-fill', 'bi-speedometer2', 'bi-tree-fill', 'bi-trophy-fill', 'bi-camera-fill', 'bi-book-fill', 'bi-briefcase-fill', 'bi-chat-dots-fill', 'bi-clipboard-data-fill', 'bi-code-slash', 'bi-controller', 'bi-cpu-fill', 'bi-database-fill', 'bi-display-fill', 'bi-envelope-fill', 'bi-flag-fill', 'bi-folder-fill', 'bi-fuel-pump-fill', 'bi-globe', 'bi-hammer', 'bi-house-door-fill', 'bi-key-fill', 'bi-layers-fill', 'bi-list-task', 'bi-mouse3-fill', 'bi-p-circle-fill', 'bi-person-badge-fill', 'bi-plugin', 'bi-printer-fill', 'bi-robot', 'bi-rocket-takeoff-fill', 'bi-server', 'bi-sim-fill', 'bi-truck', 'bi-wallet-fill', 'bi-wifi', 'bi-window-stack', 'bi-wrench-adjustable'];
                        const grid = APP.dom.iconModal.grid;
                        grid.innerHTML = '';
                        icons.forEach(iconClass => {
                            const iconWrapper = document.createElement('div');
                            iconWrapper.className = 'icon-option';
                            iconWrapper.dataset.icon = iconClass;
                            iconWrapper.innerHTML = `<i class="${iconClass}"></i>`;
                            iconWrapper.addEventListener('click', () => {
                                grid.querySelectorAll('.icon-option').forEach(el => el.classList.remove('selected'));
                                iconWrapper.classList.add('selected');
                            });
                            grid.appendChild(iconWrapper);
                        });
                    },
                    // ---- FOLDER SYSTEM LOGIC ----
                    findItemById(itemId) {
                         if (APP.state.fileSystem[itemId]) {
                            return APP.state.fileSystem[itemId];
                        }
                        // Fallback search (should not be needed if FS is managed properly)
                        let found = null;
                        const search = (node) => {
                            if (node.id === itemId) {
                                found = node;
                                return;
                            }
                            if (node.type === 'folder' && node.items) {
                                for(const child of node.items) {
                                    search(child);
                                    if(found) return;
                                }
                            }
                        };
                        search(APP.state.fileSystem.root);
                        return found;
                    },
                    findParentFolder(itemId) {
                         for(const key in APP.state.fileSystem) {
                             const node = APP.state.fileSystem[key];
                             if(node.type === 'folder' && node.items && node.items.some(child => child.id === itemId)) {
                                 return node;
                             }
                         }
                         return null;
                    },

                    createNewFolder() {
                        this.showModal('Criar Nova Pasta', { type: 'input', label: 'Nome da Pasta:', placeholder: 'Ex: Relat√≥rios 2025' }, (name) => {
                            if (!name) return;
                            const newFolder = {
                                type: 'folder',
                                id: 'folder_' + Date.now(),
                                name: name,
                                icon: 'bi-folder-fill',
                                items: []
                            };
                            this.addSharedItem(newFolder, false);
                            this.renderAllViews();
                            this.saveState();
                            this.showNotification(`Pasta "${name}" criada.`, 'success');
                        });
                    },
                    renameItem(itemId) {
                        const item = this.findItemById(itemId);
                        if (!item) return;
                        this.showModal(`Renomear ${item.type === 'folder' ? 'Pasta' : 'Gr√°fico'}`, { type: 'input', value: item.name }, (newName) => {
                           if(newName && newName !== item.name) {
                               item.name = newName;
                               if(item.type === 'chart' && item.controls.chartTitle) {
                                   item.controls.chartTitle = newName;
                               }
                               this.renderAllViews();
                               this.saveState();
                           }
                        });
                    },
                    moveItem(itemIdToMove) {
                        const itemToMove = this.findItemById(itemIdToMove);
                        if (!itemToMove) return;

                        this.showModal('Mover para...', { type: 'tree', excludeId: itemIdToMove }, (destinationFolderId) => {
                            if (!destinationFolderId || destinationFolderId === this.findParentFolder(itemIdToMove)?.id) return;
                            
                            const oldParent = this.findParentFolder(itemIdToMove);
                            const newParent = this.findItemById(destinationFolderId);

                            if(oldParent && newParent) {
                                oldParent.items = oldParent.items.filter(i => i.id !== itemIdToMove);
                                newParent.items.push(itemToMove);

                                this.renderAllViews();
                                this.saveState();
                                this.showNotification(`"${itemToMove.name}" movido para "${newParent.name}".`, 'success');
                            }
                        });
                    },
                    copyShareCodeForItem(itemId) {
                        const item = this.findItemById(itemId);
                        if(!item) return;
                        const itemToShare = JSON.parse(JSON.stringify(item));
                        const sharePayload = { version: 1, ...itemToShare };
                        const shareCode = btoa(JSON.stringify(sharePayload));
                        navigator.clipboard.writeText(shareCode).then(() => this.showNotification(`C√≥digo para "${item.name}" copiado!`, 'success')).catch(() => this.showNotification('Falha ao copiar o c√≥digo.', 'danger'));
                    },
                    addSharedItem(item, isFromShareCode) {
                        const parentFolderId = APP.state.currentPath[APP.state.currentPath.length - 1];
                        const parentFolder = this.findItemById(parentFolderId);

                        if(!parentFolder) {
                            this.showNotification('Erro: Pasta atual n√£o encontrada.', 'danger');
                            return;
                        }
                        
                        const idMap = {};
                        const processItemAndChildren = (currentItem, isRootOfShare) => {
                            const oldId = currentItem.id;
                            let newId = oldId;
                            if (isFromShareCode || isRootOfShare) {
                                newId = `${currentItem.type}_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
                            }
                            currentItem.id = newId;
                            idMap[oldId] = newId;
                            
                            APP.state.fileSystem[newId] = currentItem;
                            
                            if (currentItem.type === 'folder' && currentItem.items) {
                                currentItem.items.forEach(child => processItemAndChildren(child, true));
                            }
                        };
                        
                        processItemAndChildren(item, isFromShareCode);
                        parentFolder.items.push(item);
                    },
                    // ---- END FOLDER SYSTEM LOGIC ----
                    AI_ASSISTANT: { // This part remains largely unchanged but is included for completeness
                        history: [],
                        recognition: null,
                        init() {
                            const controls = APP.dom.controls;
                            controls.aiChatFab.addEventListener('click', () => APP.state.aiChatModal.show());
                            controls.openChatFromSidebar.addEventListener('click', () => APP.state.aiChatModal.show());
                            controls.aiChatSendBtn.addEventListener('click', () => this.handleUserInput());
                            controls.aiChatInput.addEventListener('keypress', (e) => {
                                if (e.key === 'Enter') {
                                    e.preventDefault();
                                    this.handleUserInput();
                                }
                            });

                            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                            if (SpeechRecognition) {
                                this.recognition = new SpeechRecognition();
                                this.recognition.continuous = false;
                                this.recognition.lang = 'pt-BR';
                                this.recognition.interimResults = false;
                                this.recognition.maxAlternatives = 1;

                                controls.voiceCommandBtn.addEventListener('click', () => {
                                    this.recognition.start();
                                    controls.voiceCommandBtn.classList.add('recording');
                                    controls.voiceCommandBtn.disabled = true;
                                });

                                this.recognition.onresult = (event) => {
                                    const transcript = event.results[0][0].transcript;
                                    controls.aiChatInput.value = transcript;
                                    this.handleUserInput();
                                };

                                this.recognition.onspeechend = () => this.recognition.stop();

                                this.recognition.onend = () => {
                                    controls.voiceCommandBtn.classList.remove('recording');
                                    controls.voiceCommandBtn.disabled = false;
                                };

                                this.recognition.onerror = (event) => {
                                    console.error("Speech recognition error", event.error);
                                    APP.methods.showNotification('Erro no reconhecimento de voz.', 'danger');
                                };
                            } else {
                                controls.voiceCommandBtn.style.display = 'none';
                            }
                        },
                        addMessage(text, sender, isToolMessage = false) {
                            const messageContainer = APP.dom.controls.aiChatMessages;
                            const messageDiv = document.createElement('div');
                            const messageClass = isToolMessage ? 'tool' : sender;
                            messageDiv.className = `chat-message ${messageClass}`;

                            if (isToolMessage) {
                                messageDiv.innerHTML = `üê∂ Executando a√ß√£o: <strong>${text}</strong>...`;
                            } else {
                                messageDiv.innerHTML = sender === 'ai' ? marked.parse(text) : text;
                            }

                            messageContainer.appendChild(messageDiv);
                            messageContainer.scrollTop = messageContainer.scrollHeight;
                        },
                        showTyping(show) {
                            APP.dom.controls.aiTypingIndicator.style.display = show ? 'block' : 'none';
                            if (show) APP.dom.controls.aiChatMessages.scrollTop = APP.dom.controls.aiChatMessages.scrollHeight;
                        },
                        async handleUserInput() {
                            const input = APP.dom.controls.aiChatInput;
                            const userMessage = input.value.trim();
                            if (!userMessage) return;
                            this.addMessage(userMessage, 'user');
                            input.value = '';
                            this.showTyping(true);
                            setTimeout(() => this.mockBackendResponse(userMessage), 1000);
                        },
                        mockBackendResponse(prompt) {
                            this.showTyping(false);
                            const lowerPrompt = prompt.toLowerCase();

                            const dataRegex = /no ano (\d{4}) o valor (?:√©|e) ([\d\.]+)/g;
                            let matches;
                            let dataPoints = [];
                            while ((matches = dataRegex.exec(lowerPrompt)) !== null) {
                                dataPoints.push({ label: matches[1], value: parseFloat(matches[2]) });
                            }

                            if (dataPoints.length > 0) {
                                this.handleToolCall({ name: 'updateMultipleDataPoints', args: { points: dataPoints } });
                                this.addMessage(`Ok! Atualizei ${dataPoints.length} ponto(s) de dados para voc√™.`, 'ai');
                                return;
                            }

                            if (lowerPrompt.includes('azul')) {
                                this.handleToolCall({ name: 'changeChartColor', args: { color: '#0d6efd' } });
                                this.addMessage("Claro, aqui est√° o gr√°fico em azul!", 'ai');
                            } else if (lowerPrompt.includes('barras')) {
                                this.handleToolCall({ name: 'changeChartType', args: { type: 'bar' } });
                                this.addMessage("Transformei em um gr√°fico de barras.", 'ai');
                            } else if (lowerPrompt.includes('aleat√≥rio')) {
                                this.handleToolCall({ name: 'generateRandomChart' });
                                this.addMessage("Criei um novo gr√°fico com dados aleat√≥rios para voc√™ come√ßar!", 'ai');
                            } else {
                                this.addMessage("Desculpe, n√£o entendi o comando. Tente algo como 'crie um gr√°fico de barras azul' ou 'no ano 2020 o valor √© 300'.", 'ai');
                            }
                        },
                        handleToolCall(toolCall) {
                            const { name, args } = toolCall;
                            this.addMessage(name, 'ai', true);
                            switch (name) {
                                case 'generateRandomChart':
                                    APP.methods.generateRandomData(APP.state.theme);
                                    APP.methods.rebuildUI();
                                    break;
                                case 'changeChartColor':
                                    if (args.color) {
                                        APP.dom.controls.lineColor.value = args.color;
                                        APP.methods.updateSettings();
                                    }
                                    break;
                                case 'changeChartType':
                                    if (args.type) {
                                        APP.dom.controls.chartType.value = args.type;
                                        APP.methods.updateSettings();
                                    }
                                    break;
                                case 'updateMultipleDataPoints':
                                    if (args.points && args.points.length > 0) {
                                        args.points.forEach(point => {
                                            const index = APP.state.data.labels.indexOf(point.label);
                                            if (index !== -1) {
                                                APP.state.data.values[index] = point.value;
                                            } else {
                                                APP.state.data.labels.push(point.label);
                                                APP.state.data.values.push(point.value);
                                            }
                                        });
                                        const isAllYears = APP.state.data.labels.every(l => !isNaN(parseInt(l)));
                                        if (isAllYears) {
                                            const combined = APP.state.data.labels.map((l, i) => ({ label: l, value: APP.state.data.values[i] }));
                                            combined.sort((a, b) => parseInt(a.label) - parseInt(b.label));
                                            APP.state.data.labels = combined.map(d => d.label);
                                            APP.state.data.values = combined.map(d => d.value);
                                        }
                                        APP.methods.rebuildUI();
                                    }
                                    break;
                                case 'setChartData':
                                    if (args.labels && args.values && args.labels.length === args.values.length) {
                                        APP.state.data.labels = args.labels.map(String);
                                        APP.state.data.values = args.values.map(Number);
                                        APP.methods.rebuildUI();
                                    }
                                    break;
                            }
                        }
                    }
                }
            };
            APP.methods.init();
        });
    </script>
</body>

</html>