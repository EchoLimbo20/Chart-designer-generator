<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AllaChartüê∂</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Poppins:wght@700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bs-body-font-family: 'Inter', sans-serif;
            --bs-body-bg: #f8f9fa;
        }
        [data-bs-theme="dark"] {
            --bs-body-bg: #1a1a1a;
        }
        
        /* --- INTRO ANIMATION (GRAPH EASTER EGG) --- */
        #intro-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #1A1D2D; z-index: 10000; transition: opacity 0.8s ease-in-out; pointer-events: none; display: flex; align-items: center; justify-content: center; }
        #intro-animation-container { position: relative; width: clamp(300px, 60vw, 600px); display: flex; flex-direction: column; align-items: center; }
        #intro-graph { width: 100%; filter: drop-shadow(0 0 10px rgba(0, 247, 255, 0.7)); }
        #intro-graph path { stroke-dasharray: 1000; stroke-dashoffset: 1000; animation: draw 1.8s ease-in-out forwards; }
        @keyframes draw { to { stroke-dashoffset: 0; } }
        #intro-title { font-family: 'Poppins', sans-serif; font-size: clamp(2.5rem, 10vw, 5rem); font-weight: 700; color: #fff; margin-top: -1rem; opacity: 0; transform: translateY(10px); animation: fadeIn 1s ease-out 1.5s forwards; }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        
        /* --- MAIN APP STYLES --- */
        .app-container { opacity: 0; transition: opacity 0.5s ease-in; min-width: 1400px; }
        .app-container.visible { opacity: 1; }
        .navbar-brand h1 { font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 1.5rem; margin: 0; }
        #sidebar { position: sticky; top: 60px; height: calc(100vh - 60px); overflow-y: auto; background-color: var(--bs-body-tertiary); display: flex; flex-direction: column; }
        .accordion { flex-grow: 1; }
        .accordion-button { font-weight: 500; font-size: 0.95rem; }
        .accordion-button:not(.collapsed) { background-color: rgba(var(--bs-primary-rgb), 0.1); }
        .accordion-body label { font-size: 0.8rem; font-weight: 500; color: var(--bs-secondary-color); }
        #data-input-container { display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto; margin-bottom: 1rem; }
        .data-input-row { display: flex; align-items: center; gap: 0.5rem; border-radius: 0.25rem; }
        .data-input-row .year-controls { display: flex; flex-direction: column; }
        .data-input-row .add-year-btn { display: none; cursor: pointer; line-height: 1; font-size: 0.8rem; padding: 0.1rem 0.3rem; }
        .data-input-row:hover .add-year-btn { display: inline-block; }
        .data-input-row label { flex-grow: 1; text-align: right; }
        #main-content { flex-grow: 1; padding: 1.5rem; }
        #chart-container { width: 100%; height: 80vh; min-height: 600px; background-color: var(--bs-body-tertiary); border-radius: 0.375rem; box-shadow: var(--bs-box-shadow-sm); padding: 1rem; transition: background-color 0.3s, border-color 0.3s; }
        #notification-container { z-index: 1100; }
        
        /* --- Saved Charts List & Previews --- */
        .saved-chart-item { position: relative; display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid var(--bs-border-color); }
        .saved-chart-item .thumbnail-container { width: 40px; height: 30px; margin-right: 8px; flex-shrink: 0; background-color: var(--bs-tertiary-bg); border: 1px solid var(--bs-border-color); border-radius: 3px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .saved-chart-item .saved-chart-thumbnail { width: 100%; height: 100%; object-fit: cover; }
        .saved-chart-item .saved-chart-name { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 8px; }
        .saved-chart-preview-pane { display: none; position: absolute; top: 50%; transform: translateY(-50%); left: 100%; margin-left: 15px; z-index: 1200; border: 1px solid var(--bs-border-color); box-shadow: var(--bs-box-shadow-lg); background-color: var(--bs-body-bg); padding: 0.5rem; border-radius: 0.375rem; pointer-events: none; }
        .saved-chart-preview-pane img { max-width: 400px; max-height: 300px; display: block; }
        .saved-chart-item:hover .saved-chart-preview-pane { display: block; }
        
        /* --- Custom Context Menu --- */
        #custom-context-menu { position: absolute; z-index: 10001; background-color: var(--bs-body-bg); border: 1px solid var(--bs-border-color); border-radius: 0.375rem; box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15); padding: 0.5rem 0; min-width: 150px; }
        .context-menu-item { padding: 0.5rem 1rem; cursor: pointer; font-size: 0.9rem; }
        .context-menu-item:hover { background-color: var(--bs-primary-bg-subtle); }
        .context-menu-item.delete { color: var(--bs-danger); }

        /* --- AI CHAT STYLES --- */
        #ai-chat-fab {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--bs-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1050;
            transition: transform 0.2s ease-in-out;
        }
        #ai-chat-fab:hover {
            transform: scale(1.1);
        }
        #ai-chat-modal .modal-body {
            height: 60vh;
            display: flex;
            flex-direction: column;
        }
        #ai-chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.4;
        }
        .chat-message.user {
            background-color: var(--bs-primary-bg-subtle);
            align-self: flex-end;
            margin-left: auto;
        }
        .chat-message.ai {
            background-color: var(--bs-secondary-bg-subtle);
            align-self: flex-start;
        }
        .chat-message.tool {
            color: var(--bs-secondary-color);
            font-style: italic;
            font-size: 0.8rem;
            text-align: center;
            width: 100%;
            background-color: transparent;
        }
        .typing-indicator {
            display: flex;
            align-items: center;
        }
        .typing-indicator span {
            height: 8px; width: 8px; margin: 0 2px;
            background-color: var(--bs-secondary-color);
            border-radius: 50%; display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
    
    <script src="/_vercel/speed-insights/script.js" defer></script>
    <script>
      window.va = window.va || function () { (window.va.q = window.va.q || []).push(arguments); };
    </script>
    <script src="/_vercel/insights/script.js" defer></script>

</head>

<body>
    <div id="intro-overlay">
        <div id="intro-animation-container">
            <svg id="intro-graph" viewBox="0 0 400 100" preserveAspectRatio="none">
                <path d="M 0,50 L 50,50 C 75,10, 125,90, 150,50 S 225,10, 250,50 S 325,90, 350,50 L 400,50" fill="none" stroke="#00f7ff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h1 id="intro-title">AllaChartüê∂</h1>
        </div>
    </div>

    <div class="app-container">
        <nav class="navbar bg-body-tertiary border-bottom sticky-top">
            <div class="container-fluid">
                <a class="navbar-brand d-flex align-items-center" href="#"><svg class="me-2" style="width: 2rem; height: 2rem; fill: currentColor;" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g><circle cx="50" cy="25" r="15"/><circle cx="38" cy="40" r="12"/><circle cx="62" cy="40" r="12"/><path d="M 35,55 A 20,20 0 0,1 65,55 L 70,80 A 10,10 0 0,1 60,90 L 40,90 A 10,10 0 0,1 30,80 Z"/><circle cx="75" cy="55" r="5"/></g></svg><h1>AllaChartüê∂</h1></a>
                <button class="btn border-0" id="theme-toggle" title="Alternar Tema"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"/></svg></button>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <aside id="sidebar" class="col-lg-3 p-3">
                    <div class="accordion" id="settingsAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSavedCharts">Seus Gr√°ficos</button></h2>
                            <div id="collapseSavedCharts" class="accordion-collapse collapse show" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body">
                                    <div class="d-grid gap-2 mb-3">
                                        <button id="save-chart-btn" class="btn btn-success">Salvar Gr√°fico Atual</button>
                                    </div>
                                    <div id="saved-charts-list"></div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseData">Editor de Dados</button></h2>
                            <div id="collapseData" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <button id="rename-series-btn" class="btn btn-sm btn-outline-secondary">Renomear S√©rie</button>
                                    </div>
                                    <div id="data-input-container"></div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseChart">Configura√ß√µes do Gr√°fico</button></h2>
                            <div id="collapseChart" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body">
                                    <label for="chart-title" class="form-label">T√≠tulo Principal</label><input type="text" id="chart-title" class="form-control form-control-sm mb-2">
                                    <label for="chart-type" class="form-label">Tipo de Gr√°fico</label><select id="chart-type" class="form-select form-select-sm mb-2"><option value="line">Linha</option><option value="bar">Barras</option><option value="pie">Pizza</option><option value="scatter">Dispers√£o</option></select>
                                    <div id="line-style-control-wrapper" class="mb-2"><label for="line-style-select" class="form-label">Estilo da Linha</label><select id="line-style-select" class="form-select form-select-sm"><option value="true">Arredondadas</option><option value="false">Retas</option></select></div>
                                    <div class="row"><div class="col"><label class="form-label">Cor da S√©rie</label><input type="color" id="line-color" class="form-control form-control-color w-100" value="#6c757d"></div><div class="col"><label class="form-label">Fundo</label><input type="color" id="chart-bg-color" class="form-control form-control-color w-100"></div></div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAxes">Eixos e Detalhes</button></h2>
                            <div id="collapseAxes" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body">
                                    <div class="row mb-2"><div class="col"><label for="x-axis-title" class="form-label">T√≠tulo Eixo X</label><input type="text" id="x-axis-title" class="form-control form-control-sm"></div><div class="col"><label for="y-axis-title" class="form-label">T√≠tulo Eixo Y</label><input type="text" id="y-axis-title" class="form-control form-control-sm"></div></div>
                                    <label class="form-label">Faixa de Valores do Eixo Y</label>
                                    <div class="input-group input-group-sm mb-2">
                                        <input type="number" id="y-axis-min" class="form-control" placeholder="M√≠nimo">
                                        <input type="number" id="y-axis-max" class="form-control" placeholder="M√°ximo">
                                        <button class="btn btn-outline-secondary" type="button" id="y-axis-range-reset-btn">Reset</button>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col"><label class="form-label">Linhas Verticais (X)</label><select id="x-grid-lines" class="form-select form-select-sm"><option>Auto</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>10</option></select></div>
                                        <div class="col"><label class="form-label">Linhas Horizontais (Y)</label><select id="y-grid-lines" class="form-select form-select-sm"><option>Auto</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>10</option></select></div>
                                    </div>
                                    <label for="grid-style" class="form-label">Estilo da Grade</label><select id="grid-style" class="form-select form-select-sm mb-2"><option value="dotted">Pontilhada</option><option value="dashed">Tracejada</option><option value="solid">S√≥lida</option><option value="none">Nenhuma</option></select>
                                    <div class="row"><div class="col"><label class="form-label">Tam. Fonte T√≠tulos</label><input type="number" id="title-font-size" class="form-control form-control-sm" min="10" value="14"></div><div class="col"><label class="form-label">Cor Fonte T√≠tulos</label><input type="color" id="title-color" class="form-control form-control-color w-100"></div></div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                             <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHelp">
                                    ü§ñ Assistente Alladin
                                </button>
                            </h2>
                            <div id="collapseHelp" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body text-center">
                                    <p class="small text-muted">Precisa de ajuda ou quer criar um gr√°fico com comandos? Clique no bot√£o de chat no canto inferior direito para falar com o Alladin!</p>
                                    <button class="btn btn-primary" id="open-chat-from-sidebar">Abrir Chat</button>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFile">Arquivo</button></h2>
                            <div id="collapseFile" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body">
                                    <div class="d-grid gap-2">
                                        <button id="import-btn" class="btn btn-outline-secondary">Importar Planilha</button>
                                        <button id="export-excel" class="btn btn-primary">Exportar para Excel</button>
                                        <button id="export-pdf-btn" class="btn btn-danger">Exportar para PDF</button> 
                                        <hr>
                                        <button id="copy-design-code-btn" class="btn btn-sm btn-outline-info">Copiar C√≥digo de Design</button>
                                        <button id="apply-design-code-btn" class="btn btn-sm btn-info">Aplicar C√≥digo de Design</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-grid mt-3">
                        <button id="reset-to-default-btn" class="btn btn-warning">Reiniciar para o Padr√£o</button>
                    </div>
                </aside>
                <main class="col-lg-9 p-4"><div id="chart-container"></div></main>
            </div>
        </div>
    </div>
    
    <div id="notification-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <div class="modal fade" id="genericModal" tabindex="-1" aria-labelledby="genericModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="genericModalLabel">T√≠tulo do Modal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="genericModalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="genericModalConfirmBtn">Confirmar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="ai-chat-fab" title="Falar com Alladin">üßû</div>

    <div class="modal fade" id="ai-chat-modal" tabindex="-1" aria-labelledby="aiChatModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aiChatModalLabel">Falar com Alladin üßû</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="ai-chat-messages"></div>
                    <div id="ai-typing-indicator" class="mt-2" style="display: none;">
                        <div class="chat-message ai typing-indicator">
                           <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="input-group">
                        <input type="text" id="ai-chat-input" class="form-control" placeholder="Ex: 'Crie um gr√°fico de barras azul'..." aria-label="Sua mensagem">
                        <button class="btn btn-primary" type="button" id="ai-chat-send-btn">Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const introOverlay = document.getElementById('intro-overlay');
        const appContainer = document.querySelector('.app-container');

        const path = document.querySelector('#intro-graph path');
        const pathLength = path.getTotalLength();
        path.style.strokeDasharray = pathLength;
        path.style.strokeDashoffset = pathLength;

        setTimeout(() => {
            introOverlay.style.opacity = '0';
            appContainer.classList.add('visible');
            introOverlay.addEventListener('transitionend', () => introOverlay.style.display = 'none');
        }, 2800);

        const APP = {
            state: { chart: null, data: {}, theme: 'light', modal: null, aiChatModal: null },
            dom: {
                html: document.documentElement,
                chartContainer: document.getElementById('chart-container'),
                notificationContainer: document.getElementById('notification-container'),
                modal: {
                    el: document.getElementById('genericModal'),
                    title: document.getElementById('genericModalLabel'),
                    body: document.getElementById('genericModalBody'),
                    confirmBtn: document.getElementById('genericModalConfirmBtn')
                },
                controls: {
                    importBtn: document.getElementById('import-btn'),
                    chartType: document.getElementById('chart-type'),
                    chartTitle: document.getElementById('chart-title'),
                    titleFontSize: document.getElementById('title-font-size'),
                    titleColor: document.getElementById('title-color'),
                    xAxisTitle: document.getElementById('x-axis-title'),
                    yAxisTitle: document.getElementById('y-axis-title'),
                    lineColor: document.getElementById('line-color'),
                    gridStyle: document.getElementById('grid-style'),
                    chartBgColor: document.getElementById('chart-bg-color'),
                    xGridLines: document.getElementById('x-grid-lines'),
                    yGridLines: document.getElementById('y-grid-lines'),
                    yAxisMin: document.getElementById('y-axis-min'),
                    yAxisMax: document.getElementById('y-axis-max'),
                    yAxisRangeResetBtn: document.getElementById('y-axis-range-reset-btn'),
                    lineStyleSelect: document.getElementById('line-style-select'),
                    exportExcelBtn: document.getElementById('export-excel'),
                    exportPdfBtn: document.getElementById('export-pdf-btn'),
                    themeToggle: document.getElementById('theme-toggle'),
                    dataInputContainer: document.getElementById('data-input-container'),
                    renameSeriesBtn: document.getElementById('rename-series-btn'),
                    copyDesignCodeBtn: document.getElementById('copy-design-code-btn'),
                    applyDesignCodeBtn: document.getElementById('apply-design-code-btn'),
                    saveChartBtn: document.getElementById('save-chart-btn'),
                    savedChartsList: document.getElementById('saved-charts-list'),
                    resetToDefaultBtn: document.getElementById('reset-to-default-btn'),
                    // Removido: contactSubject, contactMessage, sendEmailBtn
                    aiChatFab: document.getElementById('ai-chat-fab'),
                    aiChatModal: document.getElementById('ai-chat-modal'),
                    aiChatMessages: document.getElementById('ai-chat-messages'),
                    aiChatInput: document.getElementById('ai-chat-input'),
                    aiChatSendBtn: document.getElementById('ai-chat-send-btn'),
                    aiTypingIndicator: document.getElementById('ai-typing-indicator'),
                    openChatFromSidebar: document.getElementById('open-chat-from-sidebar'),
                }
            },
            methods: {
                init() {
                    this.loadState();
                    APP.state.chart = echarts.init(APP.dom.chartContainer);
                    APP.state.modal = new bootstrap.Modal(APP.dom.modal.el);
                    APP.state.aiChatModal = new bootstrap.Modal(APP.dom.controls.aiChatModal);
                    this.bindEventListeners();
                    this.rebuildUI(false);
                    this.renderSavedChartsList();
                    this.toggleLineStyleControl();
                    this.AI_ASSISTANT.init();
                },
                updateSettings(save = true) {
                    this.updateChart();
                    if (save) this.saveState();
                },
                rebuildUI(save = true) {
                    this.renderDataEditorForm();
                    this.updateChart();
                    if (save) this.saveState();
                },
                bindEventListeners() {
                    for (const key in APP.dom.controls) {
                        const control = APP.dom.controls[key];
                        if (control && !control.id.includes('Btn') && control.id !== 'data-input-container' && control.id !== 'saved-charts-list' && !control.id.startsWith('ai-chat')) {
                            const eventType = (control.type === 'color' || control.type === 'number' || control.tagName === 'SELECT') ? 'change' : 'input';
                            control.addEventListener(eventType, () => this.updateSettings());
                        }
                    }
                    APP.state.chart.on('click', this.handleChartClick.bind(this));
                    APP.dom.controls.yAxisRangeResetBtn.addEventListener('click', () => {
                        APP.dom.controls.yAxisMin.value = '';
                        APP.dom.controls.yAxisMax.value = '';
                        this.updateSettings();
                    });
                    APP.dom.controls.chartType.addEventListener('change', () => this.toggleLineStyleControl());
                    APP.dom.controls.themeToggle.addEventListener('click', () => this.toggleTheme());
                    APP.dom.controls.importBtn.addEventListener('click', () => {
                        const u = document.createElement('input');
                        u.type = 'file';
                        u.accept = '.xlsx,.csv';
                        u.onchange = (e) => this.handleFileUpload(e);
                        u.click();
                    });
                    APP.dom.controls.exportExcelBtn.addEventListener('click', () => this.exportToExcel());
                    APP.dom.controls.exportPdfBtn.addEventListener('click', () => this.exportToPdf());
                    APP.dom.controls.renameSeriesBtn.addEventListener('click', () => this.renameSeries());
                    APP.dom.controls.copyDesignCodeBtn.addEventListener('click', () => this.copyDesignCode());
                    APP.dom.controls.applyDesignCodeBtn.addEventListener('click', () => this.applyDesignCode());
                    APP.dom.controls.saveChartBtn.addEventListener('click', () => this.saveCurrentChart());
                    APP.dom.controls.resetToDefaultBtn.addEventListener('click', () => this.resetToDefault());
                    window.addEventListener('click', () => this.hideContextMenu());
                },
                handleChartClick(params) {
                    const c = APP.dom.controls;
                    switch (params.componentType) {
                        case 'title':
                            this.showModal('Editar T√≠tulo Principal', { type: 'input', value: c.chartTitle.value }, (newTitle) => {
                                if (newTitle !== null) {
                                    c.chartTitle.value = newTitle;
                                    this.updateSettings();
                                }
                            });
                            break;
                        case 'xAxis':
                            this.showModal('Editar T√≠tulo do Eixo X', { type: 'input', value: c.xAxisTitle.value }, (newTitle) => {
                                if (newTitle !== null) {
                                    c.xAxisTitle.value = newTitle;
                                    this.updateSettings();
                                }
                            });
                            break;
                        case 'yAxis':
                            this.showModal('Editar T√≠tulo do Eixo Y', { type: 'input', value: c.yAxisTitle.value }, (newTitle) => {
                                if (newTitle !== null) {
                                    c.yAxisTitle.value = newTitle;
                                    this.updateSettings();
                                }
                            });
                            break;
                        case 'series':
                            const isPie = c.chartType.value === 'pie';
                            if (!isPie) {
                                this.showModal('Editar S√©rie', `Voc√™ clicou na s√©rie "${params.seriesName}". O que deseja fazer?`, (choice) => {
                                    if (choice === 'color') {
                                        c.lineColor.click();
                                    } else {
                                        this.editDataPoint(params);
                                    }
                                }, {
                                    cancelText: 'Editar Ponto',
                                    confirmText: 'Mudar Cor',
                                    confirmAction: 'color',
                                    cancelAction: 'value'
                                });
                            } else {
                                this.editDataPoint(params);
                            }
                            break;
                    }
                },
                editDataPoint(params) {
                    const currentLabel = APP.state.data.labels[params.dataIndex];
                    const currentValue = APP.state.data.values[params.dataIndex];
                    this.showModal(`Editar valor para "${currentLabel}"`, { type: 'input', inputType: 'number', value: currentValue }, (newValueStr) => {
                        if (newValueStr !== null) {
                            const newValue = parseFloat(newValueStr);
                            if (!isNaN(newValue)) {
                                APP.state.data.values[params.dataIndex] = newValue;
                                this.rebuildUI();
                                this.showNotification(`Valor para "${currentLabel}" atualizado para ${newValue}.`, 'success');
                            } else {
                                this.showNotification('Valor inv√°lido. Por favor, insira um n√∫mero.', 'danger');
                            }
                        }
                    });
                },
                renderDataEditorForm() {
                    const container = APP.dom.controls.dataInputContainer;
                    container.innerHTML = '';
                    if (!APP.state.data || !APP.state.data.values) return;
                    APP.state.data.values.forEach((value, index) => {
                        const row = document.createElement('div');
                        row.className = 'data-input-row';
                        row.addEventListener('contextmenu', (e) => {
                            e.preventDefault();
                            this.showContextMenu(e.clientX, e.clientY, index);
                        });
                        const controls = document.createElement('div');
                        controls.className = 'year-controls';
                        const addBeforeBtn = document.createElement('button');
                        addBeforeBtn.textContent = '+';
                        addBeforeBtn.className = 'btn btn-sm btn-outline-info add-year-btn';
                        addBeforeBtn.title = 'Adicionar ano anterior';
                        addBeforeBtn.onclick = (e) => {
                            e.stopPropagation();
                            this.addYear(index, true);
                        };
                        const addAfterBtn = document.createElement('button');
                        addAfterBtn.textContent = '+';
                        addAfterBtn.className = 'btn btn-sm btn-outline-info add-year-btn mt-1';
                        addAfterBtn.title = 'Adicionar ano seguinte';
                        addAfterBtn.onclick = (e) => {
                            e.stopPropagation();
                            this.addYear(index, false);
                        };
                        controls.appendChild(addBeforeBtn);
                        controls.appendChild(addAfterBtn);
                        const label = document.createElement('label');
                        label.textContent = APP.state.data.labels[index] || `Ponto ${index + 1}`;
                        label.className = 'form-label mb-0';
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.value = value;
                        input.className = 'form-control form-control-sm';
                        const commitChange = () => {
                            const newValue = parseFloat(input.value);
                            if (!isNaN(newValue)) {
                                if (APP.state.data.values[index] !== newValue) {
                                    APP.state.data.values[index] = newValue;
                                    this.updateChart();
                                    this.saveState();
                                }
                            } else {
                                input.value = APP.state.data.values[index];
                            }
                        };
                        input.addEventListener('blur', commitChange);
                        input.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' || e.key === 'Tab') {
                                e.preventDefault();
                                input.blur();
                            }
                        });
                        row.appendChild(controls);
                        row.appendChild(label);
                        row.appendChild(input);
                        container.appendChild(row);
                    });
                },
                addYear(index, before) {
                    const labels = APP.state.data.labels;
                    const values = APP.state.data.values;
                    const referenceYear = parseInt(labels[index], 10);
                    if (isNaN(referenceYear)) {
                        this.showNotification("N√£o √© poss√≠vel adicionar ano a partir de um r√≥tulo de texto.", "warning");
                        return;
                    }
                    const newYear = before ? referenceYear - 1 : referenceYear + 1;
                    const insertIndex = before ? index : index + 1;
                    labels.splice(insertIndex, 0, String(newYear));
                    values.splice(insertIndex, 0, 0);
                    this.rebuildUI();
                },
                deleteYear(index) {
                    const label = APP.state.data.labels[index];
                    this.showModal('Confirmar Exclus√£o', `Tem certeza que deseja excluir o item "${label}"?`, (confirmed) => {
                        if (confirmed) {
                            APP.state.data.labels.splice(index, 1);
                            APP.state.data.values.splice(index, 1);
                            this.rebuildUI();
                            this.showNotification("Item exclu√≠do.", "info");
                        }
                    }, {
                        confirmClass: 'btn-danger',
                        confirmText: 'Excluir'
                    });
                },
                showContextMenu(x, y, index) {
                    this.hideContextMenu();
                    const menu = document.createElement('div');
                    menu.id = 'custom-context-menu';
                    menu.style.top = `${y}px`;
                    menu.style.left = `${x}px`;
                    const deleteItem = document.createElement('div');
                    deleteItem.className = 'context-menu-item delete';
                    deleteItem.textContent = 'Excluir Item';
                    deleteItem.onclick = () => {
                        this.deleteYear(index);
                    };
                    menu.appendChild(deleteItem);
                    document.body.appendChild(menu);
                },
                hideContextMenu() {
                    const menu = document.getElementById('custom-context-menu');
                    if (menu) {
                        menu.remove();
                    }
                },
                renameSeries() {
                    const currentName = APP.state.data.name;
                    this.showModal('Renomear S√©rie', {
                        type: 'input',
                        value: currentName
                    }, (newName) => {
                        if (newName && newName !== currentName) {
                            APP.state.data.name = newName;
                            this.updateSettings();
                        }
                    });
                },
                generateRandomData() {
                    const pointCount = 7,
                        startYear = new Date().getFullYear() - pointCount;
                    const labels = Array.from({
                        length: pointCount
                    }, (_, i) => (startYear + i + 1).toString());
                    const values = Array.from({
                        length: pointCount
                    }, () => Math.floor(Math.random() * 250) + 150);
                    APP.state.data = {
                        name: 'Total de Servidores',
                        labels,
                        values
                    };
                    const c = APP.dom.controls;
                    c.chartTitle.value = 'Evolu√ß√£o Anual de Servidores';
                    c.xAxisTitle.value = 'Ano';
                    c.yAxisTitle.value = 'Total de Servidores';
                    c.titleColor.value = '#343a40';
                    c.lineColor.value = '#6c757d';
                    c.chartBgColor.value = '#ffffff';
                    c.titleFontSize.value = 14;
                    c.gridStyle.value = 'dotted';
                    c.lineStyleSelect.value = 'true';
                    c.chartType.value = 'line';
                    c.xGridLines.value = 'Auto';
                    c.yGridLines.value = 'Auto';
                    c.yAxisMin.value = '';
                    c.yAxisMax.value = '';
                },
                getChartOptions() {
                    const c = APP.dom.controls,
                        isDark = APP.state.theme === 'dark';
                    const gridColor = isDark ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)';
                    const textColor = isDark ? '#ccc' : '#666';
                    const titleColor = c.titleColor.value;
                    const gridStyleValue = c.gridStyle.value;
                    const showGrid = gridStyleValue !== 'none';
                    const getLineType = (style) => {
                        switch (style) {
                            case 'dotted':
                                return [2, 5];
                            case 'dashed':
                                return [7, 7];
                            case 'solid':
                                return 'solid';
                            default:
                                return 'solid';
                        }
                    };
                    const lineType = getLineType(gridStyleValue);
                    let yAxisSplit = {
                        show: showGrid,
                        lineStyle: {
                            type: lineType,
                            color: gridColor
                        }
                    };
                    if (c.yGridLines.value !== 'Auto') yAxisSplit.splitNumber = parseInt(c.yGridLines.value, 10);
                    let xAxisSplit = {
                        show: showGrid,
                        lineStyle: {
                            type: lineType,
                            color: gridColor
                        }
                    };
                    if (c.xGridLines.value !== 'Auto') xAxisSplit.splitNumber = parseInt(c.xGridLines.value, 10);
                    APP.dom.chartContainer.style.backgroundColor = c.chartBgColor.value;
                    const chartType = c.chartType.value;
                    let series = [];
                    const isSmooth = c.lineStyleSelect.value === 'true';
                    const titleFontSize = parseInt(c.titleFontSize.value, 10);
                    if (chartType === 'pie') {
                        series.push({
                            name: APP.state.data.name,
                            type: 'pie',
                            radius: '60%',
                            center: ['50%', '55%'],
                            data: APP.state.data.labels.map((l, i) => ({
                                value: APP.state.data.values[i],
                                name: l
                            })),
                            itemStyle: {
                                color: c.lineColor.value,
                                borderRadius: 5,
                                borderColor: c.chartBgColor.value,
                                borderWidth: 2,
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowOffsetY: 5,
                                shadowColor: 'rgba(0, 0, 0, 0.1)'
                            },
                            label: {
                                show: true,
                                color: textColor
                            }
                        });
                    } else {
                        series.push({
                            name: APP.state.data.name,
                            type: chartType,
                            data: APP.state.data.values,
                            smooth: isSmooth,
                            symbolSize: 8,
                            lineStyle: {
                                color: c.lineColor.value,
                                width: 3,
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowOffsetY: 5,
                                shadowColor: 'rgba(0, 0, 0, 0.2)'
                            },
                            itemStyle: {
                                color: c.lineColor.value
                            },
                            label: {
                                show: chartType === 'line' || chartType === 'bar',
                                position: 'top',
                                color: titleColor,
                                fontWeight: 'bold'
                            }
                        });
                    }
                    const yMin = parseFloat(c.yAxisMin.value);
                    const yMax = parseFloat(c.yAxisMax.value);
                    return {
                        backgroundColor: 'transparent',
                        title: {
                            text: c.chartTitle.value,
                            left: 'center',
                            textStyle: {
                                color: titleColor,
                                fontSize: titleFontSize + 4,
                                fontWeight: 'bold'
                            }
                        },
                        tooltip: {
                            trigger: 'axis'
                        },
                        grid: {
                            left: '8%',
                            right: '4%',
                            top: '15%',
                            bottom: '12%',
                            containLabel: true
                        },
                        toolbox: {
                            feature: {
                                dataView: {
                                    readOnly: false
                                },
                                magicType: {
                                    type: ['line', 'bar']
                                },
                                restore: {},
                                saveAsImage: {
                                    backgroundColor: c.chartBgColor.value
                                }
                            }
                        },
                        xAxis: {
                            type: 'category',
                            data: APP.state.data.labels,
                            name: c.xAxisTitle.value,
                            nameLocation: 'middle',
                            nameGap: 35,
                            nameTextStyle: {
                                color: titleColor,
                                fontSize: titleFontSize,
                                fontWeight: 'bold'
                            },
                            splitLine: xAxisSplit,
                            axisLine: {
                                lineStyle: {
                                    color: gridColor
                                }
                            },
                            axisLabel: {
                                color: textColor
                            }
                        },
                        yAxis: {
                            type: 'value',
                            name: c.yAxisTitle.value,
                            nameLocation: 'middle',
                            nameGap: 55,
                            nameTextStyle: {
                                color: titleColor,
                                fontSize: titleFontSize,
                                fontWeight: 'bold'
                            },
                            min: isNaN(yMin) ? null : yMin,
                            max: isNaN(yMax) ? null : yMax,
                            splitLine: yAxisSplit,
                            axisLine: {
                                lineStyle: {
                                    color: gridColor
                                }
                            },
                            axisLabel: {
                                color: textColor
                            }
                        },
                        series
                    };
                },
                updateChart() {
                    if (APP.state.chart) APP.state.chart.setOption(this.getChartOptions(), true);
                },
                toggleTheme() {
                    APP.state.theme = APP.state.theme === 'light' ? 'dark' : 'light';
                    APP.dom.html.setAttribute('data-bs-theme', APP.state.theme);
                    this.updateSettings();
                },
                toggleLineStyleControl() {
                    const wrapper = document.getElementById('line-style-control-wrapper');
                    wrapper.style.display = APP.dom.controls.chartType.value === 'line' ? 'block' : 'none';
                    this.updateSettings();
                },
                showNotification(message, type = 'primary') {
                    const toastHTML = `<div class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true"><div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div></div>`;
                    APP.dom.notificationContainer.insertAdjacentHTML('beforeend', toastHTML);
                    new bootstrap.Toast(APP.dom.notificationContainer.lastElementChild).show();
                },
                saveState() {
                    try {
                        const s = {
                            data: APP.state.data,
                            theme: APP.state.theme,
                            controls: {}
                        };
                        for (const k in APP.dom.controls) {
                            const e = APP.dom.controls[k];
                            if (e && e.id && typeof e.value !== 'undefined' && e.type !== 'file') s.controls[k] = e.value;
                        }
                        localStorage.setItem('alladinAppState', JSON.stringify(s));
                    } catch (e) {
                        console.warn("Could not save state.", e);
                    }
                },
                loadState() {
                    try {
                        const s = JSON.parse(localStorage.getItem('alladinAppState'));
                        if (s && s.data && s.data.values) {
                            APP.state.data = s.data;
                            APP.state.theme = s.theme || 'light';
                            APP.dom.html.setAttribute('data-bs-theme', APP.state.theme);
                            if (s.controls) {
                                for (const k in s.controls) {
                                    if (APP.dom.controls[k] && s.controls[k] !== undefined) APP.dom.controls[k].value = s.controls[k];
                                }
                            }
                            this.showNotification("Sess√£o anterior restaurada!");
                        } else {
                            this.generateRandomData();
                        }
                    } catch (e) {
                        this.generateRandomData();
                    }
                },
                handleFileUpload(e) {
                    const f = e.target.files[0];
                    if (!f) return;
                    const r = new FileReader();
                    r.onload = (event) => {
                        try {
                            const wb = XLSX.read(new Uint8Array(event.target.result), {
                                type: 'array'
                            });
                            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {
                                header: 1
                            });
                            if (json.length < 2) return this.showNotification('Planilha vazia ou inv√°lida.', 'danger');
                            const h = json[0],
                                body = json.slice(1);
                            APP.state.data = {
                                name: h[1] || 'S√©rie Importada',
                                labels: body.map(row => String(row[0])),
                                values: body.map(row => parseFloat(row[1]) || 0)
                            };
                            this.rebuildUI();
                            this.showNotification('Dados importados com sucesso!', 'success');
                        } catch (err) {
                            this.showNotification('Erro ao ler a planilha.', 'danger');
                        }
                    };
                    r.readAsArrayBuffer(f);
                },
                async exportToExcel() {
                    const wb = new ExcelJS.Workbook(),
                        ws = wb.addWorksheet('Relat√≥rio');
                    const img = APP.state.chart.getDataURL({
                        type: 'png',
                        pixelRatio: 3,
                        backgroundColor: APP.dom.controls.chartBgColor.value
                    });
                    const imgId = wb.addImage({
                        base64: img,
                        extension: 'png'
                    });
                    ws.addImage(imgId, 'A1:J20');
                    const startRow = 22,
                        data = APP.state.data;
                    ws.getCell(startRow, 1).value = "Ano";
                    ws.getCell(startRow, 2).value = data.name;
                    [1, 2].forEach(i => ws.getCell(startRow, i).font = {
                        bold: true,
                        size: 12
                    });
                    data.labels.forEach((l, i) => {
                        ws.getCell(startRow + 1 + i, 1).value = isNaN(l) ? l : Number(l);
                        ws.getCell(startRow + 1 + i, 2).value = data.values[i];
                    });
                    ws.getColumn(1).width = 20;
                    ws.getColumn(2).width = 20;
                    const buffer = await wb.xlsx.writeBuffer();
                    const title = APP.dom.controls.chartTitle.value.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                    saveAs(new Blob([buffer]), `Relatorio_AllaChart_${title}.xlsx`);
                },
                exportToPdf() {
                    this.showNotification('Gerando PDF de alta qualidade...', 'info');
                    try {
                        const chartImg = APP.state.chart.getDataURL({
                            type: 'png',
                            pixelRatio: 3,
                            backgroundColor: APP.dom.controls.chartBgColor.value
                        });
                        const chartWidth = APP.state.chart.getWidth();
                        const chartHeight = APP.state.chart.getHeight();
                        const orientation = chartWidth > chartHeight ? 'l' : 'p';
                        const pdf = new window.jspdf.jsPDF({
                            orientation: orientation,
                            unit: 'px',
                            format: [chartWidth, chartHeight]
                        });
                        pdf.addImage(chartImg, 'PNG', 0, 0, chartWidth, chartHeight);
                        const title = APP.dom.controls.chartTitle.value.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'grafico';
                        pdf.save(`Relatorio_AllaChart_${title}.pdf`);
                    } catch (error) {
                        console.error("Erro ao gerar PDF:", error);
                        this.showNotification('Ocorreu um erro ao gerar o PDF.', 'danger');
                    }
                },
                copyDesignCode() {
                    const c = APP.dom.controls;
                    const design = [c.chartType.value, c.chartTitle.value, c.titleFontSize.value, c.titleColor.value.substring(1), c.lineColor.value.substring(1), c.gridStyle.value, c.chartBgColor.value.substring(1), c.yGridLines.value, c.lineStyleSelect.value];
                    const designCode = design.join('|');
                    navigator.clipboard.writeText(designCode).then(() => this.showNotification('C√≥digo de Design copiado!', 'success')).catch(() => this.showNotification('Falha ao copiar o c√≥digo.', 'danger'));
                },
                applyDesignCode() {
                    this.showModal('Aplicar C√≥digo de Design', {
                        type: 'input',
                        placeholder: 'Cole o c√≥digo aqui'
                    }, (designCode) => {
                        if (!designCode) return;
                        try {
                            const parts = designCode.split('|');
                            const c = APP.dom.controls;
                            c.chartType.value = parts[0];
                            c.chartTitle.value = parts[1];
                            c.titleFontSize.value = parts[2];
                            c.titleColor.value = '#' + parts[3];
                            c.lineColor.value = '#' + parts[4];
                            c.gridStyle.value = parts[5];
                            c.chartBgColor.value = '#' + parts[6];
                            c.yGridLines.value = parts[7];
                            c.lineStyleSelect.value = parts[8];
                            this.rebuildUI();
                            this.toggleLineStyleControl();
                            this.showNotification('Design aplicado com sucesso!', 'success');
                        } catch (error) {
                            this.showNotification('C√≥digo de Design inv√°lido.', 'danger');
                        }
                    });
                },
                saveCurrentChart() {
                    this.showModal('Salvar Gr√°fico', {
                        type: 'input',
                        value: APP.dom.controls.chartTitle.value,
                        label: 'Nome do Gr√°fico:'
                    }, (chartName) => {
                        if (!chartName) return;
                        const savedCharts = JSON.parse(localStorage.getItem('alladinSavedCharts') || '[]');
                        const thumbnail = APP.state.chart.getDataURL({
                            type: 'png',
                            pixelRatio: 1,
                            backgroundColor: APP.dom.controls.chartBgColor.value
                        });
                        const snapshot = {
                            id: Date.now(),
                            name: chartName,
                            data: JSON.parse(JSON.stringify(APP.state.data)),
                            thumbnail: thumbnail,
                            controls: {}
                        };
                        for (const key in APP.dom.controls) {
                            const e = APP.dom.controls[key];
                            if (e && e.id && typeof e.value !== 'undefined' && e.type !== 'file') {
                                snapshot.controls[key] = e.value;
                            }
                        }
                        savedCharts.push(snapshot);
                        localStorage.setItem('alladinSavedCharts', JSON.stringify(savedCharts));
                        this.showNotification('Gr√°fico salvo com sucesso!', 'success');
                        this.renderSavedChartsList();
                    });
                },
                renderSavedChartsList() {
                    const container = APP.dom.controls.savedChartsList;
                    const savedCharts = JSON.parse(localStorage.getItem('alladinSavedCharts') || '[]');
                    container.innerHTML = '';
                    if (savedCharts.length === 0) {
                        container.innerHTML = '<p class="text-muted text-center small">Nenhum gr√°fico salvo.</p>';
                        return;
                    }
                    savedCharts.forEach(chart => {
                        const item = document.createElement('div');
                        item.className = 'saved-chart-item';
                        const thumbnailSrc = chart.thumbnail || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                        item.innerHTML = `
                            <div class="thumbnail-container"><img class="saved-chart-thumbnail" src="${thumbnailSrc}" alt="Pr√©via"></div>
                            <span class="saved-chart-name small" title="${chart.name}">${chart.name}</span>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary load-btn" title="Carregar">L</button>
                                <button class="btn btn-outline-danger delete-btn" title="Excluir">X</button>
                            </div>
                            ${chart.thumbnail ? `<div class="saved-chart-preview-pane"><img src="${chart.thumbnail}" alt="Pr√©via de ${chart.name}"></div>` : ''}
                        `;
                        item.querySelector('.load-btn').addEventListener('click', () => this.loadSavedChart(chart.id));
                        item.querySelector('.delete-btn').addEventListener('click', () => this.deleteSavedChart(chart.id));
                        container.appendChild(item);
                    });
                },
                loadSavedChart(chartId) {
                    const savedCharts = JSON.parse(localStorage.getItem('alladinSavedCharts') || '[]');
                    const chartToLoad = savedCharts.find(c => c.id === chartId);
                    if (!chartToLoad) {
                        this.showNotification('Gr√°fico n√£o encontrado.', 'danger');
                        return;
                    }
                    APP.state.data = chartToLoad.data;
                    for (const key in chartToLoad.controls) {
                        if (APP.dom.controls[key] && chartToLoad.controls[key] !== undefined) {
                            APP.dom.controls[key].value = chartToLoad.controls[key];
                        }
                    }
                    this.rebuildUI();
                    this.toggleLineStyleControl();
                    this.showNotification(`Gr√°fico "${chartToLoad.name}" carregado!`, 'success');
                },
                deleteSavedChart(chartId) {
                    this.showModal('Confirmar Exclus√£o', "Tem certeza que deseja excluir este gr√°fico salvo?", (confirmed) => {
                        if (!confirmed) return;
                        let savedCharts = JSON.parse(localStorage.getItem('alladinSavedCharts') || '[]');
                        savedCharts = savedCharts.filter(c => c.id !== chartId);
                        localStorage.setItem('alladinSavedCharts', JSON.stringify(savedCharts));
                        this.renderSavedChartsList();
                        this.showNotification('Gr√°fico exclu√≠do.', 'info');
                    }, {
                        confirmClass: 'btn-danger',
                        confirmText: 'Excluir'
                    });
                },
                resetToDefault() {
                    this.showModal('Reiniciar para o Padr√£o', "Tem certeza? O gr√°fico atual ser√° perdido e a interface reiniciada. Seus gr√°ficos salvos n√£o ser√£o afetados.", (confirmed) => {
                        if (confirmed) {
                            localStorage.removeItem('alladinAppState');
                            this.generateRandomData();
                            this.rebuildUI(false);
                            this.toggleLineStyleControl();
                            this.showNotification("Aplica√ß√£o reiniciada para o padr√£o.", "info");
                        }
                    }, {
                        confirmClass: 'btn-warning',
                        confirmText: 'Reiniciar'
                    });
                },
                showModal(title, bodyContent, callback, options = {}) {
                    const {
                        confirmText = 'Confirmar',
                        cancelText = 'Cancelar',
                        confirmClass = 'btn-primary',
                        confirmAction = true,
                        cancelAction = false
                    } = options;
                    const M = APP.dom.modal;
                    M.title.textContent = title;
                    M.body.innerHTML = '';
                    let inputElement = null;
                    if (typeof bodyContent === 'string') {
                        M.body.textContent = bodyContent;
                    } else if (typeof bodyContent === 'object' && bodyContent.type === 'input') {
                        if (bodyContent.label) {
                            const label = document.createElement('label');
                            label.className = 'form-label';
                            label.textContent = bodyContent.label;
                            M.body.appendChild(label);
                        }
                        inputElement = document.createElement('input');
                        inputElement.className = 'form-control';
                        inputElement.type = bodyContent.inputType || 'text';
                        inputElement.value = bodyContent.value || '';
                        inputElement.placeholder = bodyContent.placeholder || '';
                        M.body.appendChild(inputElement);
                    }
                    M.confirmBtn.textContent = confirmText;
                    M.confirmBtn.className = `btn ${confirmClass}`;
                    M.el.querySelector('.modal-footer .btn-secondary').textContent = cancelText;
                    const handleConfirm = () => {
                        const value = inputElement ? inputElement.value : confirmAction;
                        callback(value);
                        APP.state.modal.hide();
                        cleanup();
                    };
                    const handleCancel = () => {
                        callback(cancelAction);
                        cleanup();
                    }
                    const cleanup = () => {
                        M.confirmBtn.removeEventListener('click', handleConfirm);
                        M.el.removeEventListener('hidden.bs.modal', handleCancel);
                    }
                    M.confirmBtn.addEventListener('click', handleConfirm);
                    M.el.addEventListener('hidden.bs.modal', handleCancel, {
                        once: true
                    });
                    APP.state.modal.show();
                    if (inputElement) {
                        setTimeout(() => inputElement.focus(), 500);
                    }
                },
                AI_ASSISTANT: {
                    history: [],
                    init() {
                        const controls = APP.dom.controls;
                        controls.aiChatFab.addEventListener('click', () => APP.state.aiChatModal.show());
                        controls.openChatFromSidebar.addEventListener('click', () => APP.state.aiChatModal.show());
                        controls.aiChatSendBtn.addEventListener('click', () => this.handleUserInput());
                        controls.aiChatInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                this.handleUserInput();
                            }
                        });
                    },
                    addMessage(text, sender, isToolMessage = false) {
                        const messageContainer = APP.dom.controls.aiChatMessages;
                        const messageDiv = document.createElement('div');
                        const messageClass = isToolMessage ? 'tool' : sender;
                        messageDiv.className = `chat-message ${messageClass}`;
                        
                        if (isToolMessage) {
                            messageDiv.innerHTML = `üßû Executando a√ß√£o: <strong>${text}</strong>...`;
                        } else {
                            messageDiv.innerHTML = sender === 'ai' ? marked.parse(text) : text;
                        }

                        messageContainer.appendChild(messageDiv);
                        messageContainer.scrollTop = messageContainer.scrollHeight;
                    },
                    showTyping(show) {
                        APP.dom.controls.aiTypingIndicator.style.display = show ? 'block' : 'none';
                        if (show) APP.dom.controls.aiChatMessages.scrollTop = APP.dom.controls.aiChatMessages.scrollHeight;
                    },
                    async handleUserInput() {
                        const input = APP.dom.controls.aiChatInput;
                        const userMessage = input.value.trim();
                        if (!userMessage) return;
                        this.addMessage(userMessage, 'user');
                        input.value = '';
                        this.showTyping(true);
                        try {
                            const aiResponse = await this.callBackend(userMessage);
                            this.showTyping(false);
                            if (aiResponse.toolCall) {
                                this.handleToolCall(aiResponse.toolCall);
                            } else if (aiResponse.text) {
                                this.addMessage(aiResponse.text, 'ai');
                            }
                        } catch (error) {
                            console.error('Erro ao chamar o backend:', error);
                            this.showTyping(false);
                            this.addMessage('Desculpe, n√£o consegui me conectar com meu g√™nio interior. Verifique se a chave de API est√° configurada corretamente e tente novamente.', 'ai');
                        }
                    },
                    async callBackend(prompt) {
                        this.history.push({
                            role: 'user',
                            parts: [{
                                text: prompt
                            }]
                        });
                        const response = await fetch('/api/chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                history: this.history
                            })
                        });
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        const aiResponsePart = data.toolCall ? { functionCall: data.toolCall } : { text: data.text };
                        this.history.push({
                            role: 'model',
                            parts: [aiResponsePart]
                        });
                        return data;
                    },
                    handleToolCall(toolCall) {
                        const { name, args } = toolCall;
                        this.addMessage(name, 'ai', true);
                        let success = false;
                        switch (name) {
                            case 'generateRandomChart':
                                APP.methods.generateRandomData();
                                APP.methods.rebuildUI();
                                success = true;
                                break;
                            case 'changeChartColor':
                                if (args.color) {
                                    APP.dom.controls.lineColor.value = args.color;
                                    APP.methods.updateSettings();
                                    success = true;
                                }
                                break;
                            case 'setChartData':
                                if (args.labels && args.values && args.labels.length === args.values.length) {
                                    APP.state.data.labels = args.labels.map(String);
                                    APP.state.data.values = args.values.map(Number);
                                    APP.methods.rebuildUI();
                                    success = true;
                                }
                                break;
                        }
                        this.history.push({
                            role: 'function',
                            parts: [{
                                functionResponse: {
                                    name,
                                    response: {
                                        success,
                                        message: `Ferramenta '${name}' executada. Sucesso: ${success}`
                                    }
                                }
                            }]
                        });
                        this.getFollowUpResponse();
                    },
                    async getFollowUpResponse() {
                        this.showTyping(true);
                        try {
                            const response = await fetch('/api/chat', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    history: this.history
                                })
                            });
                            if (!response.ok) throw new Error('Falha na chamada de follow-up');
                            const data = await response.json();
                            this.showTyping(false);
                            if (data.text) {
                                this.addMessage(data.text, 'ai');
                                this.history.push({
                                    role: 'model',
                                    parts: [{
                                        text: data.text
                                    }]
                                });
                            }
                        } catch (error) {
                            this.showTyping(false);
                            console.error("Erro no follow-up:", error);
                        }
                    }
                }
            }
        };
        APP.methods.init();
    });
    </script>
</body>
</html>