<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A.L.L.A.D.I.N. 7.4 - Versão Final</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Poppins:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bs-body-font-family: 'Inter', sans-serif;
            --bs-body-bg: #f8f9fa;
        }
        [data-bs-theme="dark"] {
            --bs-body-bg: #1a1a1a;
        }
        
        /* --- INTRO ANIMATION --- */
        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #121212; z-index: 10000; display: flex;
            align-items: center; justify-content: center; transition: opacity 0.8s ease-in-out;
            pointer-events: none;
        }
        #intro-title { font-family: 'Poppins', sans-serif; font-size: clamp(2rem, 10vw, 5rem); font-weight: 700; color: #fff; }
        #intro-title .letter { display: inline-block; opacity: 0; transform: translateY(20px); animation: letterFadeIn 0.6s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        @keyframes letterFadeIn { to { opacity: 1; transform: translateY(0); } }

        /* --- MAIN APP STYLES --- */
        .app-container { 
            opacity: 0; 
            transition: opacity 0.5s ease-in; 
            min-width: 1400px;
        }
        .app-container.visible { opacity: 1; }
        .navbar-brand h1 { font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 1.5rem; margin: 0; }
        #sidebar { position: sticky; top: 60px; height: calc(100vh - 60px); overflow-y: auto; background-color: var(--bs-body-tertiary); display: flex; flex-direction: column; }
        .accordion { flex-grow: 1; }
        .accordion-button { font-weight: 500; font-size: 0.95rem; }
        .accordion-button:not(.collapsed) { background-color: rgba(var(--bs-primary-rgb), 0.1); }
        .accordion-body label { font-size: 0.8rem; font-weight: 500; color: var(--bs-secondary-color); }
        #data-input-container { display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto; margin-bottom: 1rem; }
        .data-input-row { display: flex; align-items: center; gap: 0.5rem; border-radius: 0.25rem; }
        .data-input-row .year-controls { display: flex; flex-direction: column; }
        .data-input-row .add-year-btn { 
            display: none;
            cursor: pointer; line-height: 1; font-size: 0.8rem; 
            padding: 0.1rem 0.3rem;
        }
        .data-input-row:hover .add-year-btn { display: inline-block; }
        .data-input-row label { flex-grow: 1; text-align: right; }
        
        #main-content { flex-grow: 1; padding: 1.5rem; }
        #chart-container { width: 100%; height: 75vh; min-height: 550px; background-color: var(--bs-body-tertiary); border-radius: 0.375rem; box-shadow: var(--bs-box-shadow-sm); padding: 1rem; transition: background-color 0.3s, border-color 0.3s;}
        #notification-container { z-index: 1100; }
        .saved-chart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid var(--bs-border-color);
        }
        /* Custom Context Menu */
        #custom-context-menu {
            position: absolute;
            z-index: 10001;
            background-color: var(--bs-body-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 0.375rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15);
            padding: 0.5rem 0;
            min-width: 150px;
        }
        .context-menu-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .context-menu-item:hover {
            background-color: var(--bs-primary-bg-subtle);
        }
        .context-menu-item.delete {
            color: var(--bs-danger);
        }
    </style>
</head>
<body>
    <div id="intro-overlay"><h1 id="intro-title"></h1></div>

    <div class="app-container">
        <!-- Navbar -->
        <nav class="navbar bg-body-tertiary border-bottom sticky-top">
            <div class="container-fluid">
                <a class="navbar-brand d-flex align-items-center" href="#"><svg class="me-2" style="width: 2rem; height: 2rem; fill: currentColor;" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g><circle cx="50" cy="25" r="15"/><circle cx="38" cy="40" r="12"/><circle cx="62" cy="40" r="12"/><path d="M 35,55 A 20,20 0 0,1 65,55 L 70,80 A 10,10 0 0,1 60,90 L 40,90 A 10,10 0 0,1 30,80 Z"/><circle cx="75" cy="55" r="5"/></g></svg><h1>A.L.L.A.D.I.N.</h1></a>
                <button class="btn border-0" id="theme-toggle" title="Alternar Tema"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"/></svg></button>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <aside id="sidebar" class="col-lg-3 p-3">
                    <div class="accordion" id="settingsAccordion">
                        <!-- Seção Seus Gráficos -->
                        <div class="accordion-item">
                            <h2 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSavedCharts">Seus Gráficos</button></h2>
                            <div id="collapseSavedCharts" class="accordion-collapse collapse show" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body">
                                    <div class="d-grid gap-2 mb-3">
                                        <button id="save-chart-btn" class="btn btn-success">Salvar Gráfico Atual</button>
                                    </div>
                                    <div id="saved-charts-list"></div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseData">Editor de Dados</button></h2>
                            <div id="collapseData" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <button id="rename-series-btn" class="btn btn-sm btn-outline-secondary">Renomear Série</button>
                                    </div>
                                    <div id="data-input-container"></div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseChart">Configurações do Gráfico</button></h2>
                            <div id="collapseChart" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body">
                                    <label for="chart-title" class="form-label">Título</label><input type="text" id="chart-title" class="form-control form-control-sm mb-2">
                                    <label for="chart-type" class="form-label">Tipo de Gráfico</label><select id="chart-type" class="form-select form-select-sm mb-2"><option value="line">Linha</option><option value="bar">Barras</option><option value="pie">Pizza</option><option value="scatter">Dispersão</option></select>
                                    <div id="line-style-control-wrapper" class="mb-2"><label for="line-style-select" class="form-label">Estilo da Linha</label><select id="line-style-select" class="form-select form-select-sm"><option value="true">Arredondadas</option><option value="false">Retas</option></select></div>
                                    <div class="row"><div class="col"><label class="form-label">Cor da Série</label><input type="color" id="line-color" class="form-control form-control-color w-100"></div><div class="col"><label class="form-label">Fundo</label><input type="color" id="chart-bg-color" class="form-control form-control-color w-100"></div></div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAxes">Eixos e Detalhes</button></h2>
                            <div id="collapseAxes" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body">
                                    <div class="row mb-2">
                                        <div class="col"><label class="form-label">Nº de Linhas Horizontais (Y)</label><select id="y-grid-lines" class="form-select form-select-sm"><option>Auto</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div>
                                    </div>
                                    <label for="grid-style" class="form-label">Estilo da Grade</label><select id="grid-style" class="form-select form-select-sm mb-2"><option value="dotted">Pontilhada</option><option value="solid">Sólida</option><option value="dashed">Tracejada</option><option value="none">Nenhuma</option></select>
                                    <div class="row"><div class="col"><label class="form-label">Tam. Fonte</label><input type="number" id="title-font-size" class="form-control form-control-sm" min="10"></div><div class="col"><label class="form-label">Cor Fonte</label><input type="color" id="title-color" class="form-control form-control-color w-100"></div></div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFile">Arquivo</button></h2>
                            <div id="collapseFile" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body">
                                    <div class="d-grid gap-2">
                                        <button id="import-btn" class="btn btn-outline-secondary">Importar Planilha</button>
                                        <button id="export-excel" class="btn btn-primary mb-2">Exportar para Excel</button>
                                        <hr>
                                        <button id="copy-design-code-btn" class="btn btn-sm btn-outline-info">Copiar Código de Design</button>
                                        <button id="apply-design-code-btn" class="btn btn-sm btn-info">Aplicar Código de Design</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-grid mt-3">
                        <button id="reset-to-default-btn" class="btn btn-warning">Reiniciar para o Padrão</button>
                    </div>
                </aside>
                <!-- Main Content -->
                <main class="col-lg-9 p-4"><div id="chart-container" class="w-100 h-100"></div></main>
            </div>
        </div>
    </div>
    
    <!-- Notifications -->
    <div id="notification-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const introOverlay = document.getElementById('intro-overlay'), introTitle = document.getElementById('intro-title'), appContainer = document.querySelector('.app-container'), titleText = "A.L.L.A.D.I.N.";
        titleText.split('').forEach((char, i) => { const s = document.createElement('span'); s.className = 'letter'; s.textContent = char; s.style.animationDelay = `${i * 0.1}s`; introTitle.appendChild(s); });
        setTimeout(() => { introOverlay.style.opacity = '0'; appContainer.classList.add('visible'); introOverlay.addEventListener('transitionend', () => introOverlay.style.display = 'none'); }, 2500);

        const APP = {
            state: { chart: null, data: {}, theme: 'light' },
            dom: {
                html: document.documentElement, chartContainer: document.getElementById('chart-container'), notificationContainer: document.getElementById('notification-container'),
                controls: {
                    importBtn: document.getElementById('import-btn'), 
                    chartType: document.getElementById('chart-type'), chartTitle: document.getElementById('chart-title'), 
                    titleFontSize: document.getElementById('title-font-size'), titleColor: document.getElementById('title-color'),
                    lineColor: document.getElementById('line-color'), gridStyle: document.getElementById('grid-style'), 
                    chartBgColor: document.getElementById('chart-bg-color'), yGridLines: document.getElementById('y-grid-lines'),
                    lineStyleSelect: document.getElementById('line-style-select'),
                    exportExcelBtn: document.getElementById('export-excel'), themeToggle: document.getElementById('theme-toggle'), 
                    dataInputContainer: document.getElementById('data-input-container'), renameSeriesBtn: document.getElementById('rename-series-btn'), 
                    copyDesignCodeBtn: document.getElementById('copy-design-code-btn'),
                    applyDesignCodeBtn: document.getElementById('apply-design-code-btn'),
                    saveChartBtn: document.getElementById('save-chart-btn'),
                    savedChartsList: document.getElementById('saved-charts-list'),
                    resetToDefaultBtn: document.getElementById('reset-to-default-btn'),
                }
            },
            methods: {
                init() {
                    this.loadState();
                    APP.state.chart = echarts.init(APP.dom.chartContainer, APP.state.theme === 'dark' ? 'dark' : null);
                    this.bindEventListeners();
                    this.rebuildUI(false);
                    this.renderSavedChartsList();
                    this.toggleLineStyleControl();
                },
                updateSettings(save = true) { this.updateChart(); if (save) this.saveState(); },
                rebuildUI(save = true) { this.renderDataEditorForm(); this.updateChart(); if (save) this.saveState();},
                bindEventListeners() {
                    for (const key in APP.dom.controls) {
                        const control = APP.dom.controls[key];
                        if (control && !control.id.includes('Btn') && control.id !== 'data-input-container' && control.id !== 'saved-charts-list') {
                            const eventType = (control.type === 'color' || control.type === 'number' || control.id === 'lineStyleSelect') ? 'change' : 'input';
                            control.addEventListener(eventType, () => this.updateSettings());
                        }
                    }
                    APP.dom.controls.chartType.addEventListener('change', () => this.toggleLineStyleControl());
                    APP.dom.controls.themeToggle.addEventListener('click', () => this.toggleTheme());
                    APP.dom.controls.importBtn.addEventListener('click', () => { const u = document.createElement('input'); u.type = 'file'; u.accept = '.xlsx,.csv'; u.onchange = (e) => this.handleFileUpload(e); u.click(); });
                    APP.dom.controls.exportExcelBtn.addEventListener('click', () => this.exportToExcel());
                    APP.dom.controls.renameSeriesBtn.addEventListener('click', () => this.renameSeries());
                    APP.dom.controls.copyDesignCodeBtn.addEventListener('click', () => this.copyDesignCode());
                    APP.dom.controls.applyDesignCodeBtn.addEventListener('click', () => this.applyDesignCode());
                    APP.dom.controls.saveChartBtn.addEventListener('click', () => this.saveCurrentChart());
                    APP.dom.controls.resetToDefaultBtn.addEventListener('click', () => this.resetToDefault());
                    window.addEventListener('click', () => this.hideContextMenu());
                },
                renderDataEditorForm() {
                    const container = APP.dom.controls.dataInputContainer;
                    container.innerHTML = '';
                    if (!APP.state.data || !APP.state.data.values) return;

                    APP.state.data.values.forEach((value, index) => {
                        const row = document.createElement('div');
                        row.className = 'data-input-row';
                        row.addEventListener('contextmenu', (e) => { e.preventDefault(); this.showContextMenu(e.clientX, e.clientY, index); });

                        const controls = document.createElement('div');
                        controls.className = 'year-controls';

                        const addBeforeBtn = document.createElement('button');
                        addBeforeBtn.textContent = '+';
                        addBeforeBtn.className = 'btn btn-sm btn-outline-info add-year-btn';
                        addBeforeBtn.title = 'Adicionar ano anterior';
                        addBeforeBtn.onclick = (e) => { e.stopPropagation(); this.addYear(index, true); };
                        
                        const addAfterBtn = document.createElement('button');
                        addAfterBtn.textContent = '+';
                        addAfterBtn.className = 'btn btn-sm btn-outline-info add-year-btn mt-1';
                        addAfterBtn.title = 'Adicionar ano seguinte';
                        addAfterBtn.onclick = (e) => { e.stopPropagation(); this.addYear(index, false); };

                        controls.appendChild(addBeforeBtn);
                        controls.appendChild(addAfterBtn);

                        const label = document.createElement('label');
                        label.textContent = APP.state.data.labels[index] || `Ponto ${index + 1}`;
                        label.className = 'form-label mb-0';

                        const input = document.createElement('input');
                        input.type = 'number';
                        input.value = value;
                        input.className = 'form-control form-control-sm';
                        
                        const commitChange = () => {
                            const newValue = parseFloat(input.value);
                            if (!isNaN(newValue)) {
                                if (APP.state.data.values[index] !== newValue) { APP.state.data.values[index] = newValue; this.updateChart(); this.saveState(); }
                            } else { input.value = APP.state.data.values[index];}
                        };
                        input.addEventListener('blur', commitChange);
                        input.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); input.blur(); } });

                        row.appendChild(controls);
                        row.appendChild(label);
                        row.appendChild(input);
                        container.appendChild(row);
                    });
                },
                addYear(index, before) {
                    const labels = APP.state.data.labels;
                    const values = APP.state.data.values;
                    const referenceYear = parseInt(labels[index], 10);
                    if (isNaN(referenceYear)) { this.showNotification("Não é possível adicionar ano a partir de um rótulo de texto.", "warning"); return; }
                    const newYear = before ? referenceYear - 1 : referenceYear + 1;
                    const insertIndex = before ? index : index + 1;
                    labels.splice(insertIndex, 0, String(newYear));
                    values.splice(insertIndex, 0, 0);
                    this.rebuildUI();
                },
                deleteYear(index) {
                    if (confirm(`Tem certeza que deseja excluir o ano "${APP.state.data.labels[index]}"?`)) {
                        APP.state.data.labels.splice(index, 1);
                        APP.state.data.values.splice(index, 1);
                        this.rebuildUI();
                        this.showNotification("Ano excluído.", "info");
                    }
                },
                showContextMenu(x, y, index) {
                    this.hideContextMenu(); 
                    const menu = document.createElement('div');
                    menu.id = 'custom-context-menu';
                    menu.style.top = `${y}px`;
                    menu.style.left = `${x}px`;
                    const deleteItem = document.createElement('div');
                    deleteItem.className = 'context-menu-item delete';
                    deleteItem.textContent = 'Excluir Ano';
                    deleteItem.onclick = () => { this.deleteYear(index); };
                    menu.appendChild(deleteItem);
                    document.body.appendChild(menu);
                },
                hideContextMenu() { const menu = document.getElementById('custom-context-menu'); if (menu) { menu.remove(); } },
                renameSeries() { const newName = prompt("Digite o novo nome para a série:", APP.state.data.name); if (newName && newName !== APP.state.data.name) { APP.state.data.name = newName; this.updateSettings(); } },
                generateRandomData() {
                    const pointCount = 7, startYear = new Date().getFullYear() - pointCount;
                    const labels = Array.from({length: pointCount}, (_, i) => (startYear + i + 1).toString());
                    const values = Array.from({length: pointCount}, () => Math.floor(Math.random() * 250) + 150);
                    APP.state.data = { name: 'Total de Servidores', labels, values };
                    const c = APP.dom.controls;
                    c.chartTitle.value = 'Evolução Anual de Servidores'; c.titleColor.value = '#343a40'; c.lineColor.value = '#0d6efd'; c.chartBgColor.value = '#ffffff'; c.titleFontSize.value = 20; c.gridStyle.value = 'dotted'; c.lineStyleSelect.value = 'true';
                },
                getChartOptions() {
                    const c = APP.dom.controls, isDark = APP.state.theme === 'dark';
                    const gridColor = isDark ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)';
                    const textColor = isDark ? '#ccc' : '#666'; const titleColor = c.titleColor.value;
                    const gridStyle = c.gridStyle.value; const showGrid = gridStyle !== 'none';
                    let yAxisSplit = { show: showGrid, lineStyle: { type: gridStyle, color: gridColor } };
                    const ySplitNum = c.yGridLines.value; if (ySplitNum !== 'Auto') yAxisSplit.splitNumber = parseInt(ySplitNum, 10);
                    let xAxisSplit = { show: showGrid, lineStyle: { type: gridStyle, color: gridColor } };
                    APP.dom.chartContainer.style.backgroundColor = c.chartBgColor.value;
                    const chartType = c.chartType.value; let series = [];
                    const isSmooth = c.lineStyleSelect.value === 'true';

                    if (chartType === 'pie') {
                        series.push({ name: APP.state.data.name, type: 'pie', radius: '60%', center: ['50%', '55%'], data: APP.state.data.labels.map((l, i) => ({ value: APP.state.data.values[i], name: l })), itemStyle: { borderRadius: 5, borderColor: c.chartBgColor.value, borderWidth: 2, shadowBlur: 10, shadowOffsetX: 0, shadowOffsetY: 5, shadowColor: 'rgba(0, 0, 0, 0.1)' }, label: { color: textColor } });
                    } else {
                        series.push({ name: APP.state.data.name, type: chartType, data: APP.state.data.values, smooth: isSmooth, symbolSize: 8, lineStyle: { color: c.lineColor.value, width: 3, shadowBlur: 10, shadowOffsetX: 0, shadowOffsetY: 5, shadowColor: 'rgba(0, 0, 0, 0.2)' }, itemStyle: { color: c.lineColor.value }, label: { show: true, position: 'top', color: titleColor, fontWeight: 'bold' } });
                    }
                    return { backgroundColor: 'transparent', title: { text: c.chartTitle.value, left: 'center', textStyle: { color: titleColor, fontSize: parseInt(c.titleFontSize.value, 10), fontWeight: 'bold' } }, tooltip: { trigger: 'axis' }, grid: { left: '8%', right: '4%', top: '15%', bottom: '5%', containLabel: true }, toolbox: { feature: { dataView: { readOnly: false }, magicType: { type: ['line', 'bar'] }, restore: {}, saveAsImage: { backgroundColor: c.chartBgColor.value } } }, xAxis: { type: 'category', data: APP.state.data.labels, name: "Anos", nameLocation: 'middle', nameGap: 30, nameTextStyle: { color: titleColor, fontSize: 13, fontWeight: 'bold' }, splitLine: xAxisSplit, axisLine: { lineStyle: { color: gridColor }}, axisLabel: { color: textColor } }, yAxis: { type: 'value', name: APP.state.data.name, nameLocation: 'middle', nameGap: 55, nameTextStyle: { color: titleColor, fontSize: 13, fontWeight: 'bold' }, splitLine: yAxisSplit, axisLine: { lineStyle: { color: gridColor }}, axisLabel: { color: textColor } }, series };
                },
                updateChart() { if (APP.state.chart) APP.state.chart.setOption(this.getChartOptions(), true); },
                toggleTheme() { APP.state.theme = APP.state.theme === 'light' ? 'dark' : 'light'; APP.dom.html.setAttribute('data-bs-theme', APP.state.theme); if (APP.state.chart) { APP.state.chart.dispose(); APP.state.chart = echarts.init(APP.dom.chartContainer, APP.state.theme === 'dark' ? 'dark' : null); } this.rebuildUI(); },
                toggleLineStyleControl() {
                    const wrapper = document.getElementById('line-style-control-wrapper');
                    wrapper.style.display = APP.dom.controls.chartType.value === 'line' ? 'block' : 'none';
                },
                showNotification(message, type = 'primary') { const toastHTML = `<div class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true"><div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div></div>`; APP.dom.notificationContainer.insertAdjacentHTML('beforeend', toastHTML); new bootstrap.Toast(APP.dom.notificationContainer.lastElementChild).show();},
                saveState() { try { const s = { data: APP.state.data, theme: APP.state.theme, controls: {} }; for (const k in APP.dom.controls) { const e = APP.dom.controls[k]; if (e && e.id && typeof e.value !== 'undefined' && e.type !== 'file') s.controls[k] = e.value; } localStorage.setItem('alladinAppState', JSON.stringify(s)); } catch (e) { console.warn("Could not save state.", e); } },
                loadState() { try { const s = JSON.parse(localStorage.getItem('alladinAppState')); if (s && s.data && s.data.values) { APP.state.data = s.data; APP.state.theme = s.theme || 'light'; APP.dom.html.setAttribute('data-bs-theme', APP.state.theme); if (s.controls) { for (const k in s.controls) { if (APP.dom.controls[k] && s.controls[k] !== undefined) APP.dom.controls[k].value = s.controls[k]; } } this.showNotification("Sessão anterior restaurada!"); } else { this.generateRandomData(); } } catch (e) { this.generateRandomData(); } },
                handleFileUpload(e) { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = (event) => { try { const wb = XLSX.read(new Uint8Array(event.target.result), { type: 'array' }); const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 }); if (json.length < 2) return this.showNotification('Planilha vazia ou inválida.', 'danger'); const h = json[0], body = json.slice(1); APP.state.data = { name: h[1] || 'Série Importada', labels: body.map(row => String(row[0])), values: body.map(row => parseFloat(row[1]) || 0) }; this.rebuildUI(); this.showNotification('Dados importados com sucesso!', 'success');} catch(err){this.showNotification('Erro ao ler a planilha.', 'danger');}}; r.readAsArrayBuffer(f);},
                async exportToExcel() { const wb = new ExcelJS.Workbook(), ws = wb.addWorksheet('Relatório'); const img = APP.state.chart.getDataURL({ type: 'png', pixelRatio: 3, backgroundColor: '#FFFFFF' }); const imgId = wb.addImage({ base64: img, extension: 'png' }); ws.addImage(imgId, 'A1:J20'); const startRow = 22, data = APP.state.data; ws.getCell(startRow, 1).value = "Ano"; ws.getCell(startRow, 2).value = data.name; [1, 2].forEach(i => ws.getCell(startRow, i).font = { bold: true, size: 12 }); data.labels.forEach((l, i) => { ws.getCell(startRow + 1 + i, 1).value = isNaN(l) ? l : Number(l); ws.getCell(startRow + 1 + i, 2).value = data.values[i]; }); ws.getColumn(1).width = 20; ws.getColumn(2).width = 20; const buffer = await wb.xlsx.writeBuffer(); const title = APP.dom.controls.chartTitle.value.replace(/[^a-z0-9]/gi, '_').toLowerCase(); saveAs(new Blob([buffer]), `Relatorio_ALLADIN_${title}.xlsx`); },
                copyDesignCode() {
                    const c = APP.dom.controls;
                    const design = [c.chartType.value, c.chartTitle.value, c.titleFontSize.value, c.titleColor.value.substring(1), c.lineColor.value.substring(1), c.gridStyle.value, c.chartBgColor.value.substring(1), c.yGridLines.value, c.lineStyleSelect.value];
                    const designCode = design.join('|');
                    navigator.clipboard.writeText(designCode).then(() => this.showNotification('Código de Design copiado!', 'success')).catch(() => this.showNotification('Falha ao copiar o código.', 'danger'));
                },
                applyDesignCode() {
                    const designCode = prompt("Cole o Código de Design aqui:");
                    if (!designCode) return;
                    try {
                        const parts = designCode.split('|');
                        const c = APP.dom.controls;
                        c.chartType.value = parts[0]; c.chartTitle.value = parts[1]; c.titleFontSize.value = parts[2]; c.titleColor.value = '#' + parts[3]; c.lineColor.value = '#' + parts[4]; c.gridStyle.value = parts[5]; c.chartBgColor.value = '#' + parts[6]; c.yGridLines.value = parts[7]; c.lineStyleSelect.value = parts[8];
                        this.rebuildUI(); this.toggleLineStyleControl();
                        this.showNotification('Design aplicado com sucesso!', 'success');
                    } catch (error) { this.showNotification('Código de Design inválido.', 'danger'); }
                },
                saveCurrentChart() {
                    const chartName = prompt("Digite um nome para este gráfico:", APP.dom.controls.chartTitle.value);
                    if (!chartName) return;
                    const savedCharts = JSON.parse(localStorage.getItem('alladinSavedCharts') || '[]');
                    const snapshot = { id: Date.now(), name: chartName, data: JSON.parse(JSON.stringify(APP.state.data)), controls: {} };
                    for (const key in APP.dom.controls) { const e = APP.dom.controls[key]; if (e && e.id && typeof e.value !== 'undefined' && e.type !== 'file') { snapshot.controls[key] = e.value; } }
                    savedCharts.push(snapshot);
                    localStorage.setItem('alladinSavedCharts', JSON.stringify(savedCharts));
                    this.showNotification('Gráfico salvo com sucesso!', 'success');
                    this.renderSavedChartsList();
                },
                renderSavedChartsList() {
                    const container = APP.dom.controls.savedChartsList;
                    const savedCharts = JSON.parse(localStorage.getItem('alladinSavedCharts') || '[]');
                    container.innerHTML = '';
                    if (savedCharts.length === 0) { container.innerHTML = '<p class="text-muted text-center small">Nenhum gráfico salvo.</p>'; return; }
                    savedCharts.forEach(chart => {
                        const item = document.createElement('div');
                        item.className = 'saved-chart-item';
                        item.innerHTML = `<span class="small">${chart.name}</span><div class="btn-group btn-group-sm"><button class="btn btn-outline-primary load-btn" title="Carregar">L</button><button class="btn btn-outline-danger delete-btn" title="Excluir">X</button></div>`;
                        item.querySelector('.load-btn').addEventListener('click', () => this.loadSavedChart(chart.id));
                        item.querySelector('.delete-btn').addEventListener('click', () => this.deleteSavedChart(chart.id));
                        container.appendChild(item);
                    });
                },
                loadSavedChart(chartId) {
                    const savedCharts = JSON.parse(localStorage.getItem('alladinSavedCharts') || '[]');
                    const chartToLoad = savedCharts.find(c => c.id === chartId);
                    if (!chartToLoad) { this.showNotification('Gráfico não encontrado.', 'danger'); return; }
                    APP.state.data = chartToLoad.data;
                    for (const key in chartToLoad.controls) { if (APP.dom.controls[key]) { APP.dom.controls[key].value = chartToLoad.controls[key]; } }
                    this.rebuildUI(); this.toggleLineStyleControl();
                    this.showNotification(`Gráfico "${chartToLoad.name}" carregado!`, 'success');
                },
                deleteSavedChart(chartId) {
                    if (!confirm("Tem certeza que deseja excluir este gráfico salvo?")) return;
                    let savedCharts = JSON.parse(localStorage.getItem('alladinSavedCharts') || '[]');
                    savedCharts = savedCharts.filter(c => c.id !== chartId);
                    localStorage.setItem('alladinSavedCharts', JSON.stringify(savedCharts));
                    this.renderSavedChartsList();
                    this.showNotification('Gráfico excluído.', 'info');
                },
                resetToDefault() {
                    if (confirm("Tem certeza? Todas as alterações e gráficos salvos serão perdidos.")) {
                        localStorage.removeItem('alladinAppState');
                        localStorage.removeItem('alladinSavedCharts');
                        this.generateRandomData();
                        this.rebuildUI(false);
                        this.renderSavedChartsList();
                        this.toggleLineStyleControl();
                        this.showNotification("Aplicação reiniciada para o padrão.", "info");
                    }
                }
            }
        };
        APP.methods.init();
    });
    </script>
</body>
</html>
