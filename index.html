<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AllaChart游냤</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Poppins:wght@700&family=Share+Tech+Mono&display=swap"
        rel="stylesheet">

    <script src="/_vercel/speed-insights/script.js" defer></script>
    <script>
        window.va = window.va || function () { (window.va.q = window.va.q || []).push(arguments); };
    </script>
    <script src="/_vercel/insights/script.js" defer></script>

    <style>
        :root {
            --bs-body-font-family: 'Inter', sans-serif;
            /* Light Theme Colors */
            --bs-light-bg: #f8f9fa;
            --bs-light-text: #212529;
            --bs-light-primary: #6f42c1;

            /* Dark Purple Theme Colors */
            --dark-purple-bg: #16141c;
            --dark-purple-surface: #201d2b;
            --dark-purple-primary: #9f75ff;
            --dark-purple-secondary: #87868b;
            --dark-purple-text: #ffffff;
            --dark-purple-border: #363247;
        }

        [data-bs-theme="light"] {
            --bs-body-bg: var(--bs-light-bg);
            --bs-body-color: var(--bs-light-text);
            --bs-primary: var(--bs-light-primary);
            --bs-primary-rgb: 111, 66, 193;
            --bs-body-tertiary-bg: #e9ecef;
            --bs-border-color: #dee2e6;
        }

        [data-bs-theme="dark"] {
            --bs-body-bg: var(--dark-purple-bg);
            --bs-body-color: var(--dark-purple-text);
            --bs-primary: var(--dark-purple-primary);
            --bs-primary-rgb: 159, 117, 255;
            --bs-body-tertiary-bg: var(--dark-purple-surface);
            --bs-tertiary-bg: var(--dark-purple-surface);
            --bs-border-color: var(--dark-purple-border);
            --bs-secondary-color: var(--dark-purple-secondary);
            --bs-primary-bg-subtle: rgba(159, 117, 255, 0.15);
            --bs-secondary-bg-subtle: rgba(135, 134, 139, 0.15);
        }

        /* --- INTRO ANIMATION --- */
        #intro-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1A1D2D;
            z-index: 10000;
            transition: opacity 0.8s ease-in-out;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #intro-animation-container {
            position: relative;
            width: clamp(300px, 60vw, 600px);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #intro-graph {
            width: 100%;
            filter: drop-shadow(0 0 10px rgba(159, 117, 255, 0.7));
        }

        #intro-graph path {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: draw 1.8s ease-in-out forwards;
            stroke: var(--dark-purple-primary);
        }

        @keyframes draw {
            to {
                stroke-dashoffset: 0;
            }
        }

        #intro-title {
            font-family: 'Poppins', sans-serif;
            font-size: clamp(2.5rem, 10vw, 5rem);
            font-weight: 700;
            color: #fff;
            margin-top: -1rem;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeIn 1s ease-out 1.5s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- MAIN APP STYLES --- */
        .app-container {
            opacity: 0;
            animation: fadeIn 0.5s ease-in forwards;
        }

        .app-container.visible {
            opacity: 1;
        }

        .navbar-brand h1 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
            margin: 0;
        }

        .navbar {
            background-color: rgba(var(--bs-body-bg-rgb), 0.8);
            backdrop-filter: blur(10px);
        }

        #sidebar {
            position: sticky;
            top: 60px;
            height: calc(100vh - 60px);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            width: 300px;
            overflow-y: auto;
            border-right: 1px solid var(--bs-border-color);
        }

        .app-row {
            display: flex;
            flex-wrap: nowrap;
        }

        #main-content {
            flex-grow: 1;
            padding: 1.5rem;
            background-color: var(--bs-body-bg);
        }

        #chart-container {
            width: 100%;
            height: 85vh;
            min-height: 600px;
            background-color: var(--bs-tertiary-bg);
            border-radius: 0.5rem;
            box-shadow: var(--bs-box-shadow-sm);
            padding: 1.5rem;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .accordion-button:not(.collapsed) {
            background-color: var(--bs-primary-bg-subtle);
            color: var(--bs-primary);
        }

        /* --- HOME / GALLERY STYLES --- */
        #home-view {
            padding: 0;
            animation: fadeIn 0.8s ease-out;
        }

        #home-banner {
            position: relative;
            padding: 6rem 2rem;
            text-align: center;
            border-bottom: 1px solid var(--bs-border-color);
            overflow: hidden;
            background: radial-gradient(ellipse at 50% -20%, rgba(var(--bs-primary-rgb), 0.2), transparent 80%);
        }

        #banner-content {
            transition: transform 0.1s ease-out;
        }

        #home-banner h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--bs-body-color);
        }

        #home-banner p {
            font-size: 1.25rem;
            color: var(--bs-secondary-color);
            margin-bottom: 2rem;
        }

        .gallery-container {
            padding: 3rem 1.5rem;
        }

        .gallery-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: 1px solid var(--bs-border-color);
            background-color: var(--bs-tertiary-bg);
            cursor: grab;
            position: relative;
        }
        .gallery-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .gallery-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 0.5rem 1.5rem rgba(var(--bs-primary-rgb), 0.1);
        }

        .gallery-card-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background-color: var(--dark-purple-bg);
        }

        .gallery-card .card-body {
            position: relative;
        }

        .gallery-card-icon {
            position: absolute;
            top: -25px;
            right: 15px;
            background-color: var(--bs-primary);
            color: var(--bs-body-bg);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--bs-box-shadow-sm);
            border: 2px solid var(--bs-tertiary-bg);
        }
        .favorite-star {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 1.5rem;
            color: #ffc107;
            cursor: pointer;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
            transition: transform 0.2s;
        }
        .favorite-star:hover {
            transform: scale(1.2);
        }
         .favorite-star .bi-star { display: inline; }
         .favorite-star .bi-star-fill { display: none; }
         .favorite-star.is-favorite .bi-star { display: none; }
         .favorite-star.is-favorite .bi-star-fill { display: inline; }


        .site-footer {
            padding: 1.5rem;
            text-align: center;
            font-size: 0.9rem;
            color: var(--bs-secondary-color);
            border-top: 1px solid var(--bs-border-color);
            background-color: var(--bs-tertiary-bg);
        }

        /* --- FOLDER STYLES --- */
        .folder-card {
            background-color: var(--bs-tertiary-bg);
            border: 1px solid var(--bs-border-color);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.3s ease;
            border-radius: 0.5rem;
        }
        .folder-card.drag-over {
            border-color: var(--bs-primary);
            box-shadow: 0 0.25rem 1.5rem rgba(var(--bs-primary-rgb), 0.3);
            transform: scale(1.02);
        }
        .folder-card-header {
            padding: 1rem 1.25rem;
             border-bottom: 1px solid var(--bs-border-color);
             cursor: pointer;
        }

        .folder-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
            padding: 1.25rem;
            min-height: 100px;
        }
        .folder-preview-item {
             border-radius: 0.25rem;
             background-color: var(--dark-purple-bg);
             overflow: hidden;
             position: relative;
             border: 1px solid var(--bs-border-color);
             height: 90px;
        }
        .folder-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .breadcrumb-item a {
            text-decoration: none;
        }

        /* --- Other minor tweaks --- */
        .btn-primary {
            font-weight: 500;
        }

        #notification-container {
            z-index: 1100;
        }

        .saved-chart-item {
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem;
            border-bottom: 1px solid var(--bs-border-color);
        }

        .saved-chart-item .thumbnail-container {
            width: 60px;
            height: 45px;
            margin-right: 8px;
            flex-shrink: 0;
            background-color: var(--bs-tertiary-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .saved-chart-item .saved-chart-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .saved-chart-item .saved-chart-name {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 8px;
            font-size: 0.8rem;
        }

        .saved-chart-preview-pane {
            display: none;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: 100%;
            margin-left: 15px;
            z-index: 1200;
            border: 1px solid var(--bs-border-color);
            box-shadow: var(--bs-box-shadow-lg);
            background-color: var(--bs-tertiary-bg);
            padding: 0.5rem;
            border-radius: 0.375rem;
            pointer-events: none;
        }

        .saved-chart-preview-pane img {
            max-width: 400px;
            max-height: 300px;
            display: block;
        }

        .saved-chart-item:hover .saved-chart-preview-pane {
            display: block;
        }

        #custom-context-menu {
            position: absolute;
            z-index: 10001;
            background-color: var(--bs-tertiary-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 0.375rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, .15);
            padding: 0.5rem 0;
            min-width: 220px;
        }

        .context-menu-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }
        .context-menu-item i {
            margin-right: 0.75rem;
            width: 16px;
        }

        .context-menu-item:hover {
            background-color: var(--bs-primary-bg-subtle);
        }
        .context-menu-divider {
            height: 1px;
            margin: .5rem 0;
            overflow: hidden;
            background-color: var(--bs-border-color);
        }
        .color-palette {
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 1rem;
        }
        .color-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .color-dot:hover, .color-dot.selected {
            border-color: var(--bs-primary);
        }

        .context-menu-item.delete {
            color: var(--bs-danger);
        }
        .context-menu-submenu-container {
            position: relative;
        }

        .context-menu-submenu {
            position: absolute;
            top: -0.5rem;
            left: 100%;
            display: none;
            background-color: var(--bs-tertiary-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 0.375rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15);
            padding: 0.5rem 0;
            min-width: 180px;
            z-index: 10002;
        }

        .context-menu-submenu-container:hover > .context-menu-submenu {
            display: block;
        }


        #ai-chat-fab {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--bs-primary);
            color: var(--bs-body-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 1050;
            transition: transform 0.2s ease-in-out;
        }

        #ai-chat-fab:hover {
            transform: scale(1.1);
        }

        #ai-chat-modal .modal-dialog {
            position: fixed;
            right: 25px;
            bottom: 100px;
            width: 400px;
            max-width: 90vw;
            margin: 0;
            z-index: 1055;
        }

        #ai-chat-modal .modal-content {
            height: 50vh;
            max-height: 500px;
            box-shadow: var(--bs-box-shadow-lg);
        }

        #ai-chat-modal .modal-body {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #ai-chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .chat-message.user {
            background-color: var(--bs-primary-bg-subtle);
            align-self: flex-end;
            margin-left: auto;
        }

        .chat-message.ai {
            background-color: var(--bs-secondary-bg-subtle);
            align-self: flex-start;
        }

        .chat-message.tool {
            color: var(--bs-secondary-color);
            font-style: italic;
            font-size: 0.8rem;
            text-align: center;
            width: 100%;
            background-color: transparent;
        }

        #voice-command-btn.recording {
            color: var(--bs-danger);
        }

        #icon-selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 1rem;
            max-height: 40vh;
            overflow-y: auto;
        }

        .icon-option {
            font-size: 1.8rem;
            cursor: pointer;
            text-align: center;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }

        .icon-option:hover,
        .icon-option.selected {
            background-color: var(--bs-primary-bg-subtle);
            color: var(--bs-primary);
        }
    </style>
</head>

<body>
    <div id="intro-overlay">
        <div id="intro-animation-container">
            <svg id="intro-graph" viewBox="0 0 400 100" preserveAspectRatio="none">
                <path d="M 0,50 L 50,50 C 75,10, 125,90, 150,50 S 225,10, 250,50 S 325,90, 350,50 L 400,50" fill="none"
                    stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <h1 id="intro-title">AllaChart游냤</h1>
        </div>
    </div>

    <div class="app-container">

        <nav class="navbar border-bottom sticky-top">
            <div class="container-fluid">
                <a class="navbar-brand d-flex align-items-center" href="#" id="home-link">
                    <svg class="me-2" style="width: 2rem; height: 2rem; fill: currentColor;" viewBox="0 0 100 100"
                        xmlns="http://www.w3.org/2000/svg">
                        <g>
                            <circle cx="50" cy="25" r="15" />
                            <circle cx="38" cy="40" r="12" />
                            <circle cx="62" cy="40" r="12" />
                            <path d="M 35,55 A 20,20 0 0,1 65,55 L 70,80 A 10,10 0 0,1 60,90 L 40,90 A 10,10 0 0,1 30,80 Z" />
                            <circle cx="75" cy="55" r="5" />
                        </g>
                    </svg>
                    <h1>AllaChart</h1>
                </a>
                <div>
                    <button class="btn btn-primary me-2" id="creator-link">
                        <i class="bi bi-plus-lg"></i> Criar Gr치fico
                    </button>
                    <button class="btn border-0" id="theme-toggle" title="Alternar Tema">
                        <i class="bi bi-circle-half"></i>
                    </button>
                </div>
            </div>
        </nav>

        <div id="home-view">
            <div id="home-banner">
                <div id="banner-content">
                    <h1>Visualize. Crie. Impressione.</h1>
                    <p>Sua ferramenta definitiva para criar gr치ficos inteligentes com facilidade.</p>
                    <button class="btn btn-primary btn-lg me-2" id="home-create-btn">Come칞ar a Criar <i
                            class="bi bi-arrow-right-short"></i></button>
                    <button class="btn btn-outline-info btn-lg" id="home-apply-folder-code-btn">Tem um c칩digo de pasta? <i class="bi bi-folder-symlink"></i></button>
                </div>
            </div>
            <div class="container gallery-container">
                <div id="gallery-header">
                    <!-- BREADCRUMBS AND SEARCH WILL GO HERE -->
                </div>
                <div id="favorites-container" class="mb-5" style="display: none;">
                    <h3 class="mb-4"><i class="bi bi-star-fill text-warning me-2"></i>Favoritos</h3>
                     <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4" id="favorites-gallery-container">
                    </div>
                    <hr class="my-5">
                </div>

                <div id="folders-container">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 id="folders-title">Pastas</h2>
                        <button class="btn btn-success" id="create-folder-btn"><i class="bi bi-folder-plus"></i> Nova Pasta</button>
                    </div>
                    <div id="folder-gallery-container">
                        <!-- Folder Cards will go here -->
                    </div>
                </div>

                <hr class="my-5">
                
                <div id="charts-header-container" class="d-flex justify-content-between align-items-center mb-4">
                    <h2 id="charts-title">Gr치ficos Avulsos</h2>
                    <button class="btn btn-success" id="new-chart-in-folder-btn" style="display: none;"><i class="bi bi-plus-lg"></i> Novo Gr치fico na Pasta</button>
                </div>

                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4" id="chart-gallery-container">
                    <!-- Uncategorized Chart Cards will go here -->
                </div>
            </div>
        </div>

        <div id="creator-view">
            <div class="container-fluid">
                <div class="app-row">

                    <aside id="sidebar" class="p-2">
                        <div class="accordion" id="settingsAccordion">

                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapseSavedCharts">Seus
                                        Gr치ficos</button></h2>
                                <div id="collapseSavedCharts" class="accordion-collapse collapse show"
                                    data-bs-parent="#settingsAccordion">
                                    <div class="accordion-body">
                                        <div class="d-grid gap-2 mb-3">
                                            <button id="save-chart-btn" class="btn btn-success">Salvar Gr치fico
                                                Atual</button>
                                        </div>
                                        <div id="saved-charts-list"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapseData">Editor de Dados</button>
                                </h2>
                                <div id="collapseData" class="accordion-collapse collapse"
                                    data-bs-parent="#settingsAccordion">
                                    <div class="accordion-body">
                                        <div class="d-flex justify-content-between mb-2">
                                            <button id="rename-series-btn"
                                                class="btn btn-sm btn-outline-secondary">Renomear S칠rie</button>
                                        </div>
                                        <div id="data-input-container"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapseChart">Configura칞칫es do
                                        Gr치fico</button></h2>
                                <div id="collapseChart" class="accordion-collapse collapse"
                                    data-bs-parent="#settingsAccordion">
                                    <div class="accordion-body">
                                        <label for="chart-title" class="form-label">T칤tulo Principal</label><input
                                            type="text" id="chart-title" class="form-control form-control-sm mb-2">
                                        <label for="chart-type" class="form-label">Tipo de Gr치fico</label><select
                                            id="chart-type" class="form-select form-select-sm mb-2">
                                            <option value="line">Linha</option>
                                            <option value="bar">Barras</option>
                                            <option value="pie">Pizza</option>
                                            <option value="scatter">Dispers칚o</option>
                                        </select>
                                        <div id="line-style-control-wrapper" class="mb-2"><label
                                                for="line-style-select" class="form-label">Estilo da Linha</label><select
                                                id="line-style-select" class="form-select form-select-sm">
                                                <option value="true">Arredondadas</option>
                                                <option value="false">Retas</option>
                                            </select></div>
                                        <div class="row">
                                            <div class="col"><label class="form-label">Cor da S칠rie</label><input
                                                    type="color" id="line-color"
                                                    class="form-control form-control-color w-100" value="#9f75ff"></div>
                                            <div class="col"><label class="form-label">Fundo</label><input
                                                    type="color" id="chart-bg-color"
                                                    class="form-control form-control-color w-100" value="#201d2b"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapseAxes">Eixos e
                                        Detalhes</button></h2>
                                <div id="collapseAxes" class="accordion-collapse collapse"
                                    data-bs-parent="#settingsAccordion">
                                    <div class="accordion-body">
                                        <div class="row mb-2">
                                            <div class="col"><label for="x-axis-title" class="form-label">T칤tulo Eixo
                                                    X</label><input type="text" id="x-axis-title"
                                                    class="form-control form-control-sm"></div>
                                            <div class="col"><label for="y-axis-title" class="form-label">T칤tulo Eixo
                                                    Y</label><input type="text" id="y-axis-title"
                                                    class="form-control form-control-sm"></div>
                                        </div>
                                        <label class="form-label">Faixa de Valores do Eixo Y</label>
                                        <div class="input-group input-group-sm mb-2">
                                            <input type="number" id="y-axis-min" class="form-control"
                                                placeholder="M칤nimo">
                                            <input type="number" id="y-axis-max" class="form-control"
                                                placeholder="M치ximo">
                                            <button class="btn btn-outline-secondary" type="button"
                                                id="y-axis-range-reset-btn">Reset</button>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col"><label class="form-label">Linhas Verticais
                                                    (X)</label><select id="x-grid-lines"
                                                    class="form-select form-select-sm">
                                                    <option>Auto</option>
                                                    <option>1</option>
                                                    <option>2</option>
                                                    <option>3</option>
                                                    <option>4</option>
                                                    <option>5</option>
                                                    <option>10</option>
                                                </select></div>
                                            <div class="col"><label class="form-label">Linhas Horizontais
                                                    (Y)</label><select id="y-grid-lines"
                                                    class="form-select form-select-sm">
                                                    <option>Auto</option>
                                                    <option>1</option>
                                                    <option>2</option>
                                                    <option>3</option>
                                                    <option>4</option>
                                                    <option>5</option>
                                                    <option>10</option>
                                                </select></div>
                                        </div>
                                        <label for="grid-style" class="form-label">Estilo da Grade</label><select
                                            id="grid-style" class="form-select form-select-sm mb-2">
                                            <option value="dotted">Pontilhada</option>
                                            <option value="dashed">Tracejada</option>
                                            <option value="solid">S칩lida</option>
                                            <option value="none">Nenhuma</option>
                                        </select>
                                        <div class="row">
                                            <div class="col"><label class="form-label">Tam. Fonte T칤tulos</label><input
                                                    type="number" id="title-font-size"
                                                    class="form-control form-control-sm" min="10" value="14"></div>
                                            <div class="col"><label class="form-label">Cor Fonte T칤tulos</label><input
                                                    type="color" id="title-color"
                                                    class="form-control form-control-color w-100" value="#ffffff"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseHelp">
                                        游냤 Assistente Alla
                                    </button>
                                </h2>
                                <div id="collapseHelp" class="accordion-collapse collapse"
                                    data-bs-parent="#settingsAccordion">
                                    <div class="accordion-body text-center">
                                        <p class="small text-muted">Precisa de ajuda ou quer criar um gr치fico com
                                            comandos? Clique no bot칚o de chat para falar com o Alla!</p>
                                        <button class="btn btn-primary" id="open-chat-from-sidebar">Abrir Chat</button>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header"><button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#collapseFile">Arquivo</button></h2>
                                <div id="collapseFile" class="accordion-collapse collapse"
                                    data-bs-parent="#settingsAccordion">
                                    <div class="accordion-body">
                                        <div class="d-grid gap-2">
                                            <button id="import-btn" class="btn btn-outline-secondary">Importar
                                                Planilha</button>
                                            <button id="export-excel" class="btn btn-primary">Exportar para
                                                Excel</button>
                                            <button id="export-pdf-btn" class="btn btn-danger">Exportar para PDF</button>
                                            <hr>
                                            <button id="copy-share-code-btn"
                                                class="btn btn-sm btn-outline-info">Copiar C칩digo de
                                                Compartilhamento</button>
                                            <button id="apply-share-code-btn" class="btn btn-sm btn-info">Aplicar C칩digo
                                                de Compartilhamento</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid mt-3 p-2">
                            <button id="reset-to-default-btn" class="btn btn-warning">Reiniciar para o Padr칚o</button>
                        </div>
                    </aside>

                    <main id="main-content">
                        <div id="chart-container"></div>
                    </main>
                </div>
            </div>
        </div>

    </div>

    <footer class="site-footer">
        Criado com 游눞 por Luiza Santos Marialva
    </footer>

    <div id="notification-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <!-- Generic Modal -->
    <div class="modal fade" id="genericModal" tabindex="-1" aria-labelledby="genericModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="genericModalLabel">T칤tulo do Modal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="genericModalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="genericModalConfirmBtn">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Theme Choice Modal -->
    <div class="modal fade" id="themeChoiceModal" tabindex="-1" aria-labelledby="themeChoiceModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="themeChoiceModalLabel">Escolha o Estilo do Novo Gr치fico</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="mb-4">Qual tema voc칡 prefere para o seu novo gr치fico padr칚o?</p>
                    <div class="d-grid gap-3">
                        <button type="button" class="btn btn-lg btn-light" id="choice-light-theme-btn">
                            <i class="bi bi-sun-fill"></i> Gr치fico Light
                        </button>
                        <button type="button" class="btn btn-lg btn-dark" id="choice-dark-theme-btn">
                            <i class="bi bi-moon-stars-fill"></i> Gr치fico Dark
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Icon Selector Modal -->
    <div class="modal fade" id="icon-selector-modal" tabindex="-1" aria-labelledby="iconSelectorModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="iconSelectorModalLabel">Escolha um 칈cone para o seu Gr치fico</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="icon-selector-grid"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Pular</button>
                    <button type="button" class="btn btn-primary" id="icon-selector-confirm-btn">Confirmar 칈cone</button>
                </div>
            </div>
        </div>
    </div>

    <div id="ai-chat-fab" title="Falar com Alla">游냤</div>

    <div class="modal fade" id="ai-chat-modal" tabindex="-1" aria-labelledby="aiChatModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aiChatModalLabel">Falar com Alla 游냤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="ai-chat-messages"></div>
                    <div id="ai-typing-indicator" class="mt-2" style="display: none;">
                        <div class="chat-message ai typing-indicator">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="input-group">
                        <input type="text" id="ai-chat-input" class="form-control" placeholder="Pe칞a um comando..."
                            aria-label="Sua mensagem">
                        <button class="btn btn-outline-secondary" type="button" id="voice-command-btn"
                            title="Comando por Voz"><i class="bi bi-mic-fill"></i></button>
                        <button class="btn btn-primary" type="button" id="ai-chat-send-btn">Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const introOverlay = document.getElementById('intro-overlay');
            const appContainer = document.querySelector('.app-container');

            const path = document.querySelector('#intro-graph path');
            const pathLength = path.getTotalLength();
            path.style.strokeDasharray = pathLength;
            path.style.strokeDashoffset = pathLength;

            setTimeout(() => {
                introOverlay.style.opacity = '0';
                appContainer.classList.add('visible');
                introOverlay.addEventListener('transitionend', () => introOverlay.style.display = 'none');
            }, 2800);

            const APP = {
                state: { chart: null, data: {}, theme: 'light', modal: null, aiChatModal: null, iconSelectorModal: null, themeChoiceModal: null, currentView: 'home', currentFolderId: null, currentFilter: '' },
                dom: {
                    html: document.documentElement,
                    chartContainer: document.getElementById('chart-container'),
                    notificationContainer: document.getElementById('notification-container'),
                    homeView: document.getElementById('home-view'),
                    creatorView: document.getElementById('creator-view'),
                    galleryHeader: document.getElementById('gallery-header'),
                    favoritesContainer: document.getElementById('favorites-container'),
                    favoritesGalleryContainer: document.getElementById('favorites-gallery-container'),
                    foldersContainer: document.getElementById('folders-container'),
                    folderGalleryContainer: document.getElementById('folder-gallery-container'),
                    chartGalleryContainer: document.getElementById('chart-gallery-container'),
                    chartsTitle: document.getElementById('charts-title'),
                    homeBanner: document.getElementById('home-banner'),
                    bannerContent: document.getElementById('banner-content'),
                    modal: {
                        el: document.getElementById('genericModal'),
                        title: document.getElementById('genericModalLabel'),
                        body: document.getElementById('genericModalBody'),
                        confirmBtn: document.getElementById('genericModalConfirmBtn')
                    },
                    themeChoiceModal: {
                        el: document.getElementById('themeChoiceModal'),
                        lightBtn: document.getElementById('choice-light-theme-btn'),
                        darkBtn: document.getElementById('choice-dark-theme-btn'),
                    },
                    iconModal: {
                        el: document.getElementById('icon-selector-modal'),
                        grid: document.getElementById('icon-selector-grid'),
                        confirmBtn: document.getElementById('icon-selector-confirm-btn'),
                    },
                    nav: {
                        homeLink: document.getElementById('home-link'),
                        creatorLink: document.getElementById('creator-link'),
                    },
                    controls: {
                        importBtn: document.getElementById('import-btn'),
                        homeCreateBtn: document.getElementById('home-create-btn'),
                        homeApplyFolderCodeBtn: document.getElementById('home-apply-folder-code-btn'),
                        createFolderBtn: document.getElementById('create-folder-btn'),
                        newChartInFolderBtn: document.getElementById('new-chart-in-folder-btn'),
                        chartType: document.getElementById('chart-type'),
                        chartTitle: document.getElementById('chart-title'),
                        titleFontSize: document.getElementById('title-font-size'),
                        titleColor: document.getElementById('title-color'),
                        xAxisTitle: document.getElementById('x-axis-title'),
                        yAxisTitle: document.getElementById('y-axis-title'),
                        lineColor: document.getElementById('line-color'),
                        gridStyle: document.getElementById('grid-style'),
                        chartBgColor: document.getElementById('chart-bg-color'),
                        xGridLines: document.getElementById('x-grid-lines'),
                        yGridLines: document.getElementById('y-grid-lines'),
                        yAxisMin: document.getElementById('y-axis-min'),
                        yAxisMax: document.getElementById('y-axis-max'),
                        yAxisRangeResetBtn: document.getElementById('y-axis-range-reset-btn'),
                        lineStyleSelect: document.getElementById('line-style-select'),
                        exportExcelBtn: document.getElementById('export-excel'),
                        exportPdfBtn: document.getElementById('export-pdf-btn'),
                        themeToggle: document.getElementById('theme-toggle'),
                        dataInputContainer: document.getElementById('data-input-container'),
                        renameSeriesBtn: document.getElementById('rename-series-btn'),
                        copyShareCodeBtn: document.getElementById('copy-share-code-btn'),
                        applyShareCodeBtn: document.getElementById('apply-share-code-btn'),
                        saveChartBtn: document.getElementById('save-chart-btn'),
                        savedChartsList: document.getElementById('saved-charts-list'),
                        resetToDefaultBtn: document.getElementById('reset-to-default-btn'),
                        aiChatFab: document.getElementById('ai-chat-fab'),
                        aiChatModal: document.getElementById('ai-chat-modal'),
                        aiChatMessages: document.getElementById('ai-chat-messages'),
                        aiChatInput: document.getElementById('ai-chat-input'),
                        aiChatSendBtn: document.getElementById('ai-chat-send-btn'),
                        aiTypingIndicator: document.getElementById('ai-typing-indicator'),
                        openChatFromSidebar: document.getElementById('open-chat-from-sidebar'),
                        voiceCommandBtn: document.getElementById('voice-command-btn'),
                    }
                },
                methods: {
                    init() {
                        this.loadState();
                        this.checkForSharedFolder();
                        APP.state.chart = echarts.init(APP.dom.chartContainer);
                        APP.state.modal = new bootstrap.Modal(APP.dom.modal.el);
                        APP.state.aiChatModal = new bootstrap.Modal(APP.dom.controls.aiChatModal);
                        APP.state.iconSelectorModal = new bootstrap.Modal(APP.dom.iconModal.el);
                        APP.state.themeChoiceModal = new bootstrap.Modal(APP.dom.themeChoiceModal.el);

                        this.bindEventListeners();
                        this.navigateTo(APP.state.currentView, APP.state.currentFolderId);
                        this.rebuildUI(false);
                        this.renderSavedChartsList();
                        this.populateIconSelector();
                        this.toggleLineStyleControl();
                        this.AI_ASSISTANT.init();
                        this.initBannerAnimation();
                    },
                    initBannerAnimation() {
                        const banner = APP.dom.homeBanner;
                        const content = APP.dom.bannerContent;
                        if (!banner || !content) return;

                        banner.addEventListener('mousemove', (e) => {
                            const { width, height, left, top } = banner.getBoundingClientRect();
                            const x = e.clientX - left;
                            const y = e.clientY - top;

                            const rotateX = (y / height - 0.5) * -15;
                            const rotateY = (x / width - 0.5) * 15;

                            content.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1, 1, 1)`;
                        });

                        banner.addEventListener('mouseleave', () => {
                            content.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)';
                        });
                    },
                    navigateTo(viewName, folderId = null) {
                        APP.state.currentView = viewName;
                        APP.state.currentFolderId = folderId;

                        APP.dom.homeView.style.display = 'none';
                        APP.dom.creatorView.style.display = 'none';

                        if (viewName === 'home') {
                            APP.dom.homeView.style.display = 'block';
                            this.renderHomeGallery();
                        } else if (viewName === 'creator') {
                            APP.dom.creatorView.style.display = 'block';
                            setTimeout(() => {
                                if (APP.state.chart) APP.state.chart.resize()
                            }, 10);
                        }
                        this.saveState();
                    },
                    updateSettings(save = true) {
                        this.updateChart();
                        if (save) this.saveState();
                    },
                    rebuildUI(save = true) {
                        this.renderDataEditorForm();
                        this.updateChart();
                        if (save) this.saveState();
                    },
                    bindEventListeners() {
                        for (const key in APP.dom.controls) {
                            const control = APP.dom.controls[key];
                            if (control && !control.id.includes('Btn') && !control.id.includes('Link') && control.id !== 'data-input-container' && control.id !== 'saved-charts-list' && !control.id.startsWith('ai-chat')) {
                                const eventType = (control.type === 'color' || control.type === 'number' || control.tagName === 'SELECT') ? 'change' : 'input';
                                control.addEventListener(eventType, () => this.updateSettings());
                            }
                        }

                        APP.dom.nav.homeLink.addEventListener('click', (e) => { e.preventDefault(); this.navigateTo('home'); });
                        APP.dom.nav.creatorLink.addEventListener('click', (e) => { e.preventDefault(); this.navigateTo('creator'); });
                        APP.dom.controls.homeCreateBtn.addEventListener('click', (e) => { e.preventDefault(); this.navigateTo('creator'); });
                        APP.dom.controls.homeApplyFolderCodeBtn.addEventListener('click', () => this.promptForFolderCode());
                        APP.dom.controls.createFolderBtn.addEventListener('click', () => this.createFolder());
                        APP.dom.controls.newChartInFolderBtn.addEventListener('click', () => this.createNewChartInCurrentFolder());


                        APP.state.chart.on('click', this.handleChartClick.bind(this));

                        APP.dom.themeChoiceModal.lightBtn.addEventListener('click', () => this.performReset('light'));
                        APP.dom.themeChoiceModal.darkBtn.addEventListener('click', () => this.performReset('dark'));

                        APP.dom.controls.yAxisRangeResetBtn.addEventListener('click', () => {
                            APP.dom.controls.yAxisMin.value = '';
                            APP.dom.controls.yAxisMax.value = '';
                            this.updateSettings();
                        });
                        APP.dom.controls.chartType.addEventListener('change', () => this.toggleLineStyleControl());
                        APP.dom.controls.themeToggle.addEventListener('click', () => this.toggleTheme());
                        APP.dom.controls.importBtn.addEventListener('click', () => {
                            const u = document.createElement('input');
                            u.type = 'file';
                            u.accept = '.xlsx,.csv';
                            u.onchange = (e) => this.handleFileUpload(e);
                            u.click();
                        });
                        APP.dom.controls.exportExcelBtn.addEventListener('click', () => this.exportToExcel());
                        APP.dom.controls.exportPdfBtn.addEventListener('click', () => this.exportToPdf());
                        APP.dom.controls.renameSeriesBtn.addEventListener('click', () => this.renameSeries());
                        APP.dom.controls.copyShareCodeBtn.addEventListener('click', () => this.copyShareCode());
                        APP.dom.controls.applyShareCodeBtn.addEventListener('click', () => this.applyShareCode());
                        APP.dom.controls.saveChartBtn.addEventListener('click', () => this.saveCurrentChart());
                        APP.dom.controls.resetToDefaultBtn.addEventListener('click', () => this.resetToDefault());

                        window.addEventListener('click', (e) => {
                            if (!e.target.closest('#custom-context-menu')) {
                               this.hideContextMenu();
                            }
                        });

                        window.addEventListener('resize', () => {
                            if (APP.state.chart) {
                                APP.state.chart.resize();
                            }
                        });
                    },
                    handleChartClick(params) {
                        const c = APP.dom.controls;
                        switch (params.componentType) {
                            case 'title':
                                this.showModal('Editar T칤tulo Principal', { type: 'input', value: c.chartTitle.value }, (newTitle) => {
                                    if (newTitle !== null) {
                                        c.chartTitle.value = newTitle;
                                        this.updateSettings();
                                    }
                                });
                                break;
                            case 'xAxis':
                                this.showModal('Editar T칤tulo do Eixo X', { type: 'input', value: c.xAxisTitle.value }, (newTitle) => {
                                    if (newTitle !== null) {
                                        c.xAxisTitle.value = newTitle;
                                        this.updateSettings();
                                    }
                                });
                                break;
                            case 'yAxis':
                                this.showModal('Editar T칤tulo do Eixo Y', { type: 'input', value: c.yAxisTitle.value }, (newTitle) => {
                                    if (newTitle !== null) {
                                        c.yAxisTitle.value = newTitle;
                                        this.updateSettings();
                                    }
                                });
                                break;
                            case 'series':
                                const isPie = c.chartType.value === 'pie';
                                if (!isPie) {
                                    this.showModal(`Editar S칠rie`, `Voc칡 clicou na s칠rie "${params.seriesName}". O que deseja fazer?`, (choice) => {
                                        if (choice === 'color') {
                                            c.lineColor.click();
                                        } else {
                                            this.editDataPoint(params);
                                        }
                                    }, {
                                        cancelText: 'Editar Ponto',
                                        confirmText: 'Mudar Cor',
                                        confirmAction: 'color',
                                        cancelAction: 'value'
                                    });
                                } else {
                                    this.editDataPoint(params);
                                }
                                break;
                        }
                    },
                    editDataPoint(params) {
                        const currentLabel = APP.state.data.labels[params.dataIndex];
                        const currentValue = APP.state.data.values[params.dataIndex];
                        this.showModal(`Editar valor para "${currentLabel}"`, { type: 'input', inputType: 'number', value: currentValue }, (newValueStr) => {
                            if (newValueStr !== null) {
                                const newValue = parseFloat(newValueStr);
                                if (!isNaN(newValue)) {
                                    APP.state.data.values[params.dataIndex] = newValue;
                                    this.rebuildUI();
                                    this.showNotification(`Valor para "${currentLabel}" atualizado para ${newValue}.`, 'success');
                                } else {
                                    this.showNotification('Valor inv치lido. Por favor, insira um n칰mero.', 'danger');
                                }
                            }
                        });
                    },
                    renderDataEditorForm() {
                        const container = APP.dom.controls.dataInputContainer;
                        container.innerHTML = '';
                        if (!APP.state.data || !APP.state.data.values) return;
                        APP.state.data.values.forEach((value, index) => {
                            const row = document.createElement('div');
                            row.className = 'data-input-row';
                            row.addEventListener('contextmenu', (e) => {
                                e.preventDefault();
                                this.showContextMenu(e.clientX, e.clientY, {id: index}, 'data');
                            });
                            const controls = document.createElement('div');
                            controls.className = 'year-controls';
                            const addBeforeBtn = document.createElement('button');
                            addBeforeBtn.textContent = '+';
                            addBeforeBtn.className = 'btn btn-sm btn-outline-info add-year-btn';
                            addBeforeBtn.title = 'Adicionar ano anterior';
                            addBeforeBtn.onclick = (e) => {
                                e.stopPropagation();
                                this.addYear(index, true);
                            };
                            const addAfterBtn = document.createElement('button');
                            addAfterBtn.textContent = '+';
                            addAfterBtn.className = 'btn btn-sm btn-outline-info add-year-btn mt-1';
                            addAfterBtn.title = 'Adicionar ano seguinte';
                            addAfterBtn.onclick = (e) => {
                                e.stopPropagation();
                                this.addYear(index, false);
                            };
                            controls.appendChild(addBeforeBtn);
                            controls.appendChild(addAfterBtn);
                            const label = document.createElement('label');
                            label.textContent = APP.state.data.labels[index] || `Ponto ${index + 1}`;
                            label.className = 'form-label mb-0';
                            const input = document.createElement('input');
                            input.type = 'number';
                            input.value = value;
                            input.className = 'form-control form-control-sm';
                            const commitChange = () => {
                                const newValue = parseFloat(input.value);
                                if (!isNaN(newValue)) {
                                    if (APP.state.data.values[index] !== newValue) {
                                        APP.state.data.values[index] = newValue;
                                        this.updateChart();
                                        this.saveState();
                                    }
                                } else {
                                    input.value = APP.state.data.values[index];
                                }
                            };
                            input.addEventListener('blur', commitChange);
                            input.addEventListener('keydown', (e) => {
                                if (e.key === 'Enter' || e.key === 'Tab') {
                                    e.preventDefault();
                                    input.blur();
                                }
                            });
                            row.appendChild(controls);
                            row.appendChild(label);
                            row.appendChild(input);
                            container.appendChild(row);
                        });
                    },
                    addYear(index, before) {
                        const labels = APP.state.data.labels;
                        const values = APP.state.data.values;
                        const referenceYear = parseInt(labels[index], 10);
                        if (isNaN(referenceYear)) {
                            this.showNotification("N칚o 칠 poss칤vel adicionar ano a partir de um r칩tulo de texto.", "warning");
                            return;
                        }
                        const newYear = before ? referenceYear - 1 : referenceYear + 1;
                        const insertIndex = before ? index : index + 1;
                        labels.splice(insertIndex, 0, String(newYear));
                        values.splice(insertIndex, 0, 0);
                        this.rebuildUI();
                    },
                    deleteYear(index) {
                        const label = APP.state.data.labels[index];
                        this.showModal('Confirmar Exclus칚o', `Tem certeza que deseja excluir o item "${label}"?`, (confirmed) => {
                            if (confirmed) {
                                APP.state.data.labels.splice(index, 1);
                                APP.state.data.values.splice(index, 1);
                                this.rebuildUI();
                                this.showNotification("Item exclu칤do.", "info");
                            }
                        }, {
                            confirmClass: 'btn-danger',
                            confirmText: 'Excluir'
                        });
                    },
                    showContextMenu(x, y, context, type = 'chart') {
                        this.hideContextMenu();
                        const menu = document.createElement('div');
                        menu.id = 'custom-context-menu';
                        
                        if (type === 'data') {
                             const deleteItem = document.createElement('div');
                            deleteItem.className = 'context-menu-item delete';
                            deleteItem.innerHTML = '<i class="bi bi-trash"></i> Excluir Item';
                            deleteItem.onclick = () => this.deleteYear(context.id);
                            menu.appendChild(deleteItem);
                        } else if (type === 'chart') {
                            const folders = JSON.parse(localStorage.getItem('alladinFolders') || '[]');
                            const chart = (JSON.parse(localStorage.getItem('alladinSavedCharts') || '[]')).find(c => c.id === context.id);

                             const favItem = document.createElement('div');
                            favItem.className = 'context-menu-item';
                            favItem.innerHTML = `<i class="bi ${chart.isFavorite ? 'bi-star-fill text-warning' : 'bi-star'}"></i> ${chart.isFavorite ? 'Remover dos Favoritos' : 'Adicionar aos Favoritos'}`;
                            favItem.onclick = () => this.toggleFavorite(context.id);
                             menu.appendChild(favItem);

                             const duplicateItem = document.createElement('div');
                            duplicateItem.className = 'context-menu-item';
                            duplicateItem.innerHTML = '<i class="bi bi-copy"></i> Duplicar Gr치fico';
                            duplicateItem.onclick = () => this.duplicateChart(context.id);
                            menu.appendChild(duplicateItem);
                            
                             menu.appendChild(new DOMParser().parseFromString('<div class="context-menu-divider"></div>', 'text/html').body.firstChild);
                            
                             // "Move To..." submenu
                            if (folders.length > 0) {
                                const moveToContainer = document.createElement('div');
                                moveToContainer.className = 'context-menu-item context-menu-submenu-container';
                                moveToContainer.innerHTML = '<span><i class="bi bi-folder-symlink"></i> Mover para</span><i class="bi bi-chevron-right ms-auto"></i>';
                                
                                const subMenu = document.createElement('div');
                                subMenu.className = 'context-menu-submenu';

                                if (chart.folderId) {
                                    const unpinItem = document.createElement('div');
                                    unpinItem.className = 'context-menu-item';
                                    unpinItem.innerHTML = '<i class="bi bi-box-arrow-up-left"></i> Remover da Pasta Atual';
                                    unpinItem.onclick = (e) => {
                                        e.stopPropagation();
                                        this.moveChartToFolder(context.id, null);
                                        this.hideContextMenu();
                                    };
                                    subMenu.appendChild(unpinItem);
                                    subMenu.appendChild(new DOMParser().parseFromString('<div class="context-menu-divider"></div>', 'text/html').body.firstChild);
                                }
                                
                                folders.forEach(folder => {
                                    if (folder.id !== chart.folderId) {
                                        const folderItem = document.createElement('div');
                                        folderItem.className = 'context-menu-item';
                                        folderItem.innerHTML = `<i class="bi bi-folder" style="color:${folder.color || 'inherit'}"></i> ${folder.name}`;
                                        folderItem.onclick = (e) => {
                                            e.stopPropagation();
                                            this.moveChartToFolder(context.id, folder.id);
                                            this.hideContextMenu();
                                        };
                                        subMenu.appendChild(folderItem);
                                    }
                                });
                                
                                moveToContainer.appendChild(subMenu);
                                menu.appendChild(moveToContainer);
                            }


                             menu.appendChild(new DOMParser().parseFromString('<div class="context-menu-divider"></div>', 'text/html').body.firstChild);
                             const deleteItem = document.createElement('div');
                            deleteItem.className = 'context-menu-item delete';
                            deleteItem.innerHTML = '<i class="bi bi-trash"></i> Excluir Gr치fico';
                            deleteItem.onclick = () => this.deleteSavedChart(context.id);
                            menu.appendChild(deleteItem);

                        } else if (type === 'folder') {
                            const renameItem = document.createElement('div');
                            renameItem.className = 'context-menu-item';
                            renameItem.innerHTML = '<i class="bi bi-pencil-fill"></i> Renomear Pasta';
                            renameItem.onclick = () => this.renameFolder(context.id);
                            menu.appendChild(renameItem);

                            const shareItem = document.createElement('div');
                            shareItem.className = 'context-menu-item';
                            shareItem.innerHTML = '<i class="bi bi-share-fill"></i> Compartilhar Pasta';
                            shareItem.onclick = () => this.shareFolder(context.id);
                            menu.appendChild(shareItem);

                            const colors = ['#6f42c1', '#fd7e14', '#198754', '#0dcaf0', '#dc3545', '#adb5bd'];
                            const colorPalette = document.createElement('div');
                            colorPalette.className = 'color-palette';
                            colors.forEach(color => {
                                const dot = document.createElement('div');
                                dot.className = 'color-dot';
                                dot.style.backgroundColor = color;
                                dot.onclick = () => this.setFolderColor(context.id, color);
                                colorPalette.appendChild(dot);
                            });
                            menu.appendChild(new DOMParser().parseFromString('<div class="context-menu-divider"></div>', 'text/html').body.firstChild);
                            menu.appendChild(colorPalette);
                            
                             menu.appendChild(new DOMParser().parseFromString('<div class="context-menu-divider"></div>', 'text/html').body.firstChild);
                             const deleteItem = document.createElement('div');
                            deleteItem.className = 'context-menu-item delete';
                            deleteItem.innerHTML = '<i class="bi bi-trash"></i> Excluir Pasta';
                            deleteItem.onclick = () => this.deleteFolder(context.id);
                            menu.appendChild(deleteItem);
                        }

                        document.body.appendChild(menu);
                        // Position menu correctly, preventing it from going off-screen
                        const menuWidth = menu.offsetWidth;
                        const menuHeight = menu.offsetHeight;
                        const winWidth = window.innerWidth;
                        const winHeight = window.innerHeight;
                        
                        let finalX = x;
                        let finalY = y;

                        if (x + menuWidth > winWidth) {
                            finalX = x - menuWidth;
                        }
                        if (y + menuHeight > winHeight) {
                            finalY = y - menuHeight;
                        }
                        
                        menu.style.left = `${finalX}px`;
                        menu.style.top = `${finalY}px`;
                        
                        const subMenu = menu.querySelector('.context-menu-submenu');
                        if(subMenu){
                           const subMenuWidth = subMenu.offsetWidth;
                           if(finalX + menuWidth + subMenuWidth > winWidth){
                               subMenu.style.left = 'auto';
                               subMenu.style.right = '100%';
                           }
                        }
                    },
                    hideContextMenu() {
                        const menu = document.getElementById('custom-context-menu');
                        if (menu) {
                            menu.remove();
                        }
                    },
                    renameSeries() {
                        const currentName = APP.state.data.name;
                        this.showModal('Renomear S칠rie', {
                            type: 'input',
                            value: currentName
                        }, (newName) => {
                            if (newName && newName !== currentName) {
                                APP.state.data.name = newName;
                                this.updateSettings();
                            }
                        });
                    },
                    generateRandomData(theme = 'light') {
                        const pointCount = 7,
                            startYear = new Date().getFullYear() - pointCount;
                        const labels = Array.from({
                            length: pointCount
                        }, (_, i) => (startYear + i + 1).toString());
                        const values = Array.from({
                            length: pointCount
                        }, () => Math.floor(Math.random() * 250) + 150);
                        APP.state.data = {
                            name: 'Total de Servidores',
                            labels,
                            values
                        };
                        const c = APP.dom.controls;
                        c.chartTitle.value = 'Evolu칞칚o Anual de Servidores';
                        c.xAxisTitle.value = 'Ano';
                        c.yAxisTitle.value = 'Total de Servidores';

                        if (theme === 'dark') {
                            c.titleColor.value = '#ffffff';
                            c.lineColor.value = '#9f75ff';
                            c.chartBgColor.value = '#201d2b';
                        } else {
                            c.titleColor.value = '#343a40';
                            c.lineColor.value = '#6f42c1';
                            c.chartBgColor.value = '#ffffff';
                        }

                        c.titleFontSize.value = 14;
                        c.gridStyle.value = 'dotted';
                        c.lineStyleSelect.value = 'true';
                        c.chartType.value = 'line';
                        c.xGridLines.value = 'Auto';
                        c.yGridLines.value = 'Auto';
                        c.yAxisMin.value = '';
                        c.yAxisMax.value = '';
                    },
                    getChartOptions() {
                        const c = APP.dom.controls,
                            isDark = APP.state.theme === 'dark';
                        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                        const textColor = isDark ? 'var(--dark-purple-secondary)' : '#666';
                        const titleColor = c.titleColor.value;
                        const gridStyleValue = c.gridStyle.value;
                        const showGrid = gridStyleValue !== 'none';
                        const getLineType = (style) => {
                            switch (style) {
                                case 'dotted': return [2, 5];
                                case 'dashed': return [7, 7];
                                case 'solid': return 'solid';
                                default: return 'solid';
                            }
                        };
                        const lineType = getLineType(gridStyleValue);
                        let yAxisSplit = {
                            show: showGrid,
                            lineStyle: { type: lineType, color: gridColor }
                        };
                        if (c.yGridLines.value !== 'Auto') yAxisSplit.splitNumber = parseInt(c.yGridLines.value, 10);
                        let xAxisSplit = {
                            show: showGrid,
                            lineStyle: { type: lineType, color: gridColor }
                        };
                        if (c.xGridLines.value !== 'Auto') xAxisSplit.splitNumber = parseInt(c.xGridLines.value, 10);
                        APP.dom.chartContainer.style.backgroundColor = c.chartBgColor.value;
                        const chartType = c.chartType.value;
                        let series = [];
                        const isSmooth = c.lineStyleSelect.value === 'true';
                        const titleFontSize = parseInt(c.titleFontSize.value, 10);
                        if (chartType === 'pie') {
                            series.push({
                                name: APP.state.data.name,
                                type: 'pie',
                                radius: '60%',
                                center: ['50%', '55%'],
                                data: APP.state.data.labels.map((l, i) => ({
                                    value: APP.state.data.values[i],
                                    name: l
                                })),
                                itemStyle: {
                                    color: c.lineColor.value,
                                    borderRadius: 5,
                                    borderColor: c.chartBgColor.value,
                                    borderWidth: 2,
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowOffsetY: 5,
                                    shadowColor: 'rgba(0, 0, 0, 0.1)'
                                },
                                label: { show: true, color: textColor }
                            });
                        } else {
                            series.push({
                                name: APP.state.data.name,
                                type: chartType,
                                data: APP.state.data.values,
                                smooth: isSmooth,
                                symbolSize: 8,
                                lineStyle: {
                                    color: c.lineColor.value,
                                    width: 3,
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowOffsetY: 5,
                                    shadowColor: 'rgba(0, 0, 0, 0.2)'
                                },
                                itemStyle: { color: c.lineColor.value },
                                label: {
                                    show: chartType === 'line' || chartType === 'bar',
                                    position: 'top',
                                    color: titleColor,
                                    fontWeight: 'bold'
                                }
                            });
                        }
                        const yMin = parseFloat(c.yAxisMin.value);
                        const yMax = parseFloat(c.yAxisMax.value);
                        return {
                            backgroundColor: 'transparent',
                            title: {
                                text: c.chartTitle.value,
                                left: 'center',
                                textStyle: {
                                    color: titleColor,
                                    fontSize: titleFontSize + 4,
                                    fontWeight: 'bold'
                                }
                            },
                            tooltip: { trigger: 'axis' },
                            grid: { left: '8%', right: '4%', top: '15%', bottom: '12%', containLabel: true },
                            toolbox: {
                                feature: {
                                    dataView: { readOnly: false, iconStyle: { borderColor: textColor }, textareaColor: '#fff', textareaBorderColor: '#333', textColor: '#fff', backgroundColor: '#222', },
                                    magicType: { type: ['line', 'bar'], iconStyle: { borderColor: textColor } },
                                    restore: { iconStyle: { borderColor: textColor } },
                                    saveAsImage: { backgroundColor: c.chartBgColor.value, iconStyle: { borderColor: textColor } }
                                }
                            },
                            xAxis: {
                                type: 'category',
                                data: APP.state.data.labels,
                                name: c.xAxisTitle.value,
                                nameLocation: 'middle',
                                nameGap: 35,
                                nameTextStyle: { color: titleColor, fontSize: titleFontSize, fontWeight: 'bold' },
                                splitLine: xAxisSplit,
                                axisLine: { lineStyle: { color: gridColor } },
                                axisLabel: { color: textColor }
                            },
                            yAxis: {
                                type: 'value',
                                name: c.yAxisTitle.value,
                                nameLocation: 'middle',
                                nameGap: 55,
                                nameTextStyle: { color: titleColor, fontSize: titleFontSize, fontWeight: 'bold' },
                                min: isNaN(yMin) ? null : yMin,
                                max: isNaN(yMax) ? null : yMax,
                                splitLine: yAxisSplit,
                                axisLine: { lineStyle: { color: gridColor } },
                                axisLabel: { color: textColor }
                            },
                            series
                        };
                    },
                    updateChart() {
                        if (APP.state.chart) APP.state.chart.setOption(this.getChartOptions(), true);
                    },
                    toggleTheme() {
                        APP.state.theme = APP.state.theme === 'light' ? 'dark' : 'light';
                        APP.dom.html.setAttribute('data-bs-theme', APP.state.theme);
                        this.updateSettings();
                    },
                    toggleLineStyleControl() {
                        const wrapper = document.getElementById('line-style-control-wrapper');
                        if (wrapper) {
                            wrapper.style.display = APP.dom.controls.chartType.value === 'line' ? 'block' : 'none';
                        }
                    },
                    showNotification(message, type = 'primary') {
                        const toastHTML = `<div class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true"><div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div></div>`;
                        APP.dom.notificationContainer.insertAdjacentHTML('beforeend', toastHTML);
                        new bootstrap.Toast(APP.dom.notificationContainer.lastElementChild).show();
                    },
                    saveState() {
                        try {
                            const s = {
                                data: APP.state.data,
                                theme: APP.state.theme,
                                currentView: APP.state.currentView,
                                currentFolderId: APP.state.currentFolderId,
                                controls: {}
                            };
                            for (const k in APP.dom.controls) {
                                const e = APP.dom.controls[k];
                                if (e && e.id && typeof e.value !== 'undefined' && e.type !== 'file') s.controls[k] = e.value;
                            }
                            localStorage.setItem('alladinAppState', JSON.stringify(s));
                        } catch (e) {
                            console.warn("Could not save state.", e);
                        }
                    },
                    loadState() {
                        try {
                            const s = JSON.parse(localStorage.getItem('alladinAppState'));
                            if (s) {
                                if (s.data && s.data.values) APP.state.data = s.data;
                                APP.state.theme = s.theme || 'light';
                                APP.state.currentView = s.currentView || 'home';
                                APP.state.currentFolderId = s.currentFolderId || null;
                                APP.dom.html.setAttribute('data-bs-theme', APP.state.theme);
                                if (s.controls) {
                                    for (const k in s.controls) {
                                        if (APP.dom.controls[k] && s.controls[k] !== undefined) APP.dom.controls[k].value = s.controls[k];
                                    }
                                }
                                this.showNotification("Sess칚o anterior restaurada!");
                            } else {
                                this.generateRandomData('light');
                            }
                        } catch (e) {
                            this.generateRandomData('light');
                        }
                    },
                    handleFileUpload(e) {
                        const f = e.target.files[0];
                        if (!f) return;
                        const r = new FileReader();
                        r.onload = (event) => {
                            try {
                                const wb = XLSX.read(new Uint8Array(event.target.result), { type: 'array' });
                                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                                if (json.length < 2) return this.showNotification('Planilha vazia ou inv치lida.', 'danger');
                                const h = json[0], body = json.slice(1);
                                APP.state.data = {
                                    name: h[1] || 'S칠rie Importada',
                                    labels: body.map(row => String(row[0])),
                                    values: body.map(row => parseFloat(row[1]) || 0)
                                };
                                this.rebuildUI();
                                this.navigateTo('creator');
                                this.showNotification('Dados importados com sucesso!', 'success');
                            } catch (err) {
                                this.showNotification('Erro ao ler a planilha.', 'danger');
                            }
                        };
                        r.readAsArrayBuffer(f);
                    },
                    async exportToExcel() {
                        const wb = new ExcelJS.Workbook(), ws = wb.addWorksheet('Relat칩rio');
                        const img = APP.state.chart.getDataURL({ type: 'png', pixelRatio: 3, backgroundColor: APP.dom.controls.chartBgColor.value });
                        const imgId = wb.addImage({ base64: img, extension: 'png' });
                        ws.addImage(imgId, 'A1:J20');
                        const startRow = 22, data = APP.state.data;
                        ws.getCell(startRow, 1).value = "Ano";
                        ws.getCell(startRow, 2).value = data.name;
                        [1, 2].forEach(i => ws.getCell(startRow, i).font = { bold: true, size: 12 });
                        data.labels.forEach((l, i) => {
                            ws.getCell(startRow + 1 + i, 1).value = isNaN(l) ? l : Number(l);
                            ws.getCell(startRow + 1 + i, 2).value = data.values[i];
                        });
                        ws.getColumn(1).width = 20;
                        ws.getColumn(2).width = 20;
                        const buffer = await wb.xlsx.writeBuffer();
                        const title = APP.dom.controls.chartTitle.value.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                        saveAs(new Blob([buffer]), `Relatorio_AllaChart_${title}.xlsx`);
                    },
                    exportToPdf() {
                        this.showNotification('Gerando PDF de alta qualidade...', 'info');
                        try {
                            const chartImg = APP.state.chart.getDataURL({ type: 'png', pixelRatio: 3, backgroundColor: APP.dom.controls.chartBgColor.value });
                            const chartWidth = APP.state.chart.getWidth();
                            const chartHeight = APP.state.chart.getHeight();
                            const orientation = chartWidth > chartHeight ? 'l' : 'p';
                            const pdf = new window.jspdf.jsPDF({ orientation: orientation, unit: 'px', format: [chartWidth, chartHeight] });
                            pdf.addImage(chartImg, 'PNG', 0, 0, chartWidth, chartHeight);
                            const title = APP.dom.controls.chartTitle.value.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'grafico';
                            pdf.save(`Relatorio_AllaChart_${title}.pdf`);
                        } catch (error) {
                            console.error("Erro ao gerar PDF:", error);
                            this.showNotification('Ocorreu um erro ao gerar o PDF.', 'danger');
                        }
                    },
                    copyShareCode() {
                        const c = APP.dom.controls;
                        const sharePayload = {
                            version: 1,
                            data: APP.state.data,
                            controls: {}
                        };
                        for (const key in c) {
                            const e = c[key];
                            if (e && e.id && typeof e.value !== 'undefined' && e.type !== 'file') {
                                sharePayload.controls[key] = e.value;
                            }
                        }
                        const shareCode = btoa(JSON.stringify(sharePayload)); // Base64 encode
                        navigator.clipboard.writeText(shareCode).then(() => this.showNotification('C칩digo de Compartilhamento copiado!', 'success')).catch(() => this.showNotification('Falha ao copiar o c칩digo.', 'danger'));
                    },
                    applyShareCode() {
                        this.showModal('Aplicar C칩digo de Compartilhamento', {
                            type: 'input',
                            placeholder: 'Cole o c칩digo aqui'
                        }, (shareCode) => {
                            if (!shareCode) return;
                            try {
                                const decodedString = atob(shareCode); // Base64 decode
                                const payload = JSON.parse(decodedString);

                                if (payload.version !== 1 || !payload.data || !payload.controls) {
                                    throw new Error("Formato de c칩digo inv치lido.");
                                }

                                APP.state.data = payload.data;
                                for (const key in payload.controls) {
                                    if (APP.dom.controls[key] && payload.controls[key] !== undefined) {
                                        APP.dom.controls[key].value = payload.controls[key];
                                    }
                                }

                                this.rebuildUI();
                                this.toggleLineStyleControl();
                                this.navigateTo('creator');
                                this.showNotification('Gr치fico e design aplicados com sucesso!', 'success');
                            } catch (error) {
                                console.error(error);
                                this.showNotification('C칩digo de Compartilhamento inv치lido ou corrompido.', 'danger');
                            }
                        });
                    },
                    saveCurrentChart() {
                        let chartName = '';
                        let chartIcon = 'bi-bar-chart-line'; // Default icon

                        const onIconSelected = (iconClass) => {
                            chartIcon = iconClass;
                            APP.state.iconSelectorModal.hide();
                            this.showModal('Salvar Gr치fico', {
                                type: 'input',
                                value: APP.dom.controls.chartTitle.value,
                                label: 'Nome do Gr치fico:'
                            }, (name) => {
                                chartName = name;
                                if (!chartName) return;

                                const savedCharts = JSON.parse(localStorage.getItem('alladinSavedCharts') || '[]');
                                const thumbnail = APP.state.chart.getDataURL({ type: 'png', pixelRatio: 1, backgroundColor: APP.dom.controls.chartBgColor.value });
                                const snapshot = {
                                    id: Date.now(),
                                    name: chartName,
                                    icon: chartIcon,
                                    folderId: APP.state.currentFolderId,
                                    isFavorite: false,
                                    data: JSON.parse(JSON.stringify(APP.state.data)),
                                    thumbnail: thumbnail,
                                    controls: {}
                                };
                                for (const key in APP.dom.controls) {
                                    const e = APP.dom.controls[key];
                                    if (e && e.id && typeof e.value !== 'undefined' && e.type !== 'file') {
                                        snapshot.controls[key] = e.value;
                                    }
                                }
                                savedCharts.push(snapshot);
                                localStorage.setItem('alladinSavedCharts', JSON.stringify(savedCharts));
                                this.showNotification('Gr치fico salvo com sucesso!', 'success');
                                this.renderSavedChartsList();
                                this.renderHomeGallery();
                            });
                        };

                        APP.dom.iconModal.el.querySelector('#icon-selector-confirm-btn').onclick = () => {
                            const selectedIcon = APP.dom.iconModal.grid.querySelector('.selected');
                            onIconSelected(selectedIcon ? selectedIcon.dataset.icon : 'bi-bar-chart-line');
                        };
                        APP.state.iconSelectorModal.show();
                    },
                    renderSavedChartsList() {
                        const container = APP.dom.controls.savedChartsList;
                        const savedCharts = JSON.parse(localStorage.getItem('alladinSavedCharts') || '[]').reverse();
                        container.innerHTML = '';
                        if (savedCharts.length === 0) {
                            container.innerHTML = '<p class="text-muted text-center small">Nenhum gr치fico salvo.</p>';
                            return;
                        }
                        savedCharts.forEach(chart => {
                            const item = document.createElement('div');
                            item.className = 'saved-chart-item';
                            const thumbnailSrc = chart.thumbnail || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                            const iconHtml = `<i class="${chart.icon || 'bi-bar-chart-line'} me-2"></i>`;
                            item.innerHTML = `
                                <div class="thumbnail-container"><img class="saved-chart-thumbnail" src="${thumbnailSrc}" alt="Pr칠via"></div>
                                    ${iconHtml}
                                <span class="saved-chart-name small" title="${chart.name}">${chart.name}</span>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary load-btn" title="Carregar"><i class="bi bi-box-arrow-in-down"></i></button>
                                    <button class="btn btn-outline-danger delete-btn" title="Excluir"><i class="bi bi-trash"></i></button>
                                </div>
                                ${chart.thumbnail ? `<div class="saved-chart-preview-pane"><img src="${chart.thumbnail}" alt="Pr칠via de ${chart.name}"></div>` : ''}
                            `;
                            item.querySelector('.load-btn').addEventListener('click', () => this.loadSavedChart(chart.id));
                            item.querySelector('.delete-btn').addEventListener('click', () => this.deleteSavedChart(chart.id));
                            container.appendChild(item);
                        });
                    },
                    renderHomeGallery() {
                        this.renderGalleryHeader();
                        const allCharts = JSON.parse(localStorage.getItem('alladinSavedCharts') || '[]');
                        const allFolders = JSON.parse(localStorage.getItem('alladinFolders') || '[]');
                        const filterText = APP.state.currentFilter.toLowerCase();
                        
                        // Filter favorites (only in main view)
                        const favoriteCharts = APP.state.currentFolderId ? [] : allCharts.filter(c => c.isFavorite && c.name.toLowerCase().includes(filterText));
                        
                        // Filter folders and their contents
                        const filteredFolders = allFolders.filter(f => f.name.toLowerCase().includes(filterText));
                        
                        // Filter charts based on current view (folder or main) and search text
                        let displayedCharts;
                        if (APP.state.currentFolderId) {
                            displayedCharts = allCharts.filter(c => c.folderId === APP.state.currentFolderId && c.name.toLowerCase().includes(filterText));
                            const currentFolder = allFolders.find(f => f.id === APP.state.currentFolderId);
                            APP.dom.controls.chartsTitle.textContent = currentFolder ? `Gr치ficos em "${currentFolder.name}"` : 'Gr치ficos na Pasta';
                            APP.dom.controls.newChartInFolderBtn.style.display = 'inline-block';
                        } else {
                            displayedCharts = allCharts.filter(c => !c.folderId && c.name.toLowerCase().includes(filterText));
                            APP.dom.controls.chartsTitle.textContent = 'Gr치ficos Avulsos';
                             APP.dom.controls.newChartInFolderBtn.style.display = 'none';
                        }

                        // Render Favorites
                        APP.dom.favoritesContainer.style.display = favoriteCharts.length > 0 ? 'block' : 'none';
                        this.renderChartList(APP.dom.favoritesGalleryContainer, favoriteCharts);

                        // Render folders only in main view
                        if (!APP.state.currentFolderId) {
                            APP.dom.foldersContainer.style.display = 'block';
                            this.renderFolderList(APP.dom.folderGalleryContainer, filteredFolders, allCharts);
                        } else {
                            APP.dom.foldersContainer.style.display = 'none';
                        }
                        
                        // Render charts for the current view
                        this.renderChartList(APP.dom.chartGalleryContainer, displayedCharts);
                        
                        // Add event listeners after rendering
                        this.initDragAndDrop();
                        this.addCardEventListeners();
                    },
                    renderGalleryHeader() {
                         const header = APP.dom.galleryHeader;
                         const folderId = APP.state.currentFolderId;
                         const allFolders = JSON.parse(localStorage.getItem('alladinFolders') || '[]');
                         let currentFolder = null;
                         if (folderId) {
                             currentFolder = allFolders.find(f => f.id === folderId);
                         }

                         header.innerHTML = `
                             <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-4">
                                 <nav aria-label="breadcrumb">
                                     <ol class="breadcrumb mb-0 align-items-center">
                                         <li class="breadcrumb-item"><a href="#" id="breadcrumb-home">Galeria</a></li>
                                         ${currentFolder ? `<li class="breadcrumb-item active" aria-current="page" style="color: ${currentFolder.color || 'inherit'}; font-weight: 500;">${currentFolder.name}</li>` : ''}
                                     </ol>
                                 </nav>
                                 <div class="input-group" style="max-width: 400px;">
                                     <span class="input-group-text"><i class="bi bi-search"></i></span>
                                     <input type="search" id="gallery-search-input" class="form-control" placeholder="Buscar gr치ficos ou pastas..." value="${APP.state.currentFilter}">
                                 </div>
                             </div>
                         `;
                         header.querySelector('#breadcrumb-home').addEventListener('click', (e) => {
                             e.preventDefault();
                             this.navigateTo('home');
                         });
                         const searchInput = header.querySelector('#gallery-search-input');
                         searchInput.addEventListener('input', (e) => {
                             APP.state.currentFilter = e.target.value;
                             this.renderHomeGallery();
                         });
                    },
                    renderFolderList(container, folders, allCharts) {
                        container.innerHTML = '';
                        if (folders.length === 0) {
                             if(APP.state.currentFilter) container.innerHTML = '<p class="text-muted text-center">Nenhuma pasta encontrada.</p>';
                            return;
                        }
                        folders.forEach(folder => {
                            const folderCharts = allCharts.filter(c => c.folderId === folder.id);
                            const folderPreviews = folderCharts.slice(0, 4).map(chart =>
                                `<div class="folder-preview-item"><img src="${chart.thumbnail}" alt=""></div>`
                            ).join('');

                            const folderCard = document.createElement('div');
                            folderCard.className = 'col-12 mb-4';
                            const folderColor = folder.color || 'var(--bs-primary)';

                            folderCard.innerHTML = `
                                <div class="folder-card" data-folder-id="${folder.id}">
                                    <div class="folder-card-header d-flex justify-content-between align-items-center">
                                        <h4 class="mb-0 d-flex align-items-center" style="color: ${folderColor};"><i class="bi bi-folder2-open me-2"></i> ${folder.name} (${folderCharts.length})</h4>
                                        <button class="btn btn-sm btn-outline-secondary folder-options-btn" data-folder-id="${folder.id}"><i class="bi bi-three-dots-vertical"></i></button>
                                    </div>
                                    <div class="folder-preview-grid">
                                        ${folderCharts.length > 0 ? folderPreviews : '<p class="text-muted ms-3 small">Arraste um gr치fico aqui para adicion치-lo.</p>'}
                                    </div>
                                </div>
                            `;
                            container.appendChild(folderCard);

                            folderCard.querySelector('.folder-card-header').addEventListener('click', (e) => {
                                 if(!e.target.classList.contains('folder-options-btn') && !e.target.parentElement.classList.contains('folder-options-btn')) {
                                     this.navigateTo('home', folder.id);
                                 }
                            });
                        });
                    },
                    renderChartList(container, charts) {
                        container.innerHTML = '';
                         if (charts.length === 0) {
                             if(APP.state.currentFilter) container.innerHTML = '<div class="col-12"><p class="text-muted text-center">Nenhum gr치fico corresponde  sua busca.</p></div>';
                             else if(container.id === 'chart-gallery-container' && APP.dom.folderGalleryContainer.innerHTML === '') {
                                 container.innerHTML = '<div class="col-12"><p class="text-muted text-center fs-5 mt-5">Sua galeria est치 vazia. Clique em "Criar Gr치fico" para come칞ar!</p></div>';
                             }
                            return;
                        }
                        charts.forEach(chart => {
                            const cardCol = document.createElement('div');
                            cardCol.className = 'col';
                            cardCol.innerHTML = this.createChartCardHTML(chart);
                            container.appendChild(cardCol);
                        });
                    },
                    addCardEventListeners() {
                        document.querySelectorAll('.gallery-card-container').forEach(card => {
                            card.addEventListener('contextmenu', (e) => {
                                e.preventDefault();
                                this.showContextMenu(e.clientX, e.clientY, { id: parseInt(card.dataset.chartId) }, 'chart');
                            });
                        });
                        document.querySelectorAll('.load-btn-gallery').forEach(btn => btn.addEventListener('click', (e) => this.loadSavedChart(parseInt(e.currentTarget.dataset.chartId), true)));
                        document.querySelectorAll('.delete-btn-gallery').forEach(btn => btn.addEventListener('click', (e) => this.deleteSavedChart(parseInt(e.currentTarget.dataset.chartId))));
                        document.querySelectorAll('.folder-options-btn').forEach(btn => btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            this.showContextMenu(e.clientX, e.clientY, { id: parseInt(e.currentTarget.dataset.folderId) }, 'folder');
                        }));
                        document.querySelectorAll('.favorite-star').forEach(star => {
                            star.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                this.toggleFavorite(parseInt(e.currentTarget.dataset.chartId));
                            });
                        });
                    },
                    createChartCardHTML(chart) {
                        const thumbnailSrc = chart.thumbnail || 'https://placehold.co/600x400/eeeeee/cccccc?text=Sem+Pr%C3%A9via';
                        const iconHtml = `<div class="gallery-card-icon"><i class="${chart.icon || 'bi-bar-chart-line'}"></i></div>`;
                        const favoriteClass = chart.isFavorite ? 'is-favorite' : '';
                        return `
                            <div class="gallery-card-container" data-chart-id="${chart.id}" draggable="true">
                                <div class="card h-100 gallery-card shadow-sm">
                                    <span class="favorite-star ${favoriteClass}" data-chart-id="${chart.id}" title="Favoritar">
                                        <i class="bi bi-star"></i>
                                        <i class="bi bi-star-fill"></i>
                                    </span>
                                    <img src="${thumbnailSrc}" class="card-img-top gallery-card-img" alt="Pr칠via de ${chart.name}" draggable="false">
                                    <div class="card-body">
                                        ${iconHtml}
                                        <h5 class="card-title">${chart.name}</h5>
                                        <p class="card-text small text-muted">Salvo em: ${new Date(chart.id).toLocaleDateString()}</p>
                                        <button class="btn btn-primary load-btn-gallery" data-chart-id="${chart.id}"><i class="bi bi-pencil-square"></i> Editar</button>
                                        <button class="btn btn-outline-danger delete-btn-gallery float-end" data-chart-id="${chart.id}" title="Excluir"><i class="bi bi-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                        `;
                    },

                    loadSavedChart(chartId, navigateToCreator = false) {
                        const savedCharts = JSON.parse(localStorage.getItem('alladinSavedCharts') || '[]');
                        const chartToLoad = savedCharts.find(c => c.id === chartId);
                        if (!chartToLoad) {
                            this.showNotification('Gr치fico n칚o encontrado.', 'danger');
                            return;
                        }
                        APP.state.data = chartToLoad.data;
                        for (const key in chartToLoad.controls) {
                            if (APP.dom.controls[key] && chartToLoad.controls[key] !== undefined) {
                                APP.dom.controls[key].value = chartToLoad.controls[key];
                            }
                        }
                        this.rebuildUI();
                        this.toggleLineStyleControl();
                        this.showNotification(`Gr치fico "${chartToLoad.name}" carregado!`, 'success');

                        if (navigateToCreator) {
                            this.navigateTo('creator');
                        }
                    },
                    deleteSavedChart(chartId) {
                        this.showModal('Confirmar Exclus칚o', "Tem certeza que deseja excluir este gr치fico salvo?", (confirmed) => {
                            if (!confirmed) return;
                            let savedCharts = JSON.parse(localStorage.getItem('alladinSavedCharts') || '[]');
                            savedCharts = savedCharts.filter(c => c.id !== chartId);
                            localStorage.setItem('alladinSavedCharts', JSON.stringify(savedCharts));
                            this.renderSavedChartsList();
                            this.renderHomeGallery(); // Also update home gallery
                            this.showNotification('Gr치fico exclu칤do.', 'info');
                        }, {
                            confirmClass: 'btn-danger',
                            confirmText: 'Excluir'
                        });
                    },
                    resetToDefault() {
                        APP.state.themeChoiceModal.show();
                    },
                    performReset(theme) {
                        APP.state.themeChoiceModal.hide();
                        localStorage.removeItem('alladinAppState');
                        localStorage.removeItem('alladinSavedCharts');
                        localStorage.removeItem('alladinFolders');
                        this.generateRandomData(theme);
                        this.rebuildUI(false);
                        this.toggleLineStyleControl();
                        this.navigateTo('creator');
                        this.showNotification("Aplica칞칚o reiniciada para o padr칚o.", "info");
                    },
                    // --- FOLDER & DRAG-DROP METHODS ---
                    initDragAndDrop() {
                        const draggables = document.querySelectorAll('.gallery-card-container'); // All chart cards
                        const droppables = document.querySelectorAll('.folder-card');

                        draggables.forEach(draggable => {
                            draggable.addEventListener('dragstart', (e) => {
                                // Prevent dragging from within a folder view for simplicity
                                if(APP.state.currentFolderId) {
                                    e.preventDefault();
                                    return;
                                }
                                draggable.classList.add('dragging');
                                e.dataTransfer.setData('text/plain', draggable.dataset.chartId);
                            });

                            draggable.addEventListener('dragend', () => {
                                draggable.classList.remove('dragging');
                            });
                        });

                        droppables.forEach(droppable => {
                            droppable.addEventListener('dragover', e => {
                                e.preventDefault();
                                droppable.classList.add('drag-over');
                            });
                            droppable.addEventListener('dragleave', () => {
                                droppable.classList.remove('drag-over');
                            });
                            droppable.addEventListener('drop', e => {
                                e.preventDefault();
                                droppable.classList.remove('drag-over');
                                const chartId = parseInt(e.dataTransfer.getData('text/plain'));
                                const folderId = parseInt(droppable.dataset.folderId);
                                this.moveChartToFolder(chartId, folderId);
                            });
                        });
                    },
                    createFolder() {
                        this.showModal('Criar Nova Pasta', { type: 'input', label: 'Nome da Pasta:', placeholder: 'Ex: Relat칩rios Trimestrais' }, (name) => {
                            if (!name) return;
                            const folders = JSON.parse(localStorage.getItem('alladinFolders') || '[]');
                            const newFolder = {
                                id: Date.now(),
                                name: name,
                                color: '#6f42c1' // Default color
                            };
                            folders.push(newFolder);
                            localStorage.setItem('alladinFolders', JSON.stringify(folders));
                            this.showNotification(`Pasta "${name}" criada!`, 'success');
                            this.renderHomeGallery();
                        });
                    },
                    createNewChartInCurrentFolder() {
                        if (!APP.state.currentFolderId) {
                            this.showNotification("Nenhuma pasta selecionada.", "warning");
                            return;
                        }
                        // Reset to a blank chart but keep the currentFolderId
                        const currentFolderId = APP.state.currentFolderId;
                        this.performReset(APP.state.theme); // This will clear currentFolderId
                        APP.state.currentFolderId = currentFolderId; // Restore it
                        this.navigateTo('creator', currentFolderId);
                        this.showNotification("Criando um novo gr치fico na pasta atual.", "info");
                    },
                     renameFolder(folderId) {
                         const folders = JSON.parse(localStorage.getItem('alladinFolders') || '[]');
                         const folder = folders.find(f => f.id === folderId);
                         if (!folder) return;

                         this.showModal('Renomear Pasta', { type: 'input', value: folder.name }, (newName) => {
                             if (!newName || newName === folder.name) return;
                             folder.name = newName;
                             localStorage.setItem('alladinFolders', JSON.stringify(folders));
                             this.showNotification('Pasta renomeada.', 'success');
                             this.renderHomeGallery();
                         });
                    },
                     deleteFolder(folderId) {
                         this.showModal('Excluir Pasta', 'Tem certeza? Todos os gr치ficos nesta pasta ficar칚o sem categoria.', (confirmed) => {
                              if (!confirmed) return;
                              let folders = JSON.parse(localStorage.getItem('alladinFolders') || '[]');
                              let charts = JSON.parse(localStorage.getItem('alladinSavedCharts') || '[]');

                              charts.forEach(chart => {
                                   if(chart.folderId === folderId) {
                                       chart.folderId = null;
                                   }
                              });

                              folders = folders.filter(f => f.id !== folderId);

                              localStorage.setItem('alladinFolders', JSON.stringify(folders));
                              localStorage.setItem('alladinSavedCharts', JSON.stringify(charts));

                              this.showNotification('Pasta exclu칤da.', 'info');
                              this.renderHomeGallery();
                         }, { confirmClass: 'btn-danger', confirmText: 'Excluir' });
                    },
                    moveChartToFolder(chartId, folderId) { // folderId can be null to un-assign
                        let charts = JSON.parse(localStorage.getItem('alladinSavedCharts') || '[]');
                        const chartIndex = charts.findIndex(c => c.id === chartId);
                        if (chartIndex > -1) {
                            charts[chartIndex].folderId = folderId;
                            localStorage.setItem('alladinSavedCharts', JSON.stringify(charts));
                            this.showNotification(folderId ? 'Gr치fico movido!' : 'Gr치fico removido da pasta.', 'success');
                            this.renderHomeGallery();
                        }
                    },
                    duplicateChart(chartId) {
                        let charts = JSON.parse(localStorage.getItem('alladinSavedCharts') || '[]');
                        const originalChart = charts.find(c => c.id === chartId);
                        if (!originalChart) return;

                        const newChart = JSON.parse(JSON.stringify(originalChart)); // Deep copy
                        newChart.id = Date.now();
                        newChart.name = `C칩pia de ${originalChart.name}`;
                        newChart.isFavorite = false; // Duplicates aren't favorited by default

                        charts.push(newChart);
                        localStorage.setItem('alladinSavedCharts', JSON.stringify(charts));
                        this.showNotification('Gr치fico duplicado!', 'success');
                        this.renderHomeGallery();
                    },
                    toggleFavorite(chartId) {
                         let charts = JSON.parse(localStorage.getItem('alladinSavedCharts') || '[]');
                         const chartIndex = charts.findIndex(c => c.id === chartId);
                         if (chartIndex > -1) {
                             charts[chartIndex].isFavorite = !charts[chartIndex].isFavorite;
                             localStorage.setItem('alladinSavedCharts', JSON.stringify(charts));
                             this.renderHomeGallery();
                         }
                    },
                    setFolderColor(folderId, color) {
                        let folders = JSON.parse(localStorage.getItem('alladinFolders') || '[]');
                        const folderIndex = folders.findIndex(f => f.id === folderId);
                        if(folderIndex > -1) {
                            folders[folderIndex].color = color;
                            localStorage.setItem('alladinFolders', JSON.stringify(folders));
                            this.renderHomeGallery();
                        }
                    },
                    shareFolder(folderId){
                        const folders = JSON.parse(localStorage.getItem('alladinFolders') || '[]');
                        const charts = JSON.parse(localStorage.getItem('alladinSavedCharts') || '[]');

                        const folder = folders.find(f => f.id === folderId);
                        if(!folder) return;

                        const chartsInFolder = charts.filter(c => c.folderId === folderId);

                        const sharePayload = {
                            type: 'folderShare',
                            folder: {name: folder.name},
                            charts: chartsInFolder
                        };

                        const shareCode = btoa(JSON.stringify(sharePayload));
                        const shareUrl = `${window.location.href.split('?')[0]}?share=${shareCode}`;

                        navigator.clipboard.writeText(shareUrl).then(() => {
                            this.showNotification('Link de compartilhamento da pasta copiado!', 'success');
                        }).catch(() => {
                             this.showNotification('Erro ao copiar o link.', 'danger');
                        });
                    },
                    promptForFolderCode() {
                        this.showModal('Aplicar C칩digo da Pasta', {
                            type: 'input',
                            placeholder: 'Cole o link de compartilhamento da pasta aqui'
                        }, (shareUrl) => {
                            if (!shareUrl) return;
                            try {
                                const url = new URL(shareUrl);
                                const shareCode = url.searchParams.get('share');
                                if (shareCode) {
                                    this.importSharedFolder(shareCode);
                                } else {
                                    this.showNotification('URL inv치lida ou c칩digo n칚o encontrado.', 'danger');
                                }
                            } catch (error) {
                                // If it's not a full URL, maybe they just pasted the code itself
                                this.importSharedFolder(shareUrl);
                            }
                        });
                    },
                    importSharedFolder(shareCode) {
                        if(!shareCode) {
                            this.showNotification('C칩digo de compartilhamento inv치lido.', 'danger');
                            return;
                        }
                        try {
                            const decodedString = atob(shareCode);
                            const payload = JSON.parse(decodedString);

                            if(payload.type !== 'folderShare') {
                                this.showNotification('Este c칩digo n칚o 칠 para uma pasta.', 'warning');
                                return;
                            };

                            this.showModal(`Importar Pasta Compartilhada`, `Voc칡 recebeu a pasta "${payload.folder.name}" com ${payload.charts.length} gr치fico(s). Deseja adicion치-la  sua galeria?`, (confirmed) => {
                                 if(!confirmed) {
                                     const url = new URL(window.location);
                                     if (url.searchParams.has('share')) {
                                         url.searchParams.delete('share');
                                         window.history.replaceState({}, document.title, url.toString());
                                     }
                                    return;
                                 };

                                const folders = JSON.parse(localStorage.getItem('alladinFolders') || '[]');
                                const charts = JSON.parse(localStorage.getItem('alladinSavedCharts') || '[]');

                                const newFolder = {
                                    id: Date.now(),
                                    name: payload.folder.name,
                                };
                                folders.push(newFolder);

                                payload.charts.forEach(sharedChart => {
                                    const newChart = {...sharedChart, id: Date.now() + Math.random(), folderId: newFolder.id};
                                    charts.push(newChart);
                                });

                                localStorage.setItem('alladinFolders', JSON.stringify(folders));
                                localStorage.setItem('alladinSavedCharts', JSON.stringify(charts));

                                this.showNotification('Pasta importada com sucesso!', 'success');
                                this.renderHomeGallery();
                                
                                const url = new URL(window.location);
                                if (url.searchParams.has('share')) {
                                    url.searchParams.delete('share');
                                    window.history.replaceState({}, document.title, url.toString());
                                }
                            });

                        } catch(e) {
                            console.error("Error processing share link", e);
                            this.showNotification('Link de compartilhamento inv치lido ou corrompido.', 'danger');
                            const url = new URL(window.location);
                            if (url.searchParams.has('share')) {
                                url.searchParams.delete('share');
                                window.history.replaceState({}, document.title, url.toString());
                            }
                        }
                    },
                    checkForSharedFolder() {
                        const urlParams = new URLSearchParams(window.location.search);
                        const shareCode = urlParams.get('share');
                        if(!shareCode) return;
                        this.importSharedFolder(shareCode);
                    },

                    showModal(title, bodyContent, callback, options = {}) {
                        const { confirmText = 'Confirmar', cancelText = 'Cancelar', confirmClass = 'btn-primary', confirmAction = true, cancelAction = false } = options;
                        const M = APP.dom.modal;
                        M.title.textContent = title;
                        M.body.innerHTML = '';
                        let inputElement = null;
                        if (typeof bodyContent === 'string') {
                            M.body.textContent = bodyContent;
                        } else if (typeof bodyContent === 'object' && bodyContent.type === 'input') {
                            if (bodyContent.label) {
                                const label = document.createElement('label');
                                label.className = 'form-label';
                                label.textContent = bodyContent.label;
                                M.body.appendChild(label);
                            }
                            inputElement = document.createElement('input');
                            inputElement.className = 'form-control';
                            inputElement.type = bodyContent.inputType || 'text';
                            inputElement.value = bodyContent.value || '';
                            inputElement.placeholder = bodyContent.placeholder || '';
                            M.body.appendChild(inputElement);
                        }
                        M.confirmBtn.textContent = confirmText;
                        M.confirmBtn.className = `btn ${confirmClass}`;
                        M.el.querySelector('.modal-footer .btn-secondary').textContent = cancelText;
                        const handleConfirm = () => {
                            const value = inputElement ? inputElement.value : confirmAction;
                            callback(value);
                            APP.state.modal.hide();
                            cleanup();
                        };
                        const handleCancel = () => {
                            callback(cancelAction);
                            cleanup();
                        }
                        const cleanup = () => {
                            M.confirmBtn.removeEventListener('click', handleConfirm);
                            M.el.removeEventListener('hidden.bs.modal', handleCancel);
                        }
                        M.confirmBtn.addEventListener('click', handleConfirm);
                        M.el.addEventListener('hidden.bs.modal', handleCancel, { once: true });
                        APP.state.modal.show();
                        if (inputElement) {
                            setTimeout(() => inputElement.focus(), 500);
                        }
                    },
                    populateIconSelector() {
                        const icons = ['bi-graph-up', 'bi-bar-chart-line-fill', 'bi-pie-chart-fill', 'bi-graph-down-arrow', 'bi-currency-dollar', 'bi-people-fill', 'bi-building', 'bi-cart-fill', 'bi-heart-fill', 'bi-star-fill', 'bi-calendar-event', 'bi-cloud-fill', 'bi-gear-fill', 'bi-lightbulb-fill', 'bi-lock-fill', 'bi-map-fill', 'bi-music-note', 'bi-phone-fill', 'bi-shield-fill', 'bi-speedometer2', 'bi-tree-fill', 'bi-trophy-fill', 'bi-camera-fill', 'bi-book-fill', 'bi-briefcase-fill', 'bi-chat-dots-fill', 'bi-clipboard-data-fill', 'bi-code-slash', 'bi-controller', 'bi-cpu-fill', 'bi-database-fill', 'bi-display-fill', 'bi-envelope-fill', 'bi-flag-fill', 'bi-folder-fill', 'bi-fuel-pump-fill', 'bi-globe', 'bi-hammer', 'bi-house-door-fill', 'bi-key-fill', 'bi-layers-fill', 'bi-list-task', 'bi-mouse3-fill', 'bi-p-circle-fill', 'bi-person-badge-fill', 'bi-plugin', 'bi-printer-fill', 'bi-robot', 'bi-rocket-takeoff-fill', 'bi-server', 'bi-sim-fill', 'bi-truck', 'bi-wallet-fill', 'bi-wifi', 'bi-window-stack', 'bi-wrench-adjustable'];
                        const grid = APP.dom.iconModal.grid;
                        grid.innerHTML = '';
                        icons.forEach(iconClass => {
                            const iconWrapper = document.createElement('div');
                            iconWrapper.className = 'icon-option';
                            iconWrapper.dataset.icon = iconClass;
                            iconWrapper.innerHTML = `<i class="${iconClass}"></i>`;
                            iconWrapper.addEventListener('click', () => {
                                grid.querySelectorAll('.icon-option').forEach(el => el.classList.remove('selected'));
                                iconWrapper.classList.add('selected');
                            });
                            grid.appendChild(iconWrapper);
                        });
                    },
                    AI_ASSISTANT: {
                        history: [],
                        recognition: null,
                        init() {
                            const controls = APP.dom.controls;
                            controls.aiChatFab.addEventListener('click', () => APP.state.aiChatModal.show());
                            controls.openChatFromSidebar.addEventListener('click', () => APP.state.aiChatModal.show());
                            controls.aiChatSendBtn.addEventListener('click', () => this.handleUserInput());
                            controls.aiChatInput.addEventListener('keypress', (e) => {
                                if (e.key === 'Enter') {
                                    e.preventDefault();
                                    this.handleUserInput();
                                }
                            });

                            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                            if (SpeechRecognition) {
                                this.recognition = new SpeechRecognition();
                                this.recognition.continuous = false;
                                this.recognition.lang = 'pt-BR';
                                this.recognition.interimResults = false;
                                this.recognition.maxAlternatives = 1;

                                controls.voiceCommandBtn.addEventListener('click', () => {
                                    this.recognition.start();
                                    controls.voiceCommandBtn.classList.add('recording');
                                    controls.voiceCommandBtn.disabled = true;
                                });

                                this.recognition.onresult = (event) => {
                                    const transcript = event.results[0][0].transcript;
                                    controls.aiChatInput.value = transcript;
                                    this.handleUserInput();
                                };

                                this.recognition.onspeechend = () => this.recognition.stop();

                                this.recognition.onend = () => {
                                    controls.voiceCommandBtn.classList.remove('recording');
                                    controls.voiceCommandBtn.disabled = false;
                                };

                                this.recognition.onerror = (event) => {
                                    console.error("Speech recognition error", event.error);
                                    APP.methods.showNotification('Erro no reconhecimento de voz.', 'danger');
                                };
                            } else {
                                controls.voiceCommandBtn.style.display = 'none';
                            }
                        },
                        addMessage(text, sender, isToolMessage = false) {
                            const messageContainer = APP.dom.controls.aiChatMessages;
                            const messageDiv = document.createElement('div');
                            const messageClass = isToolMessage ? 'tool' : sender;
                            messageDiv.className = `chat-message ${messageClass}`;

                            if (isToolMessage) {
                                messageDiv.innerHTML = `游냤 Executando a칞칚o: <strong>${text}</strong>...`;
                            } else {
                                messageDiv.innerHTML = sender === 'ai' ? marked.parse(text) : text;
                            }

                            messageContainer.appendChild(messageDiv);
                            messageContainer.scrollTop = messageContainer.scrollHeight;
                        },
                        showTyping(show) {
                            APP.dom.controls.aiTypingIndicator.style.display = show ? 'block' : 'none';
                            if (show) APP.dom.controls.aiChatMessages.scrollTop = APP.dom.controls.aiChatMessages.scrollHeight;
                        },
                        async handleUserInput() {
                            const input = APP.dom.controls.aiChatInput;
                            const userMessage = input.value.trim();
                            if (!userMessage) return;
                            this.addMessage(userMessage, 'user');
                            input.value = '';
                            this.showTyping(true);
                            setTimeout(() => this.mockBackendResponse(userMessage), 1000);
                        },
                        mockBackendResponse(prompt) {
                            this.showTyping(false);
                            const lowerPrompt = prompt.toLowerCase();

                            const dataRegex = /no ano (\d{4}) o valor (?:칠|e) ([\d\.]+)/g;
                            let matches;
                            let dataPoints = [];
                            while ((matches = dataRegex.exec(lowerPrompt)) !== null) {
                                dataPoints.push({ label: matches[1], value: parseFloat(matches[2]) });
                            }

                            if (dataPoints.length > 0) {
                                this.handleToolCall({ name: 'updateMultipleDataPoints', args: { points: dataPoints } });
                                this.addMessage(`Ok! Atualizei ${dataPoints.length} ponto(s) de dados para voc칡.`, 'ai');
                                return;
                            }

                            if (lowerPrompt.includes('azul')) {
                                this.handleToolCall({ name: 'changeChartColor', args: { color: '#0d6efd' } });
                                this.addMessage("Claro, aqui est치 o gr치fico em azul!", 'ai');
                            } else if (lowerPrompt.includes('barras')) {
                                this.handleToolCall({ name: 'changeChartType', args: { type: 'bar' } });
                                this.addMessage("Transformei em um gr치fico de barras.", 'ai');
                            } else if (lowerPrompt.includes('aleat칩rio')) {
                                this.handleToolCall({ name: 'generateRandomChart' });
                                this.addMessage("Criei um novo gr치fico com dados aleat칩rios para voc칡 come칞ar!", 'ai');
                            } else {
                                this.addMessage("Desculpe, n칚o entendi o comando. Tente algo como 'crie um gr치fico de barras azul' ou 'no ano 2020 o valor 칠 300'.", 'ai');
                            }
                        },
                        handleToolCall(toolCall) {
                            const { name, args } = toolCall;
                            this.addMessage(name, 'ai', true);
                            switch (name) {
                                case 'generateRandomChart':
                                    APP.methods.generateRandomData(APP.state.theme);
                                    APP.methods.rebuildUI();
                                    break;
                                case 'changeChartColor':
                                    if (args.color) {
                                        APP.dom.controls.lineColor.value = args.color;
                                        APP.methods.updateSettings();
                                    }
                                    break;
                                case 'changeChartType':
                                    if (args.type) {
                                        APP.dom.controls.chartType.value = args.type;
                                        APP.methods.updateSettings();
                                    }
                                    break;
                                case 'updateMultipleDataPoints':
                                    if (args.points && args.points.length > 0) {
                                        args.points.forEach(point => {
                                            const index = APP.state.data.labels.indexOf(point.label);
                                            if (index !== -1) {
                                                APP.state.data.values[index] = point.value;
                                            } else {
                                                APP.state.data.labels.push(point.label);
                                                APP.state.data.values.push(point.value);
                                            }
                                        });
                                        const isAllYears = APP.state.data.labels.every(l => !isNaN(parseInt(l)));
                                        if (isAllYears) {
                                            const combined = APP.state.data.labels.map((l, i) => ({ label: l, value: APP.state.data.values[i] }));
                                            combined.sort((a, b) => parseInt(a.label) - parseInt(b.label));
                                            APP.state.data.labels = combined.map(d => d.label);
                                            APP.state.data.values = combined.map(d => d.value);
                                        }
                                        APP.methods.rebuildUI();
                                    }
                                    break;
                                case 'setChartData':
                                    if (args.labels && args.values && args.labels.length === args.values.length) {
                                        APP.state.data.labels = args.labels.map(String);
                                        APP.state.data.values = args.values.map(Number);
                                        APP.methods.rebuildUI();
                                    }
                                    break;
                            }
                        }
                    }
                }
            };
            APP.methods.init();
        });
    </script>
</body>

</html>
